<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>F1 Portfolio Dashboard - Professional Trading Analytics</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- Google Font Import -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500&amp;display=swap" rel="stylesheet"/>
<!-- Libraries for the celebration effect -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.3/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.1/tinycolor.min.js"></script>
<style>

#debrief .llm-output{
  white-space: pre-wrap;
  line-height: 1.5;
  font-size: 20px; /* adjust as desired */
}

  :root{
    --bg: #0b0e12;
    --gauge-size: 280px;
    --rim: #1f232b;
    --rim-highlight: #3a414f;
    --face: #0f141b;
    --glass: rgba(255,255,255,.08);
    --tick: #7f8a9f;
    --tick-strong: #c7d0df;
    --needle: #ffffff;
    --needle-hub: #f3f5f9;
    --accent: #2ce58c;
    --accent2: #ffb200;
    --accent3: #ff3b3b;
    --shadow: rgba(0,0,0,.35);
    --f1-red: #dc143c;
    --f1-silver: #c0c0c0;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  html,body{
    height:100%;
    background: radial-gradient(1200px 800px at 20% 10%, #11161d, #0a0d11 60%, #080a0d 100%);
    color:#e5ecf4;
    font-family: 'Orbitron', sans-serif;
    overflow-x: hidden;
  }

  .dashboard-header {
    background: linear-gradient(135deg, rgba(220,20,60,0.1), rgba(192,192,192,0.05));
    border-bottom: 2px solid var(--f1-red);
    padding: 20px 0;
    margin-bottom: 30px;
  }

  .header-content {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

  .logo-section {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .nav-buttons {
    display: flex;
    gap: 12px;
    margin-right: 20px;
  }

  .nav-btn {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.2);
    color: #e5ecf4;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .nav-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, rgba(220,20,60,0.3), rgba(220,20,60,0.1));
    border-color: var(--f1-red);
    transform: translateY(-1px);
  }

  .nav-btn.active {
    background: linear-gradient(135deg, var(--f1-red), #b8112a);
    border-color: var(--f1-red);
    color: #fff;
    box-shadow: 0 4px 12px rgba(220,20,60,0.3);
  }

  .nav-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .upload-btn {
    background: linear-gradient(135deg, rgba(77,163,255,0.2), rgba(77,163,255,0.1));
    border: 1px solid #4da3ff;
    color: #e5ecf4;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  .upload-btn:hover {
    background: linear-gradient(135deg, rgba(77,163,255,0.4), rgba(77,163,255,0.2));
  }

  .upload-btn input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .f1-logo {
    width: 80px;
    height: 40px;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
  }

  .header-center {
  text-align: center;
}
@media (max-width: 768px) {
  .header-center { width: 100%; margin: 10px 0 0; }
}

  .header-title {
    font-size: 32px;
    font-weight: 500;
    color: #fff;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
  
  white-space: nowrap;
}

  .header-subtitle {
    font-size: 16px;
    color: var(--f1-silver);
    font-weight: 500;
    letter-spacing: 1px;
  }

  .f1-car {
    width: 120px;
    height: 40px;
    object-fit: contain;
  }

  .live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(44,229,140,0.1);
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--accent);
  }

  .live-dot {
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .main-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 8px 20px var(--shadow);
  }

  .stat-value {
    font-size: 32px;
    font-weight: 500;
    margin-bottom: 5px;
  }

  .stat-label {
    font-size: 12px;
    color: #aeb7c5;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .telemetry-card {
    background: linear-gradient(180deg, rgba(255, 178, 0, 0.1), rgba(255, 178, 0, 0.02));
    border: 1px solid rgba(255, 178, 0, 0.2);
    color: #ffb200;
  }
  #telemetry-alert-content {
    transition: opacity 0.5s ease-in-out;
  }
  #telemetry-alert-content.fade-out {
    opacity: 0;
  }
  .telemetry-title {
    font-size: 20px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #fff;
  }
  .telemetry-message {
    font-size: 18px;
    line-height: 1.4;
    color: #aeb7c5;
    text-transform: none;
    letter-spacing: 0;
    margin-top: 10px;
    height: 54px; /* Fixed height to prevent layout shifts */
  }
  
  .wave-container {
    width: 100%;
    height: 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 auto 15px;
  }

  .wave-bar {
    width: 2px;
    height: 100%;
    background: var(--accent2);
    border-radius: 2px;
    animation: wave-animation 1.5s infinite ease-in-out;
  }

  @keyframes wave-animation {
    0%, 100% { transform: scaleY(0.1); }
    50% { transform: scaleY(1.0); }
  }

  .wave-bar:nth-child(2) { animation-delay: 0.1s; }
  .wave-bar:nth-child(3) { animation-delay: 0.2s; }
  .wave-bar:nth-child(4) { animation-delay: 0.3s; }
  .wave-bar:nth-child(5) { animation-delay: 0.4s; }
  .wave-bar:nth-child(6) { animation-delay: 0.5s; }
  .wave-bar:nth-child(7) { animation-delay: 0.6s; }
  .wave-bar:nth-child(8) { animation-delay: 0.7s; }
  .wave-bar:nth-child(9) { animation-delay: 0.8s; }
  .wave-bar:nth-child(10) { animation-delay: 0.9s; }
  .wave-bar:nth-child(11) { animation-delay: 1.0s; }
  .wave-bar:nth-child(12) { animation-delay: 1.1s; }
  .wave-bar:nth-child(13) { animation-delay: 1.2s; }
  .wave-bar:nth-child(14) { animation-delay: 1.3s; }
  .wave-bar:nth-child(15) { animation-delay: 1.4s; }
  .wave-bar:nth-child(16) { animation-delay: 0s; }
  .wave-bar:nth-child(17) { animation-delay: 0.1s; }
  .wave-bar:nth-child(18) { animation-delay: 0.2s; }
  .wave-bar:nth-child(19) { animation-delay: 0.3s; }
  .wave-bar:nth-child(20) { animation-delay: 0.4s; }
  .wave-bar:nth-child(21) { animation-delay: 0.5s; }
  .wave-bar:nth-child(22) { animation-delay: 0.6s; }
  .wave-bar:nth-child(23) { animation-delay: 0.7s; }
  .wave-bar:nth-child(24) { animation-delay: 0.8s; }
  .wave-bar:nth-child(25) { animation-delay: 0.9s; }
  .wave-bar:nth-child(26) { animation-delay: 1.0s; }
  .wave-bar:nth-child(27) { animation-delay: 1.1s; }
  .wave-bar:nth-child(28) { animation-delay: 1.2s; }
  .wave-bar:nth-child(29) { animation-delay: 1.3s; }
  .wave-bar:nth-child(30) { animation-delay: 1.4s; }
  .wave-bar:nth-child(31) { animation-delay: 0s; }
  .wave-bar:nth-child(32) { animation-delay: 0.1s; }
  .wave-bar:nth-child(33) { animation-delay: 0.2s; }
  .wave-bar:nth-child(34) { animation-delay: 0.3s; }
  .wave-bar:nth-child(35) { animation-delay: 0.4s; }
  .wave-bar:nth-child(36) { animation-delay: 0.5s; }
  .wave-bar:nth-child(37) { animation-delay: 0.6s; }
  .wave-bar:nth-child(38) { animation-delay: 0.7s; }
  .wave-bar:nth-child(39) { animation-delay: 0.8s; }
  .wave-bar:nth-child(40) { animation-delay: 0.9s; }

  .stat-change {
    font-size: 14px;
    margin-top: 8px;
    font-weight: 500;
  }

  .stat-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 15px;
  }

  .waving-flag {
    animation: wave 2s ease-in-out infinite;
  }

  @keyframes wave {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    75% { transform: rotate(-5deg); }
  }

  .positive { color: var(--accent); }
  .negative { color: var(--accent3); }

  .gauges-section {
    margin-bottom: 40px;
  }

  .section-title {
    font-size: 24px;
    font-weight: 500;
    margin-bottom: 25px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--f1-red);
    border-radius: 2px;
  }

  .section-title .upload-btn {
    padding: 8px 16px;
    font-size: 12px;
  }

  .title-icon {
    height: 72px;
    width: auto;
  }

  .gauges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
  }

  .gauge-panel {
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 16px;
    box-shadow: 0 10px 24px var(--shadow), inset 0 1px 0 rgba(255,255,255,.04);
    padding: 25px 20px 30px;
    text-align: center;
  }

  .gauge-panel h3 {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: .8px;
    text-transform: uppercase;
    color: #aeb7c5;
    margin-bottom: 15px;
  }

  .gauge {
    width: var(--gauge-size);
    height: var(--gauge-size);
    margin: 0 auto 15px;
    position: relative;
  }

  .gauge-value {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    font-weight: 500;
    color: #fff;
  }

  .gauge-label {
    font-size: 13px;
    color: #aeb7c5;
    letter-spacing: .3px;
  }

  .glow-outer { 
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.45)) drop-shadow(0 0 14px rgba(44,229,140,.1)); 
  }

  .glass {
    position: absolute; 
    inset: 0;
    border-radius: 50%;
    background: radial-gradient(100% 100% at 50% 35%, rgba(255,255,255,.10), rgba(255,255,255,0) 50%),
                linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    pointer-events: none;
    mix-blend-mode: screen;
  }

  .performance-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }

  .chart-panel {
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 10px 24px var(--shadow);
  }

  .chart-placeholder {
    height: 300px;
    background: linear-gradient(45deg, rgba(220,20,60,0.1), rgba(44,229,140,0.1));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #aeb7c5;
    font-size: 18px;
    border: 2px dashed rgba(255,255,255,0.1);
  }

  .holdings-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .holding-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .holding-symbol {
    font-weight: 600;
    color: #fff;
  }

  .holding-name {
    font-size: 12px;
    color: #aeb7c5;
  }

  .holding-value {
    text-align: right;
  }

  .footer-info {
    margin-top: 40px;
    padding: 20px 0;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 12px;
    color: #8f9bb0;
    text-align: center;
  }

  /* Podium Page Styles */
  .page-content {
    min-height: calc(100vh - 120px);
  }

  .podium-tabs {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 40px;
  }

  .podium-tab {
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.2);
    color: #e5ecf4;
    padding: 12px 30px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .podium-tab:hover {
    background: linear-gradient(135deg, rgba(77,163,255,0.3), rgba(77,163,255,0.1));
    border-color: #4da3ff;
    transform: translateY(-2px);
  }

  .podium-tab.active {
    background: linear-gradient(135deg, #4da3ff, #3d8bff);
    border-color: #4da3ff;
    color: #fff;
    box-shadow: 0 6px 20px rgba(77,163,255,0.3);
  }

  .podium-container {
    margin-bottom: 60px;
  }

  .podium-title {
    text-align: center;
    margin-bottom: 50px;
  }

  .podium-title h1 {
    font-size: 48px;
    font-weight: 500;
    color: #fff;
    margin-bottom: 10px;
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }

  .podium-title p {
    font-size: 18px;
    color: #aeb7c5;
    font-weight: 500;
  }

  .podium-stage {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 40px;
    margin: 0 auto;
    max-width: 900px;
    perspective: 1000px;
  }

  .podium-position {
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: podiumRise 1s ease-out forwards;
    opacity: 0;
    transform: translateY(50px);
  }

  .podium-position.gold { animation-delay: 0.2s; }
  .podium-position.silver { animation-delay: 0.4s; }
  .podium-position.bronze { animation-delay: 0.6s; }

  @keyframes podiumRise {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .position-content {
    text-align: center;
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border-radius: 16px;
    border: 2px solid transparent; /* Base border */
    backdrop-filter: blur(10px);
    min-width: 220px;
    transition: all 0.3s ease;
  }
  
  .podium-position.gold .position-content {
    border-color: #D4AF37;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    padding: 50px 20px;
  }
  .podium-position.silver .position-content {
    border-color: #C0C0C0;
    box-shadow: 0 0 15px rgba(192, 192, 192, 0.4);
    padding: 35px 20px;
  }
  .podium-position.bronze .position-content {
    border-color: #CD7F32;
    box-shadow: 0 0 15px rgba(205, 127, 50, 0.4);
  }

  .position-content:hover {
    transform: translateY(-5px) scale(1.02);
  }
  .podium-position.gold .position-content:hover {
    box-shadow: 0 0 25px rgba(212, 175, 55, 0.7);
  }
  .podium-position.silver .position-content:hover {
    box-shadow: 0 0 25px rgba(192, 192, 192, 0.7);
  }
  .podium-position.bronze .position-content:hover {
    box-shadow: 0 0 25px rgba(205, 127, 50, 0.7);
  }

  .car-name {
    font-size: 20px;
    font-weight: 500;
    color: #fff;
    margin-bottom: 8px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .driver-name {
    font-size: 16px;
    color: #aeb7c5;
    margin-bottom: 15px;
    font-weight: 500;
  }

  .points-badge {
    font-size: 36px;
    font-weight: 500;
    color: #fff;
    margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }

  .achievements {
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  .achievement-badge {
  font-family:"Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",system-ui,sans-serif !important;
  text-transform:none !important;
    background: rgba(255,255,255,0.1);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
  }

  .plinth {
    width: 220px;
    border-radius: 12px 12px 0 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-bottom: 20px;
    position: relative;
  }

  .gold-plinth {
    height: 320px;
    position: relative;
    top: 75px;
  }

  .silver-plinth {
    height: 250px;
    position: relative;
    top: 65px;
  }

  .bronze-plinth {
    width: 230px;
    height: 250px;
    position: relative;
    top: 70px;
  }

  .position-number {
    font-size: 48px;
    font-weight: 500;
    color: #fff;
    text-shadow: 0 4px 8px rgba(0,0,0,0.5);
  }

  /* Standings Table */
  .standings-section {
    margin-top: 60px;
    padding-top: 40px;
    border-top: 2px solid rgba(77,163,255,0.3);
  }

  .standings-table {
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .table-header {
    display: grid;
    grid-template-columns: 0.5fr 2fr 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr;
    background: linear-gradient(135deg, rgba(77,163,255,0.2), rgba(77,163,255,0.1));
    padding: 20px;
    font-weight: 500;
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 14px;
  }

  .table-row {
    display: grid;
    grid-template-columns: 0.5fr 2fr 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
    font-weight: 400;
  }

  .table-row:hover {
    background: rgba(255,255,255,0.05);
  }

  .gold-row {
    background: linear-gradient(90deg, rgba(212,175,55,0.1), transparent);
    border-left: 4px solid #D4AF37;
  }

  .silver-row {
    background: linear-gradient(90deg, rgba(192,192,192,0.1), transparent);
    border-left: 4px solid #C0C0C0;
  }

  .bronze-row {
    background: linear-gradient(90deg, rgba(205,127,50,0.1), transparent);
    border-left: 4px solid #CD7F32;
  }

  .pos-col {
    font-weight: 500;
    color: #fff;
  }

  .driver-col {
    font-weight: 500;
    color: #fff;
  }

  .team-col {
    color: #aeb7c5;
  }

  .car-col {
    color: #c7d0df;
  }

  .points-col {
    font-weight: 500;
    color: var(--accent); /* Green */
  }

  .wins-col {
    color: var(--accent2); /* Yellow */
    font-weight: 500;
    text-align: center;
  }
  
  .fastest-col {
    color: #4da3ff; /* Blue */
    font-weight: 500;
    text-align: center;
  }
  
  .podium-col {
    color: #ff8c00; /* Orange */
    font-weight: 500;
    text-align: center;
  }

  .sharpe-col {
    color: #a162f7; /* Purple */
    font-weight: 500;
    text-align: center;
  }
  
  .mdd-col {
    color: var(--accent3); /* Red */
    font-weight: 500;
    text-align: center;
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }
    
    .performance-grid {
      grid-template-columns: 1fr;
    }
    
    .gauges-grid {
      grid-template-columns: 1fr;
    }
    
    --gauge-size: 240px;

    .podium-stage {
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    .podium-position {
      width: 100%;
      max-width: 300px;
    }

    .table-header, .table-row {
      grid-template-columns: 0.5fr 1.5fr 1.2fr 1fr 1fr 1fr 1fr 1fr 1fr;
      font-size: 11px;
      padding: 12px 8px;
    }

    .podium-title h1 {
      font-size: 32px;
    }
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .header-car {
    width: 160px;
    height: 40px;
    object-fit: contain;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.35));
  }
  @media (max-width: 768px) {
    .header-car { width: 100px; height: 28px; }
  }

  .trophy-icon {
    display: block;
    margin: 0 auto;
    object-fit: contain;
  }

  .gold-plinth {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .trophy-icon {
    max-height: 80%;
    max-width: 90%;
  }

  /* Style for the celebration canvas */
  #celebration-canvas {
      position: fixed; /* Use fixed to cover the entire viewport */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999; /* Ensure it's on top of everything */
      pointer-events: none; /* Allow clicks to pass through to the dashboard */
  }

  .top-section {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    align-items: stretch;
    margin-bottom: 40px;
  }

  .top-section .video-container {
    flex: 2 1 500px; /* Give video more space */
    margin-bottom: 0;
  }
  
  .top-section .gauge-panel,
  .top-section .telemetry-card {
    flex: 1 1 300px; /* Allow track map and telemetry to take space */
    display: flex;
    flex-direction: column;
  }

  .top-section .gauge-panel {
    padding: 15px 20px;
  }

  .top-section .telemetry-card {
    justify-content: center; /* Vertically center telemetry content */
  }

  .top-section .gauge-panel .gauge {
    flex-grow: 1; /* Make the gauge SVG fill available space */
    height: auto;
  }

  .video-container {
    margin-bottom: 40px;
    max-width: 560px;
  }

  .video-wrapper {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 */
    height: 0;
    overflow: hidden;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.08);
  }

  .video-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

/* --- overlap fix for last mini chart --- */
.live-widgets{ margin-bottom:24px; }
.live-card{ overflow:hidden; }
.live-table{ position:relative; z-index:2; margin-top:8px; }

/* Ticker */
  color: #cfe3ff;
}
.live-table th:nth-child(2), .live-table td:nth-child(2) { /* Qty */
  color: #8ab4ff;
}
.live-table th:nth-child(3), .live-table td:nth-child(3) { /* Avg Cost */
  color: #ffcf66;
}
.live-table th:nth-child(4), .live-table td:nth-child(4) { /* Last */
  color: #7ee0ff;
}
/* For P/L $ and P/L %, keep dynamic green/red via .live-pl-pos / .live-pl-neg */

/* Icon on 'F1 Grand Prix Circuit' header */
.section-title .circuit-icon{
  height: 48px;
  width: auto;
  margin-right: 12px;
  vertical-align: middle;
  border-radius: 4px;
  opacity: .95;
}


body { padding-bottom: 48px; }</style>
<style>
.f1-modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
 display:flex; justify-content:center; align-items:center;}
.f1-modal-box {
  background: #1c1c1c;
  color: #e0e0e0;
  padding: 24px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 0 20px rgba(0,0,0,0.8);
  font-family: Arial, sans-serif;
 margin:auto;}
.f1-modal-box h3 {
  margin-top: 0;
  font-size: 18px;
  color: #f1f1f1;
}
.f1-modal-box input {
  width: 100%;
  padding: 10px;
  margin: 12px 0;
  border: none;
  border-radius: 6px;
  background: #2b2b2b;
  color: #f1f1f1;
}
.f1-modal-box .btn-row {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.f1-modal-box button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.f1-modal-box .cancel {
  background: #444;
  color: #ddd;
}
.f1-modal-box .continue {
  background: #e10600;
  color: #fff;
}
.f1-modal-box .cancel:hover { background: #666; }
.f1-modal-box .continue:hover { background: #ff2a1a; }
</style>
<style>
#debrief::before {
  display: none !important;
  content: none !important;
}
/* New style to change the debrief report font */
#debrief div {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 14px;
}
</style>
<style>
/* Disable red accent bars in Debrief Room only */
#room .section-title::before,
#room h1::before,
#room h2::before,
#room h3::before,
#room p::before,
#room div::before {
  display: none !important;
  content: none !important;
}
</style>
<script>
// --- Debrief config ---
// You can override this at runtime before runLLMAnalysis is called:
window.DEBRIEF_API_URL = window.DEBRIEF_API_URL || '/api/llm-analysis'; // e.g. 'http://localhost:3000/api/llm-analysis'
</script>
<style>
/* Hide header telemetry card UI but keep logic active */

</style>
<style>
.live-section{margin:24px 0}
.live-controls{display:flex;gap:10px;align-items:center;margin:10px 0 15px;flex-wrap:wrap}
.live-controls input[type="text"]{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 10px;color:inherit;min-width:260px}
.live-controls button{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 12px;cursor:pointer;color:inherit}
.live-status{opacity:.85;font-size:13px}
.live-summary{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 12px}
.kpi{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:12px 14px;min-width:180px}
.live-widgets{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin:10px 0 16px}
.live-card{height:160px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:4px;overflow:hidden}
.live-card .tradingview-widget-container__widget{height:100%!important}
.live-table-wrap{overflow-x:auto}
.live-table{width:100%;border-collapse:collapse;font-size:14px}
.live-table th,.live-table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);text-align:right}
.live-table th:first-child,.live-table td:first-child{text-align:left}
.live-pl-pos{color:#1aa65b}.live-pl-neg{color:#cc2e2e}.live-empty{opacity:.7;font-style:italic;padding:8px 0}
</style>
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
/** === Debrief + Tiles Shim (accepts FULL schema JSON) === */
function coerceToDebriefSummary(m){
  const perf = m.performance ?? {
    totalReturn: m.ROI ?? null,
    CAGR: m.CAGR ?? null,
    maxDD: m.MaxDrawdown ?? null,
    Sharpe: m.Sharpe ?? null,
    Sortino: null, volatility: null, calmar: null, recoveryDays: null,
    startDate: null, endDate: null, days: m.Days ?? null,
  };
  const trip = m.tripStats ?? {
    n: m.TripCount ?? null,
    wins: m.Wins ?? null,
    losses: m.Losses ?? null,
    winRate: (m.WinRate ?? null),
    profitFactor: (m.ProfitFactor ?? null),
    avgWin: m.avgWin ?? null,
    avgLoss: m.avgLoss ?? null,
    payoff: m.payoff ?? null,
    expectancy: m.expectancy ?? null,
    medianHold: m.medianHold ?? null,
    maxConsecWins: m.maxConsecWins ?? null,
    maxConsecLosses: m.maxConsecLosses ?? null
  };
  return {
    meta: m.meta ?? { file: "", basis: "" },
    counts: m.counts ?? { openTrips: m.OpenPositions ?? 0, closedTrips: m.TripCount ?? 0 },
    totals: m.totals ?? { sumPos: m.SumPos ?? 0, sumAbsNeg: m.SumAbsNeg ?? 0, netPnl: null },
    performance: perf,
    tripStats: trip,
    strategyStats: m.strategyStats ?? [],
    pnlByUnderlying: m.pnlByUnderlying ?? {},
    topUnderlying: m.topUnderlying ?? [],
    timing: m.timing ?? { byEntryDOW: [], byMonth: [], byHoldBucket: [] },
    fees: m.fees ?? {},
    marketContext: m.marketContext ?? {},
    equityCurvePreview: m.equityCurvePreview ?? { head: [], tail: [] }
  };
}

function tilesFromSummary(m){
  return {
    WinRate:       m.WinRate       ?? m.tripStats?.winRate       ?? 0,
    ProfitFactor:  m.ProfitFactor  ?? m.tripStats?.profitFactor  ?? 0,
    OpenTrades:    m.OpenPositions ?? m.counts?.openTrips        ?? m.counts?.open ?? 0,
    MaxDrawdown:   m.MaxDrawdown   ?? m.performance?.maxDD       ?? 0,
    CAGR:          m.CAGR          ?? m.performance?.cagr        ?? m.performance?.CAGR ?? 0,
    Sharpe:        m.performance?.Sharpe ?? m.Sharpe ?? m.performance?.sharpe_event ?? 0,
    ROI:           m.ROI           ?? m.performance?.totalReturn ?? 0
  };
}

function applyMetricsAndSummary(m){
  try{
    // 1) Update tiles/gauges
    const t = tilesFromSummary(m);
    if (typeof updateDashboardMetrics === 'function') {
      updateDashboardMetrics(t);
    } else {
      const pct = x => (x==null ? 'â€”' : (x*100).toFixed(1) + '%');
      const n2  = x => (x==null ? 'â€”' : Number(x).toFixed(2));
      const n0  = x => (x==null ? 'â€”' : String(x));
      (document.getElementById('win-rate-value')||{}).textContent = pct(t.WinRate);
      (document.getElementById('drs-value')||{}).textContent = n2(t.ProfitFactor);
      (document.getElementById('pole-positions-value')||{}).textContent = n0(t.OpenTrades);
      (document.getElementById('breakdown-value')||{}).textContent = pct(t.MaxDrawdown);
      (document.getElementById('cagr-gauge-value')||{}).textContent = pct(t.CAGR);
      (document.getElementById('sharpe-gauge-value')||{}).textContent = n2(t.Sharpe);
      (document.getElementById('roi-gauge-value')||{}).textContent = pct(t.ROI);
    }
    // 2) Debrief payload
    window.DEBRIEF_SUMMARY = coerceToDebriefSummary(m);
    // 3) Status
    const statusEl = document.getElementById('debriefStatus') || document.getElementById('debrief-status');
    if (statusEl){ statusEl.style.display='block'; statusEl.textContent = 'Debrief ready.'; }
    console.log('[F1] Debrief summary set from JSON.');
  }catch(e){
    console.error('[F1] applyMetricsAndSummary error:', e);
    alert('Failed to apply metrics from JSON: ' + e.message);
  }
}
</script>
<style>

/* --- F1 Table Only width tuning --- */
#f1TableOnly{
  width: min(1100px, 92vw);
  margin: 26px auto 36px !important; /* center horizontally */
  padding: 0 12px;
  box-sizing: border-box;
}
#f1TableOnly .wrap{
  width: 100%;
  overflow-x: auto;
}

</style>
<style>
/* Hide vertical scrollbar but keep scrolling */
html, body {
  -ms-overflow-style: none;  /* IE 10+ */
  scrollbar-width: none;     /* Firefox */
  overflow-y: auto;          /* Ensure scrolling still works */
}
html::-webkit-scrollbar,
body::-webkit-scrollbar {
  width: 0 !important;
  height: 0 !important;
  display: none;             /* Safari and Chrome */
}
</style>
<style id="fixed-header-patch">
/* --- Fixed header patch (non-destructive) --- */
.dashboard-header {
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  z-index: 2000;
  /* Keep existing background/border styles from the file */
}
/* Ensure the header content keeps its centered layout and full-bleed background */
.dashboard-header .header-content { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
/* When fixed headers are used, make sure any dropdowns/menus render above content */
header, .dashboard-header, .header-content { transform: translateZ(0); will-change: transform; }
</style>


<style id="fixed-header-image-visibility">
/* Keep header images visible above content after making header fixed */
.dashboard-header{ z-index:3000 !important; overflow:visible !important; }
#F1_logo, .F1_logo, .f1-logo,
#F1_Car_mini, .F1_Car_mini{
  position: relative !important;
  z-index: 3100 !important;
  display: inline-block !important;
  height: auto;
  max-height: 56px; /* respect existing layout; adjust if needed */
  object-fit: contain;
  vertical-align: middle;
}
/* Guard against accidental opacity or filters applied elsewhere */
#F1_logo img, .F1_logo img, .f1-logo img,
#F1_Car_mini img, .F1_Car_mini img{
  opacity: 1 !important;
  visibility: visible !important;
}
</style>


<style id="fixed-header-solid-bg">
/* Remove transparency from header background */
.dashboard-header{
  background: var(--panel-bg, #0b0d12) !important; /* solid fallback if var not defined */
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
}
</style>

<style>

/* --- Unrealized P/L Mini Card --- */
.mini-pl-row {
  display:flex; align-items:center; gap:12px; margin:8px 0 12px;
}
.mini-pl-card {
  display:flex; flex-direction:column; justify-content:center;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px; padding:12px 16px; min-width:260px;
  box-shadow: 0 8px 20px rgba(0,0,0,.35);
}
.mini-pl-card .mini-pl-label {
  font-size:12px; color:#c7d0df; text-transform:uppercase; letter-spacing:1px;
}
.mini-pl-card .mini-pl-value {
  font-size:28px; font-weight:600; margin-top:4px;
}
.mini-pl-pos { color:#1aa65b; }
.mini-pl-neg { color:#cc2e2e; }

</style>
<style>

/* Title icon for F1 Live header */
.f1-title-icon{
  height:28px;
  width:auto;
  display:inline-block;
  vertical-align:middle;
  margin-right:10px;
}
#f1TableOnly .hdr{
  display:flex;
  align-items:center;
  gap:10px;
}
#f1TableOnly .hdr h2{ margin:0; }

</style>

<style>
/* 2x enlarge for F1 title icon */
.f1-title-icon{ height:56px; }
</style>

<style>

/* Push content below the fixed header */
.header-spacer { height: 96px; } /* tweak if header grows/shrinks */
.main-container { padding-top: 8px; } /* small breathing room */
@media (max-width: 900px){ .header-spacer{ height: 112px; } }

</style>
<style>

/* === Edge-safe padding for Performance Metrics === */
.stats-overview,
.gauges-section {
  padding-left: 24px;
  padding-right: 24px;
}

/* Increase spacing between stat cards and between gauges */
.stats-overview { gap: 20px; }
.gauges-grid   { gap: 24px; }

/* Ensure the first/last items don't cling to the edges on very wide screens */
@media (min-width: 1400px){
  .stats-overview,
  .gauges-section { padding-left: 32px; padding-right: 32px; }
}

/* On small screens give a touch more breathing room */
@media (max-width: 640px){
  .stats-overview,
  .gauges-section { padding-left: 16px; padding-right: 16px; }
}

</style>
<style>

/* ==== Full-bleed Equity Curve (spans viewport width) ==== */
.chart-panel.full-bleed{
  position: relative;
  width: 100vw;
  left: 50%;
  right: 50%;
  margin-left: calc(-50vw + 0px);
  margin-right: calc(-50vw + 0px);
  border-radius: 18px;
  padding-left: 16px;
  padding-right: 16px;
}
.chart-panel.full-bleed svg,
.chart-panel.full-bleed canvas,
.chart-panel.full-bleed .chart{
  width: 100% !important;
  height: auto;
}
/* Prevent the full-bleed panel from hugging the absolute edges on ultra-wide screens */
@media (min-width: 1600px){
  .chart-panel.full-bleed{ padding-left: 24px; padding-right: 24px; }
}

</style>

<style>
/* Prevent overlap between full-bleed equity chart and next section */
.chart-panel.full-bleed{
  overflow: hidden;           /* contain the chart visuals */
  margin-bottom: 72px;        /* extra separation below the chart */
}
#f1TableOnly{
  position: relative;
  z-index: 1;
  margin-top: 8px;            /* small breathing room */
  clear: both;
}
/* Ensure chart stays behind neighboring elements */
.chart-panel.full-bleed{ z-index: 0; }
</style>


<style>
/* Limit full-bleed equity chart height for better fit */
.chart-panel.full-bleed{
  padding-top: 16px;
  padding-bottom: 16px;
}
.chart-panel.full-bleed svg,
.chart-panel.full-bleed canvas,
.chart-panel.full-bleed .chart{
  height: min(56vh, 520px) !important;  /* cap height to keep chart fully visible */
  max-height: min(56vh, 520px) !important;
}
@media (max-height: 800px){
  .chart-panel.full-bleed svg,
  .chart-panel.full-bleed canvas,
  .chart-panel.full-bleed .chart{ height: 48vh !important; }
}
@media (max-width: 768px){
  .chart-panel.full-bleed svg,
  .chart-panel.full-bleed canvas,
  .chart-panel.full-bleed .chart{ height: 45vh !important; }
}
</style>


<style>
/* Show X-axis labels for full-bleed chart */
.chart-panel.full-bleed{
  overflow: visible;           /* let tick labels render outside inner plot if needed */
  padding-bottom: 28px;        /* room for rotated/large tick labels */
  margin-bottom: 72px;         /* keep separation to F1 Live */
  z-index: 0;
}
/* Give the SVG a bit more headroom to include axes within bounds */
.chart-panel.full-bleed svg,
.chart-panel.full-bleed canvas,
.chart-panel.full-bleed .chart{
  height: min(60vh, 560px) !important;
  max-height: min(60vh, 560px) !important;
}
</style>


<style>
/* Extra separation to avoid overlap with F1 Live panel */
.chart-panel.full-bleed{
  margin-bottom: 120px !important;  /* was 72px */
  padding-bottom: 32px;              /* ensure axis labels have room */
  z-index: 0;                        /* keep behind following sections */
}
#f1TableOnly{
  position: relative;
  z-index: 2;
  margin-top: 24px;                  /* add breathing room above the panel */
  clear: both;
}
</style>


<style>
/* Even more separation below the equity chart */
.chart-panel.full-bleed{
  margin-bottom: 160px !important;  /* increased from 120px */
}
#f1TableOnly{
  margin-top: 32px;                 /* increased from 24px */
}

/* Small screens: keep generous spacing too */
@media (max-width: 900px){
  .chart-panel.full-bleed{ margin-bottom: 180px !important; }
  #f1TableOnly{ margin-top: 36px; }
}
</style>

</head>
<body>
<script>
// ==== Global TradingView symbol helpers (loaded early) ====
(function(){
  function sanitizeTicker(raw){
    if (!raw) return '';
    var t = String(raw).toUpperCase();
    t = t.replace(/[^A-Z0-9:_-]/g, '');
    t = t.replace(/\.(US|U|SW|LN|HK|SG|JP|DE|F|BE|MU|DU|VI|MC|LS|HE|OL|STO|ME)$/,'');
    t = t.replace(/-USD$/,'');
    return t;
  }
  function toTVSymbol(ticker){
    var t = sanitizeTicker(ticker);
    if (!t) return '';
    if (t.indexOf(':') !== -1) return t;
    var MAP = {
      'PLTR':'BATS:PLTR',
      'DECK':'NYSE:DECK',
      'TSLA':'NASDAQ:TSLA',
      'META':'NASDAQ:META',
      'BIDU':'NASDAQ:BIDU',
      'TQQQ':'NASDAQ:TQQQ',
      'SQQQ':'NASDAQ:SQQQ',
      'AAPL':'NASDAQ:AAPL'
    };
    if (MAP[t]) return MAP[t];
    return 'NASDAQ:' + t;
  }
  window.sanitizeTicker = sanitizeTicker;
  window.toTVSymbol = toTVSymbol;
})();
</script>
<div class="top-row-flex">
<!-- Telemetry Card v2 -->
</div>
<header class="dashboard-header">
<div class="header-content">
<div class="logo-section">
<div class="nav-buttons">
<button class="nav-btn active" onclick="showTelemetry()">Telemetry</button>
<button class="nav-btn" onclick="showPodium()">Podium</button>
</div>
<!-- Note: The image path is relative. It might not load in this preview. -->
<img alt="F1 Logo" class="f1-logo" onerror="this.style.display='none'" src="Images/F1_logo.png"/>
</div>
<div class="header-center">
<div class="header-title">Portfolio Dashboard</div>
<div class="header-subtitle">Season 2025</div></div>
<div class="header-right">
<!-- Note: The image path is relative. It might not load in this preview. -->
<img alt="F1 Car" class="header-car" onerror="this.style.display='none'" src="Images/F1_Car_mini.png"/>
<button class="nav-btn" id="ai-insights-btn">GET DATA</button>
<div class="live-indicator">
<div class="live-dot"></div>
</div>
<span>LIVE DATA</span>
</div>
</div>
</header>
<div class="header-spacer"></div>
<!-- Telemetry Dashboard Page -->
<div class="page-content" id="telemetry-page">
<div class="main-container">
<div class="top-section" style="; display:flex; gap:20px; align-items:stretch; flex-wrap:wrap;">
<!-- Track Map Card -->
<div class="gauge-panel">
<h3>TRACK MAP</h3>
<div class="gauge">
<svg class="recharts-surface" height="500" style="width: 100%; height: 100%;" viewbox="0 0 612 500" width="612">
<title>Racing Track Visualization</title>
<desc>Multi-track racing performance data</desc>
<defs>
<clippath id="recharts3-clip">
<rect height="421" width="492" x="90" y="20"></rect>
</clippath>
<filter id="glow-white">
<fegaussianblur result="coloredBlur" stddeviation="3"></fegaussianblur>
<femerge>
<femergenode in="coloredBlur"></femergenode>
<femergenode in="SourceGraphic"></femergenode>
</femerge>
</filter>
<filter id="glow-orange">
<fegaussianblur result="coloredBlur" stddeviation="7"></fegaussianblur>
<femerge>
<femergenode in="coloredBlur"></femergenode>
<femergenode in="SourceGraphic"></femergenode>
</femerge>
</filter>
<filter id="glow-cyan">
<fegaussianblur result="coloredBlur" stddeviation="7"></fegaussianblur>
<femerge>
<femergenode in="coloredBlur"></femergenode>
<femergenode in="SourceGraphic"></femergenode>
</femerge>
</filter>
<filter id="glow-blue">
<fegaussianblur result="coloredBlur" stddeviation="8"></fegaussianblur>
<femerge>
<femergenode in="coloredBlur"></femergenode>
<femergenode in="SourceGraphic"></femergenode>
</femerge>
</filter>
</defs>
<!-- Main Track -->
<g class="recharts-layer recharts-line">
<path class="recharts-curve recharts-line-curve" d="M149.569,270.1L149.669,268.297L149.824,265.689L150.364,257.051L150.459,255.528L150.792,249.766L150.849,248.707L151.003,245.849L151.191,242.454L151.675,234.198L151.728,233.288L151.934,229.699L152.206,224.862L152.217,224.69L152.621,218.011L152.705,216.626L152.968,212.24L153.047,210.87L153.34,205.541L153.36,205.179L153.674,199.595L153.73,198.613L154.066,192.857L154.17,191.082L154.399,187.133L154.61,183.55L154.847,179.524L155.196,173.638L155.524,168.185L155.733,164.863L155.966,161.152L156.172,157.295L156.27,154.95L156.547,150.429L156.758,147.312L157.188,139.884L157.198,139.709L157.54,133.279L157.833,128.208L157.882,127.417L158.028,125.072L158.419,118.606L158.538,116.474L158.797,111.812L158.809,111.607L159.166,105.957L159.249,104.573L159.542,99.279L159.564,98.896L160.079,89.758L160.098,89.367L160.294,84.604L160.323,83.825L160.519,78.105L160.58,76L160.616,74.588L160.713,66.574L160.714,66.381L160.714,61.159L160.704,59.109L160.665,52.987L160.642,50.391L160.616,48.262L160.609,47.497L160.567,40.66L160.572,39.464L160.899,34.927L160.909,34.833L161.007,33.98L161.398,31.387L161.427,31.229L162.179,28.225L162.374,27.678L163.058,26.093L163.522,25.192L164.516,23.911L164.572,23.855L166.426,22.25L167.258,21.581L167.755,21.213L168.088,21.12L169.044,20.861L171.182,20.322L172.581,20.089L173.707,20L180.785,22.647L181.166,22.869L181.912,23.31L182.592,23.749L183.308,24.237L184.839,25.347L186.785,26.831L187.622,27.479L188.137,27.881L189.039,28.616L189.858,29.311L190.748,30.001L195.22,32.986L196.51,33.803L197.183,34.199L197.878,34.513L199.123,35.071L200.955,35.828L201.824,36.137L204.324,36.858L207.501,37.523L208.036,37.604L210.596,37.865L213.994,37.924L218.137,37.655L218.291,37.64L221.807,37.213L223.329,37.006L227.752,36.305L229.182,36.041L234.975,34.896L237.874,34.3L242.873,33.133L243.881,32.879L246.469,32.24L249.981,31.461L251.255,31.209L258.385,30.143L262.287,29.914L264.246,29.859L270.887,29.859L274.347,29.979L276.406,30.072L284.903,30.605L285.527,30.659L296.331,31.707L298.67,31.959L303.412,32.701L306.37,33.149L318.502,34.94L320.89,35.297L322.555,35.544L328.357,36.393L329.343,36.538L339.451,38.035L340.38,38.173L348.096,39.309L352.12,39.891L355.177,40.34L359.426,40.979L363.243,41.537L368.754,42.329L371.038,42.663L380.729,44.097L382.721,44.39L387.721,45.119L393.025,45.882L393.903,46.009L402.646,47.268L410.899,48.44L413.588,48.822L417.732,49.41L420.666,49.826L433.138,51.585L434.291,51.744L438.61,52.325L443.423,52.952L445.227,53.195L452.556,54.195L453.054,54.263L458.611,55.012L465.326,55.9L468.525,56.327L474.902,57.197L475.85,57.322L480.294,57.89L484.825,58.488L488.059,58.92L498.849,60.357L501.928,60.768L504.328,61.091L506.519,61.407L507.775,61.595L512.819,62.544L513.877,62.808L519.265,64.321L523.37,65.764L524.729,66.505L525.028,66.665L526.837,67.64L527.176,67.838L528.153,68.477L530.959,71.292L532.011,72.634L532.798,74.282L532.939,75.299L533.164,76.901L533.086,78.993L532.446,82.4L532.353,82.83L532.039,84.191L531.329,85.426L531.132,85.743L529.8,87.887L529.032,89.012L526.679,91.663L525.125,93.062L523.127,94.694L522.83,94.91L519.656,97.112L517.735,98.389L503.247,106.03L499.926,107.735L497.035,109.235L492.552,111.607L491.825,112.001L488.987,113.561L487.312,114.497L484.445,116.119L482.933,116.987L478.536,119.707L471.406,124.575L471.052,124.821L467.597,127.595L464.79,130.137L459.881,134.629L456.582,137.814L455.144,139.428L453.435,141.379L452.872,142.021L450.602,144.648L447.916,147.916L445.412,150.822L442.105,154.489L441.136,155.507L436.44,159.391L435.862,159.799L433.021,161.701L431.135,162.799L416.786,167.433L414.61,167.669L411.744,167.838L410.606,167.882L408.098,167.947L406.064,167.953L400.134,167.89L397.371,167.847L394.233,167.778L391.609,167.776L390.452,167.813L381.629,168.245L380.328,168.344L373.111,169.468L372.905,169.517L363.675,172.075L361.943,172.67L356.481,174.975L354.005,176.16L351.121,177.746L350.392,178.221L347.236,180.387L345.361,181.773L343.916,182.919L341.015,185.504L337.775,188.758L333.104,193.782L330.484,196.762L327.128,200.891L326.364,201.846L324.997,203.568L322.751,206.323L317.307,212.763L316.793,213.357L313.936,216.432L312.397,217.869L310.894,219.296L309.956,220.178L308.678,221.354L307.709,222.203L305.428,224.066L302.874,226.005L301.956,226.621L301.019,227.071L300.474,227.32L298.577,228.101L297.191,228.519L293.576,229.227L293.498,229.238L289.95,229.326L289.103,229.167L287.247,228.598L286.753,228.37L285.049,227.213L284.555,226.758L283.975,226.147L282.51,224.371L282.444,224.283L281.641,223.085L281.143,222.203L280.483,220.965L280.312,220.605L279.58,218.615L278.802,213.086L278.799,212.824L278.945,209.875L278.962,209.712L279.385,206.571L279.86,203.98L280.117,202.663L280.52,200.65L280.947,198.969L281.924,195.309L282.514,193.15L283.487,190.122L283.544,189.975L283.78,189.234L284.61,186.356L284.989,185.08L286.062,181.562L286.417,180.352L287.912,175.141L288.468,173.211L289.134,170.981L289.787,169.09L290.223,167.798L291.7,163.353L291.74,163.228L292.814,159.818L294.963,152.748L295.369,151.372L296.819,145.927L296.885,145.671L298.235,140.313L298.978,137.067L299.212,136.014L300.298,130.469L300.335,130.224L301.312,122.869L301.356,122.506L301.569,119.106L301.556,118.677L301.448,115.878L301.116,112.14L300.729,110.043L300.091,107.699L298.626,103.862L298.311,103.17L297.063,100.7L295.003,97.246L293.547,95.194L291.349,92.6L290.67,91.892L288.468,89.829L286.468,88.218L284.805,87.022L282.754,85.672L281.967,85.188L280.019,84.216L276.835,82.928L276.308,82.724L274.425,82.126L273.866,82.049L271.522,81.693L271.129,81.66L268.641,81.729L268.501,81.747L266.803,82.099L265.955,82.368L264.97,82.79L264.05,83.363L262.048,85.14L261.83,85.368L260.827,86.88L260.61,87.23L260.241,87.84L259.455,89.519L259.264,90.007L258.898,91.026L258.776,91.392L258.399,92.622L258.385,92.671L257.959,94.324L257.946,94.377L257.457,96.402L257.428,96.532L257.116,98L256.987,98.731L256.822,99.812L256.285,102.868L256.211,103.303L255.943,104.928L255.801,105.827L255.455,108.197L254.674,114.272L254.65,114.451L254.256,117.54L254.039,119.707L253.639,123.85L253.551,124.788L253.22,128.429L252.956,131.846L252.867,132.959L252.646,135.498L252.427,138.288L252.381,138.955L252.281,140.384L252.046,143.268L251.89,145.109L251.705,147.388L251.304,152.641L251.275,153.034L250.865,158.61L250.545,163.2L250.239,167.996L250.181,168.948L249.921,173.545L249.839,174.881L249.7,177.033L249.448,180.814L249.293,183.157L249.021,187.172L249.009,187.351L248.716,191.437L248.66,192.265L248.423,196.091L247.886,204.742L247.739,207.104L247.45,211.778L247.251,215.098L247.229,215.456L247.153,216.732L246.968,219.806L246.762,223.198L246.645,225.104L246.42,228.669L246.347,229.802L245.738,239.003L245.639,240.464L245.44,243.36L245.207,246.651L245.102,248.28L245.007,249.823L244.711,254.462L244.359,259.547L244.125,262.918L243.923,265.961L243.735,269.135L243.637,270.421L243.344,274.286L243.276,275.254L243.002,279.402L242.894,280.873L242.514,285.69L242.44,286.635L242.092,291.198L241.732,295.958L241.484,299.189L241.293,302.317L241.23,303.912L241.226,313.099L241.244,313.65L241.73,317.816L241.879,318.518L242.269,320.258L242.325,320.486L243.442,324.237L243.523,324.461L245.197,328.134L245.59,328.785L247.837,331.627L249.004,332.721L250.181,333.652L252.548,335.104L253.062,335.357L256.384,336.753L258.922,337.702L261.99,338.664L263.513,339.017L267.371,339.798L268.455,339.977L274.422,340.452L275.087,340.438L278.883,340.186L285.452,339.423L285.587,339.408L288.11,339.133L292.814,337.631L297.92,335.877L298.186,335.784L302.154,334.131L302.63,333.865L304.216,333.008L307.296,331.323L308.637,330.526L311.958,328.359L313.777,326.994L315.035,325.978L319.654,321.796L319.772,321.679L322.262,319.03L322.751,318.447L327.515,311.979L327.927,311.377L330.711,306.758L332.501,303.47L333.055,302.424L336.575,295.677L337.304,294.466L339.39,291.223L341.015,288.852L343.92,285.106L346.216,282.652L347.022,281.818L351.026,277.874L355.303,274.352L356.398,273.54L360.149,271.006L360.305,270.911L364.603,268.566L369.94,266.214L371,265.831L378.173,263.461L381.5,262.42L387.034,260.84L389.058,260.565L392.488,260.111L394.202,259.869L395.076,259.756L400.879,259.302L402.45,259.258L410.307,259.487L412.559,259.685L419.653,260.705L419.885,260.75L424.904,261.911L425.745,262.136L431.286,263.804L431.508,263.877L436.347,265.547L439.712,266.754L441.37,267.351L445.328,268.78L451.358,270.97L452.8,271.48L458.78,273.517L458.953,273.576L461.932,274.606L463.973,275.337L471.602,278.194L474.377,279.335L481.648,283.22L482.638,283.843L482.996,284.07L483.957,284.767L485.216,285.822L487.74,288.124L489.182,289.847L490.494,292.061L491.512,294.714L491.82,295.638L492.414,298.185L492.503,299.546L492.513,299.955L492.454,302.211L492.282,303.611L491.82,305.301L490.11,308.996L489.994,309.198L486.301,313.615L485.448,314.382L481.9,317.131L480.636,318.02L478.695,319.291L477.462,320.01L474.533,321.587L471.084,323.331L470.234,323.74L468.417,324.57L466.132,325.516L464.25,326.267L456.652,329.223L455.486,329.673L453.208,330.547L448.746,332.231L447.792,332.591L439.614,335.677L436.456,336.872L430.14,339.265L428.381,339.931L424.776,341.303L423.059,341.965L415.119,345.046L412.901,345.909L408.798,347.509L405.429,348.822L399.782,351.028L399.52,351.132L392.716,353.85L389.216,355.253L384.171,357.264L381.304,358.415L379.894,358.984L375.151,360.901L369.894,363.015L362.6,365.946L361.088,366.558L355.778,368.723L355.617,368.789L349.441,371.299L348.536,371.666L339.501,375.326L339.119,375.48L319.505,383.414L319.039,383.603L308.979,387.689L297.129,392.51L292.836,394.249L292.717,394.297L285.196,397.317L281.898,398.651L270.741,403.179L268.45,404.116L265.222,405.453L259.563,407.781L252.769,410.568L247.108,412.87L244.418,413.979L241.543,415.18L232.6,418.917L229.816,420.054L222.593,423.047L213.163,426.982L209.484,428.511L202.005,431.595L200.955,432.027L197.027,433.639L193.141,435.189L191.871,435.681L187.935,437.155L187.769,437.214L182.885,438.777L182.611,438.853L179.613,439.594L179.359,439.652L174.486,440.518L169.114,440.944L168.852,440.958L165.962,441L164.523,440.873L160.388,440.138L159.688,439.949L157.393,439.026L154.995,437.562L153.242,436.397L151.751,435.343L150.117,433.732L149.85,433.454L147.832,431.324L147.187,430.57L146.649,429.895L145.628,428.522L144.94,427.55L144.296,426.598L143.495,425.182L143.231,424.673L142.108,422.399L141.131,420.019L140.548,418.225L140.008,416.146L139.743,414.889L139.226,411.599L138.968,409.169L138.933,408.686L138.85,406.15L138.836,404.103L138.836,402.149L138.884,400.828L139.275,396.926L139.477,395.275L140.301,388.932L140.347,388.589L140.936,384.598L141.121,383.246L141.717,378.807L142.016,376.666L142.352,374.26L143.017,369.284L143.035,369.144L143.503,365.543L143.524,365.378L144.11,360.12L144.314,357.881L144.452,356.247L144.794,351.954L144.842,351.309L145.233,345.305L145.337,343.434L145.721,336.139L145.908,332.758L146.21,327.861L146.226,327.583L146.454,323.669L146.602,321.188L146.894,316.315L147.155,311.776L147.235,310.417L147.626,303.951L147.769,301.574L149.433,272.936L149.487,272.012L149.774,267.075" fill="none" filter="url(#glow-white)" height="421" id="raceTrack" name="Track" stroke="#ffffff" stroke-width="15" width="492"></path>
</g>
<!-- F1 Car Animation -->
<g class="f1-car">
<circle fill="#0066ff" filter="url(#glow-blue)" opacity="0.9" r="20">
<animatemotion dur="16s" repeatcount="indefinite">
<mpath href="#raceTrack"></mpath>
</animatemotion>
</circle>
<!-- Car trail effect -->
<circle fill="#0099ff" opacity="0.6" r="15">
<animatemotion begin="0.1s" dur="16s" repeatcount="indefinite">
<mpath href="#raceTrack"></mpath>
</animatemotion>
</circle>
<circle fill="#00ccff" opacity="0.3" r="10">
<animatemotion begin="0.2s" dur="16s" repeatcount="indefinite">
<mpath href="#raceTrack"></mpath>
</animatemotion>
</circle>
</g>
<!-- PIA Track -->
<g class="recharts-layer recharts-line">
<path class="recharts-curve recharts-line-curve" d="M160.665,52.987L160.642,50.391L160.616,48.262L160.609,47.497L160.567,40.66L160.572,39.464L160.899,34.927L160.909,34.833L161.007,33.98L161.398,31.387L161.427,31.229L162.179,28.225L162.374,27.678L163.058,26.093L163.522,25.192L164.516,23.911L164.572,23.855L166.426,22.25L167.258,21.581L167.755,21.213L168.088,21.12L169.044,20.861L171.182,20.322L172.581,20.089L173.707,20L180.785,22.647L181.166,22.869L181.912,23.31L182.592,23.749L183.308,24.237L184.839,25.347L186.785,26.831L187.622,27.479L188.137,27.881L189.039,28.616L189.858,29.311L190.748,30.001L195.22,32.986L196.51,33.803L197.183,34.199L197.878,34.513L199.123,35.071M488.059,58.92L498.849,60.357L501.928,60.768L504.328,61.091L506.519,61.407L507.775,61.595L512.819,62.544L513.877,62.808L519.265,64.321L523.37,65.764L524.729,66.505L525.028,66.665L526.837,67.64L527.176,67.838L528.153,68.477L530.959,71.292L532.011,72.634L532.798,74.282L532.939,75.299L533.164,76.901L533.086,78.993L532.446,82.4L532.353,82.83L532.039,84.191L531.329,85.426L531.132,85.743L529.8,87.887L529.032,89.012L526.679,91.663L525.125,93.062L523.127,94.694L522.83,94.91L519.656,97.112L517.735,98.389M298.311,103.17L297.063,100.7L295.003,97.246L293.547,95.194L291.349,92.6L290.67,91.892L288.468,89.829L286.468,88.218L284.805,87.022L282.754,85.672L281.967,85.188L280.019,84.216L276.835,82.928L276.308,82.724L274.425,82.126L273.866,82.049L271.522,81.693L271.129,81.66L268.641,81.729L268.501,81.747L266.803,82.099L265.955,82.368L264.97,82.79L264.05,83.363L262.048,85.14L261.83,85.368L260.827,86.88L260.61,87.23L260.241,87.84L259.455,89.519L259.264,90.007L258.898,91.026L258.776,91.392L258.399,92.622L258.385,92.671L257.959,94.324L257.946,94.377L257.457,96.402L257.428,96.532L257.116,98L256.987,98.731L256.822,99.812L256.285,102.868L256.211,103.303L255.943,104.928L255.801,105.827L255.455,108.197L254.674,114.272L254.65,114.451M322.262,319.03L322.751,318.447L327.515,311.979L327.927,311.377L330.711,306.758L332.501,303.47L333.055,302.424L336.575,295.677L337.304,294.466L339.39,291.223L341.015,288.852L343.92,285.106L346.216,282.652L347.022,281.818L351.026,277.874L355.303,274.352L356.398,273.54L360.149,271.006L360.305,270.911L364.603,268.566L369.94,266.214L371,265.831L378.173,263.461L381.5,262.42L387.034,260.84L389.058,260.565L392.488,260.111L394.202,259.869L395.076,259.756L400.879,259.302L402.45,259.258L410.307,259.487L412.559,259.685L419.653,260.705L419.885,260.75L424.904,261.911L425.745,262.136L431.286,263.804L431.508,263.877L436.347,265.547L439.712,266.754L441.37,267.351L445.328,268.78L451.358,270.97L452.8,271.48L458.78,273.517L458.953,273.576L461.932,274.606L463.973,275.337M285.196,397.317L281.898,398.651L270.741,403.179L268.45,404.116L265.222,405.453L259.563,407.781L252.769,410.568L247.108,412.87L244.418,413.979L241.543,415.18L232.6,418.917L229.816,420.054L222.593,423.047L213.163,426.982L209.484,428.511L202.005,431.595L200.955,432.027L197.027,433.639L193.141,435.189L191.871,435.681L187.935,437.155L187.769,437.214L182.885,438.777L182.611,438.853L179.613,439.594L179.359,439.652L174.486,440.518L169.114,440.944L168.852,440.958L165.962,441L164.523,440.873L160.388,440.138L159.688,439.949L157.393,439.026L154.995,437.562L153.242,436.397L151.751,435.343L150.117,433.732L149.85,433.454L147.832,431.324L147.187,430.57L146.649,429.895L145.628,428.522L144.94,427.55L144.296,426.598L143.495,425.182L143.231,424.673L142.108,422.399L141.131,420.019L140.548,418.225L140.008,416.146L139.743,414.889L139.226,411.599" fill="none" filter="url(#glow-orange)" height="421" name="PIA" stroke="#b26b00" stroke-width="3" width="492"></path>
</g>
<!-- RUS Track -->
<g class="recharts-layer recharts-line">
<path class="recharts-curve recharts-line-curve" d="M202.707,36.451L206.485,37.455L207.792,37.604L213.258,37.839L216.045,37.853L221.08,37.372L222.1,37.213L224.689,36.823L228.1,36.259L229.328,36.041L236.165,34.691L239.76,33.872L241.537,33.447L247.593,31.991L250.968,31.295L252.671,30.925L259.753,30.037L260.726,30.028L281.533,30.321L285.714,30.411L288.663,30.854L291.316,31.21L303.558,32.701L305.919,33.042L307.514,33.305L313.188,34.157L314.156,34.3L324.085,35.765L324.997,35.899L332.567,37L336.531,37.58L339.55,38.03L343.75,38.67L347.516,39.229L352.931,40.02L355.168,40.35L364.648,41.756L366.605,42.045L371.554,42.769L376.86,43.537L377.736,43.665L386.432,44.923L394.637,46.095L397.313,46.479L401.462,47.088M502.026,106.669L500.536,107.427L497.973,108.73L496.627,109.421L492.601,111.572L485.715,115.409L485.37,115.601L481.759,117.718L478.596,119.747L473.018,123.402L469.132,126.171L467.333,127.738L465.351,129.513L464.716,130.083L462.176,132.391L459.1,135.375L456.189,138.433L452.409,142.551L451.359,143.727L447.184,148.804L446.704,149.385L444.351,152.144L442.815,153.805M286.72,228.411L285.636,227.675L284.352,226.548L284.024,226.218L282.559,224.442L280.099,220.063L280.019,219.859L279.336,217.585L279.31,217.463L278.945,215.169L278.816,213.309L278.799,212.362L278.854,210.893L278.994,209.662L279.336,206.998L279.537,205.49L280.019,203.019L280.155,202.388L280.557,200.567L281.143,198.294L281.417,197.269L282.259,194.246L282.51,193.391L283.506,190.105L283.877,188.879L284.352,187.263L284.903,185.326L285.252,184.152L286.432,180.249L286.466,180.139L287.394,177.084L289.298,170.689L289.677,169.446L291.3,164.543L291.378,164.31M253.291,128.125L252.916,132.497L252.887,132.838L252.476,137.72L252.163,141.693L251.857,145.784L251.792,146.602L251.45,150.63L251.353,151.86L251.202,153.876L250.962,157.331L250.841,159.268L250.588,163.268L250.572,163.512L250.132,169.836L250.069,170.848L249.888,174.206L249.32,182.454L249.155,184.758L248.826,189.293L248.618,192.467L248.597,192.809L248.52,194.03L248.332,197.009L248.13,200.319L248.027,202.166L247.837,205.648L247.771,206.773L247.194,216.046L247.104,217.514L246.932,220.4L246.757,223.601L246.665,225.188L246.573,226.695L246.274,231.298L245.923,236.421L245.688,239.825L245.473,242.902L245.248,246.078L245.163,247.344L244.907,251.158L244.842,252.12L244.565,256.274L244.472,257.747L244.174,262.562L244.112,263.504L243.792,268.039M257.959,337.415L258.532,337.596L261.787,338.494L267.356,339.806L267.469,339.834L269.489,340.41L273.817,340.438L278.645,340.305L278.896,340.296L282.711,339.92L283.291,339.798L285.314,339.402L289.226,338.616L290.763,338.235L294.279,337.169L296.386,336.448L297.893,335.89L303.416,333.473L303.558,333.403L306.594,331.79L307.221,331.414L313.766,326.976L314.351,326.547L318.404,323.03L320.947,320.425L321.725,319.583L326.257,313.841L326.999,312.727L328.933,309.657L330.32,307.362M486.252,286.614L486.616,286.965L488.499,288.959L489.501,290.272L490.452,291.979L491.917,295.993L491.979,296.217L492.503,301.287L492.419,302.207L491.666,305.605L491.282,306.723L490.547,308.334L489.964,309.245L488.418,311.23L486.463,313.42L485.959,313.935L484.833,314.98L483.371,316.102L482.181,316.929L477.357,320.033L476.583,320.507L474.993,321.441L471.406,323.172L470.629,323.516L463.837,326.405L461.002,327.542L454.997,329.851L453.369,330.479L450.221,331.693L448.698,332.267L441.57,334.927L439.565,335.677L435.823,337.095L432.728,338.271L427.508,340.236L427.259,340.331L420.657,342.88L417.248,344.204L412.461,346.063L409.776,347.117L408.437,347.644L403.915,349.426L398.905,351.396L391.999,354.116L390.591,354.676L385.705,356.648L385.553,356.709L379.636,359.093L378.765,359.445L370.072,362.962L369.704,363.111L350.698,370.772L350.245,370.956L340.478,374.935L328.899,379.622L324.675,381.318L324.557,381.365L317.183,384.349L313.945,385.669L302.972,390.14L300.7,391.053L297.454,392.343L291.81,394.634L285.049,397.388L279.436,399.672L276.747,400.763L273.852,401.936M139.434,395.473L139.715,393.267L140.381,388.671L140.398,388.542L140.818,385.213L140.838,385.06L141.522,380.157L141.834,378.065L142.059,376.533L142.612,372.486L142.694,371.879L143.426,366.231L143.627,364.453L144.354,357.491L144.655,354.255L144.94,349.533L144.956,349.264L145.184,345.483L145.332,343.065L145.624,338.306L145.89,333.938L145.966,332.622L146.307,326.298L146.435,323.97L148.114,295.496L148.171,294.523L148.616,286.849L148.7,285.371L148.902,281.801L149.042,279.296L149.282,275.026L149.433,272.439L149.7,268.119" fill="none" filter="url(#glow-cyan)" height="421" name="RUS" stroke="#27f4d2" stroke-width="3" width="492"></path>
</g>
<!-- NOR Track -->
<g class="recharts-layer recharts-line">
<path class="recharts-curve recharts-line-curve" d="M149.633,269.395L149.677,268.637L150.117,260.999L150.192,259.71L150.605,252.686L150.673,251.5L150.931,246.774L151.142,243.093L151.58,236.079L151.631,235.242L151.777,232.79L152.168,226.076L152.223,225.059L152.461,220.569L152.485,220.148L153.047,211.048L153.07,210.639L153.291,206.571L153.633,200.994L153.732,199.256L153.926,195.7L154.099,192.625L154.512,185.681L154.805,180.956L154.897,179.409L155.098,175.911L155.237,173.473L155.782,163.903L155.89,162.024L156.159,157.4L156.221,156.265L156.514,150.829L156.582,149.613L157.212,139.135L157.344,136.974L157.716,130.924L158.028,125.463L158.14,123.325L158.321,119.992L158.61,115.369L158.663,114.485L159.054,107.344L159.455,100.921L159.542,99.528L159.871,93.607L159.884,93.346L160.372,82.795L160.523,79.065L160.567,77.004L160.643,72.749L160.714,66.381L160.716,65.916L160.714,60.8L160.714,60.59M398.153,46.628L399.617,46.84L404.971,47.592L407.432,47.943L415.978,49.186L418.08,49.486L423.059,50.181L429.359,51.033L435.125,51.85L437.661,52.206L441.299,52.701L447.734,53.554L448.014,53.591L454.411,54.444L459.064,55.077L464.862,55.865L466.723,56.111L476.046,57.322L489.28,59.098L489.896,59.18M446.158,150.048L444.548,151.889L442.691,153.885L441.052,155.523L438.269,157.993L437.807,158.361L435.208,160.255L433.9,161.132L430.479,163.178L429.31,163.726L421.643,166.497L420.756,166.762L417.771,167.437L414.366,167.669L413.643,167.71L407.773,167.953L403.183,167.953L402.318,167.939L397.078,167.811L396.211,167.798L392.439,167.776L386.859,167.851L385.602,167.918L385.065,167.953L378.693,168.536L378.521,168.557L372.611,169.566L371.196,169.907L365.921,171.399L363.333,172.181L361.058,172.882L357.836,174.279L357.082,174.668L350.601,178.197L348.975,179.144L343.977,182.627L341.406,185.149L341.227,185.322L337.607,188.847L335.448,191.153L331.443,195.7L330.875,196.361L328.234,199.528L327.878,199.963L323.895,204.901L322.799,206.252L321.232,208.17L318.258,211.723L315.888,214.36L314.742,215.56L313.11,217.197L310.174,219.971L310.102,220.036L307.66,222.203L306.83,222.949L306.262,223.456L304.093,225.293M288.859,171.932L290.247,167.728L291.203,164.969L292.848,159.692L293.059,159.001L294.213,155.171L295.845,149.638L295.891,149.479L296.685,146.643L297.649,142.8L297.82,142.097L298.968,137.187L299.749,133.385L300.239,130.868L300.872,126.671L301.515,118.856L301.556,118.18L301.628,116.054L301.409,114.343L300.665,110.705L299.456,105.852L299.255,105.187M244.221,261.37L243.774,267.875L243.686,269.17L243.309,274.705L242.904,280.503L242.721,282.94L242.416,286.756L242.349,287.604L241.976,292.441L241.765,295.421L241.683,296.633L241.489,299.64L241.293,303.028L241.125,306.881L241.097,308.002L241.195,313.508L241.213,313.783L241.39,315.64L241.779,318.09L242.025,319.299L242.426,320.982M149.504,271.484Z" fill="none" filter="url(#glow-orange)" height="421" name="NOR" stroke="#ff9900" stroke-width="3" width="492"></path>
</g>
</svg>
</div>
</div>
<!-- Embedded Video -->
<div class="video-container">
<div class="video-wrapper">
<video controls autoplay muted loop playsinline style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:12px;border:1px solid rgba(255,255,255,.08);"><source src="file:///C:/Temp/Dashboard/audio/F1.mp4" type="video/mp4">Your browser does not support the video tag.</video>
</div>

</div><div class="stat-card telemetry-card"><div><div class="wave-container"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div><div class="telemetry-title">TELEMETRY ALERT</div><div class="telemetry-message" id="telemetry-live-message">No live message</div></div></div>
<!-- Telemetry Alert Card -->
</div>
</div>
<!-- Stats Overview -->
<h2 class="section-title">Performance Metrics</h2>
<div class="stats-overview">
<div class="stat-card">
<img alt="Win Rate" class="stat-icon" onerror="this.style.display='none'" src="Images/Checked_flag.png"/>
<div class="stat-value positive" id="win-rate-value">0%</div>
<div class="stat-label">Win Rate</div>
</div>
<div class="stat-card">
<img alt="DRS" class="stat-icon" onerror="this.style.display='none'" src="Images/Timer.png"/>
<div class="stat-value positive" id="drs-value">0</div>
<div class="stat-label">DRS</div>
</div>
<div class="stat-card">
<img alt="Pole Position" class="stat-icon" onerror="this.style.display='none'" src="Images/Stiring_wheel.png"/>
<div class="stat-value" id="pole-positions-value">0</div>
<div class="stat-label">REMAINING LAPS</div>
</div>
<div class="stat-card">
<img alt="Breakdown" class="stat-icon" onerror="this.style.display='none'" src="Images/Wheel.png"/>
<div class="stat-value positive" id="breakdown-value">0%</div>
<div class="stat-label">PIT STOPS</div>
</div>
</div>
<!-- Performance Gauges -->
<div class="gauges-section">
<div class="gauges-grid">
<div class="gauge-panel">
<h3>CAGR</h3>
<div class="gauge glow-outer" id="gauge-cagr">
<div class="gauge-value" id="cagr-gauge-value">0.0%</div>
</div>
<div class="gauge-label">Compound Annual Growth Rate</div>
</div>
<div class="gauge-panel">
<h3>Sharpe Ratio</h3>
<div class="gauge glow-outer" id="gauge-sharpe">
<div class="gauge-value" id="sharpe-gauge-value">0.00</div>
</div>
<div class="gauge-label">Risk-Adjusted Returns</div>
</div>
<div class="gauge-panel">
<h3>ROI</h3>
<div class="gauge glow-outer" id="gauge-vol">
<div class="gauge-value" id="roi-gauge-value">0.0%</div>
</div>
<div class="gauge-label">Return of Investment</div>
</div>
</div>
</div>
<!-- Equity Curve Chart -->
<div class="chart-panel full-bleed" style="margin-bottom: 40px;">
<h2 class="section-title" style="font-size: 32px; display: flex; align-items: center; width: 100%;"><img alt="F1" class="title-icon circuit-icon" onerror="this.style.display=\'none\';" src="C:\\Temp\\Dashboard\\Images\\Car_Top.png"/> F1 Grand Prix Circuit 
<label class="upload-btn" style="margin-left: auto;">
          Upload Equity Data
          <input accept=".csv" id="equity-curve-upload" type="file"/>
</label>
</h2>
<div id="equity-chart-container" style="height: 400px; position: relative; background: linear-gradient(45deg, rgba(220,20,60,0.05), rgba(44,229,140,0.05)); border-radius: 12px; padding: 20px;">
<!-- SVG will be dynamically generated here -->
</div>
<script>
(function(){
  if (window.__F1_JSON_RECOVERY__) return; window.__F1_JSON_RECOVERY__=true;
  const $=s=>document.querySelector(s);
  const tbody=$('#f1_tbl tbody'), minis=$('#f1_minis'), diag=$('#f1_diag'), status=$('#f1_status');
  const keyIn=$('#f1_key'); const btnPick=$('#f1_pick'), btnRefresh=$('#f1_refresh');

  const fmt=(n,d=2)=>Number.isFinite(+n)?(+n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}):'â€”';
  const money=n=>Number.isFinite(+n)?((n<0?'-':'')+'$'+Math.abs(+n).toFixed(2)):'â€”';
  const parseN=x=>{const n=parseFloat(x);return Number.isFinite(n)?n:NaN;};
  function logd(){ if (diag) diag.textContent += Array.from(arguments).join(' ') + "\\n"; }
  function lastBiz(){ const d=new Date(); d.setDate(d.getDate()-1); while([0,6].includes(d.getDay())) d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

  (function ensureTV(){ if (window.TradingView) return; var s=document.createElement('script'); s.src="https://s3.tradingview.com/tv.js"; s.async=true; document.head.appendChild(s); })();
  function normTV(sym){
    if(!sym) return sym;
    try{
      const parts=String(sym).split(':'), ex=(parts[0]||'NASDAQ').toUpperCase(), tk=(parts[1]||parts[0]).toUpperCase().trim();
      if (tk==='SOXL') return 'AMEX:SOXL';
      if (tk==='SPX'||tk==='SPXW') return 'SP:SPX';
      if (tk==='NDX') return 'NASDAQ:NDX';
      if (tk==='RUT') return 'INDEX:RUT';
      if (ex==='NYSEARCA'||ex==='ARCA') return 'AMEX:'+tk;
      return ex+':'+tk;
    }catch(e){ return sym; }
  }
  function addMini(tvSymbol){ /* minis temporarily disabled */ });
      }catch(e){ logd('TV widget failed', tvSymbol, e.message); }
    }
    spawn();
  }

  async function fetchStock(sym, key){
    const u=`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ logd('EQ parse',sym,e.message); return NaN; }
    const g=j && (j["Global Quote"]||j.globalQuote||j["global quote"]);
    const price=parseN(g&& (g["05. price"]||g.price||g["05. Price"]));
    const prev =parseN(g&& (g["08. previous close"]||g.previousClose));
    const v=Number.isFinite(price)?price:(Number.isFinite(prev)?prev:NaN);
    logd('EQ',sym,'chosen',v,'raw',JSON.stringify(g).slice(0,120));
    return v;
  }
  async function fetchOpt(occ,key){
    try{
      const u1=`https://www.alphavantage.co/query?function=OPTION_PRICE&symbol=${encodeURIComponent(occ)}&apikey=${encodeURIComponent(key)}`;
      const r1=await fetch(u1); const t1=await r1.text(); let j1={}; try{ j1=JSON.parse(t1);}catch(e){}
      const v=[j1.mark,j1.last,(j1.bid&&j1.ask?(+j1.bid+ +j1.ask)/2:null)].map(parseN).find(Number.isFinite);
      if(Number.isFinite(v)){ logd('OPT',occ,'OPTION_PRICE',v); return v; }
    }catch(e){}
    const root=occ.slice(0,-15);
    const u=`https://www.alphavantage.co/query?function=HISTORICAL_OPTIONS&symbol=${encodeURIComponent(root)}&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ logd('OPT parse',occ,e.message); return NaN; }
    const hit=((j&&j.data)||[]).find(c=>String(c.contractID).toUpperCase().replace(/\\s/g,'')===occ);
    if(!hit){ logd('OPT',occ,'not found on',date); return NaN; }
    const seq=[hit.mark,hit.last,(hit.bid&&hit.ask?(+hit.bid+ +hit.ask)/2:null)].map(parseN);
    const v=seq.find(Number.isFinite); logd('OPT',occ,'chosen',v);
    return Number.isFinite(v)?v:NaN;
  }

  let POS=[];
  function renderTable(){
    if (!tbody) return;
    tbody.innerHTML='';
    if(!POS.length){ tbody.innerHTML='<tr><td colspan="7" style="opacity:.8">No positions.</td></tr>'; return; }
    POS.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.symbol}</td>
        <td>${fmt(Number(p.qty), 4)}</td>
        <td>${fmt(+p.avgPrice,2)}</td>
        <td class="last">â€”</td>
        <td class="pl">â€”</td>
        <td class="pct">â€”</td>
      `;
      tbody.appendChild(tr);
      if (p.tvSymbol) addMini(p.tvSymbol);
    });
  }

  async function refresh(){
    const key=(keyIn&&keyIn.value)||'';
    if(!key){ if(status) status.textContent='Enter API key then Refresh Prices.'; return; }
    let i=0;
    for(const p of POS){
      i++; if(status) status.textContent=`Quote ${i}/${POS.length}â€¦`;
      let last=NaN;
      if (p.assetType==='option' && p.occId) last=await fetchOpt(p.occId,key,date);
      else if (p.assetType==='stock' && p.quoteSymbol) last=await fetchStock(p.quoteSymbol,key);
      const tr=tbody.children[i-1]; if (!tr) continue;
      if (Number.isFinite(last)){
        tr.querySelector('.last').textContent=fmt(last,2);
        const mult=Number(p.multiplier|| (p.assetType==='option'?100:1)), pl = (last-Number(p.avgPrice))*Number(p.qty)*mult;
        tr.querySelector('.pl').textContent=money(pl);
        tr.querySelector('.pl').classList.remove('pos','neg'); tr.querySelector('.pl').classList.add(pl>=0?'pos':'neg');
        const pct = (Number(p.avgPrice)>0? ((last/Number(p.avgPrice))-1)*100 : NaN);
        tr.querySelector('.pct').textContent=Number.isFinite(pct)?pct.toFixed(2)+'%':'â€”';
      }
      await new Promise(res=>setTimeout(res,1100));
    }
    if (status) status.textContent='Completed.';
  }

  function applyJSON(m){
    try{
      const src = (m&&m.F1&&Array.isArray(m.F1.openPositions)) ? m.F1.openPositions : (m&&m.openPositions||[]);
      const tvMap = m.tvSymbols || (m.F1&&m.F1.tvSymbols) || {};
      POS = src.map(x=>({
        symbol: x.symbol,
        assetType: x.assetType || (x.occId?'option':'stock'),
        qty: +x.qty, avgPrice:+x.avgPrice, multiplier:+(x.multiplier||1),
        tvSymbol: x.tvSymbol || tvMap[x.symbol] || '',
        quoteSymbol: x.quoteSymbol, underlyingTicker: x.underlyingTicker, occId: x.occId
      }));
      logd('No. of cars:', POS.length);
      if (minis) if (minis) minis.innerHTML='';
      renderTable();
    }catch(e){ logd('applyJSON error', e.message); if(status) status.textContent='JSON error: '+e.message; }
  }

  if (btnPick) btnPick.addEventListener('click', ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
    inp.onchange=()=>{ const f=inp.files&&inp.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(String(r.result).replace(/\\b-?Infinity\\b/g,'null').replace(/\\bNaN\\b/g,'null')); applyJSON(j);}catch(e){ alert('Invalid JSON: '+e.message);} };
      r.readAsText(f);
    };
    inp.click();
  });
  if (btnRefresh) btnRefresh.addEventListener('click', refresh);

  // Wire to your Dashboard JSON flow
  window.addEventListener('metrics-json-loaded', e=>{ if (e && e.detail) applyJSON(e.detail); });
  try{
    var _m = window.METRICS;
    Object.defineProperty(window,'METRICS',{configurable:true,get(){return _m;},set(v){_m=v; applyJSON(v);}});
    if (_m) applyJSON(_m);
  }catch(e){}

  // initial empty
  renderTable();
})();
</script>
<!-- ===== /F1 Live â€” Open Positions (Recovery-Spliced) ===== -->
</div>
</div>
<!-- Podium Page -->
<div class="page-content" id="podium-page" style="display: none;">
<div class="main-container">
<!-- Base Podium -->
<div class="podium-container" id="base-podium">
<div class="podium-title">
<h1>F1 Championship Podium</h1>
</div>
<div class="podium-stage">
<!-- Silver (P2) -->
<div class="podium-position silver">
<div class="plinth silver-plinth">
<img alt="2nd Place" class="trophy-icon" onerror="this.style.display='none'" src="Images/Second_Position.png"/>
</div>
<div class="position-content">
<div class="car-name">BOSS Income</div>
<div class="driver-name">Aggressive</div>
<div class="points-badge">52</div>
<div class="achievements">
<span class="achievement-badge">🏆 0</span>
<span class="achievement-badge">⚡ 2</span>
</div>
</div>
</div>
<!-- Gold (P1) -->
<div class="podium-position gold">
<div class="plinth gold-plinth">
<img alt="Champion" class="trophy-icon" onerror="this.style.display='none'" src="Images/Champion.png"/>
</div>
<div class="position-content">
<div class="car-name">BPS</div>
<div class="driver-name">Conservative</div>
<div class="points-badge">62</div>
<div class="achievements">
<span class="achievement-badge">🏆 0</span>
<span class="achievement-badge">⚡ 1</span>
</div>
</div>
</div>
<!-- Bronze (P3) -->
<div class="podium-position bronze">
<div class="plinth bronze-plinth">
<img alt="3rd Place" class="trophy-icon" onerror="this.style.display='none'" src="Images/Third_Position.png"/>
</div>
<div class="position-content">
<div class="car-name">LROS</div>
<div class="driver-name">Moderate</div>
<div class="points-badge">52</div>
<div class="achievements">
<span class="achievement-badge">🏆 0</span>
<span class="achievement-badge">⚡ 2</span>
</div>
</div>
</div>
</div>
</div>
<!-- Driver's Standings Table -->
<div class="standings-section">
<h2 class="section-title">
<img alt="Racing Helmet" class="title-icon" onerror="this.style.display='none'" src="Images/Helmet.png"/>
          Championship Standings
          <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
<a class="upload-btn" href="Rule_Book.html" target="_blank">Rule Book</a>
<label class="upload-btn">
              Upload Standings
              <input accept=".csv" id="standings-upload" type="file"/>
</label>
</div>
</h2>
<div class="standings-table" id="standings-table">
<div class="table-header">
<div class="pos-col">Pos</div>
<div class="driver-col">Car</div>
<div class="team-col">Driver/Team</div>
<div class="points-col">Points</div>
<div class="wins-col">GRAND PRIX</div>
<div class="fastest-col">WIN RATE</div>
<div class="podium-col">CAGR</div>
<div class="sharpe-col">SHARPE</div>
<div class="mdd-col">MDD</div>
</div>
<div class="table-row gold-row">
<div class="pos-col">1</div>
<div class="driver-col">Mercedes W16</div>
<div class="team-col">Conservative</div>
<div class="points-col">61</div>
<div class="wins-col">1</div>
<div class="fastest-col">79%</div>
<div class="podium-col">18.4%</div>
<div class="sharpe-col">2.15</div>
<div class="mdd-col">-8.5%</div>
</div>
<div class="table-row silver-row">
<div class="pos-col">2</div>
<div class="driver-col">Ferrari SF-24</div>
<div class="team-col">Aggressive</div>
<div class="points-col">52</div>
<div class="wins-col">2</div>
<div class="fastest-col">65%</div>
<div class="podium-col">15.2%</div>
<div class="sharpe-col">1.98</div>
<div class="mdd-col">-11.2%</div>
</div>
<div class="table-row bronze-row">
<div class="pos-col">3</div>
<div class="driver-col">McLaren MCL38</div>
<div class="team-col">Moderate</div>
<div class="points-col">52</div>
<div class="wins-col">2</div>
<div class="fastest-col">71%</div>
<div class="podium-col">16.8%</div>
<div class="sharpe-col">2.05</div>
<div class="mdd-col">-9.1%</div>
</div>
<div class="table-row">
<div class="pos-col">4</div>
<div class="driver-col">Red Bull RB21</div>
<div class="team-col">Aggressive</div>
<div class="points-col">33</div>
<div class="wins-col">0</div>
<div class="fastest-col">45%</div>
<div class="podium-col">11.0%</div>
<div class="sharpe-col">1.50</div>
<div class="mdd-col">-15.4%</div>
</div>
<div class="table-row">
<div class="pos-col">5</div>
<div class="driver-col">Aston Martin AMR25</div>
<div class="team-col">Conservative</div>
<div class="points-col">30</div>
<div class="wins-col">0</div>
<div class="fastest-col">55%</div>
<div class="podium-col">12.5%</div>
<div class="sharpe-col">1.85</div>
<div class="mdd-col">-10.5%</div>
</div>
<div class="table-row">
<div class="pos-col">6</div>
<div class="driver-col">Alpine A525</div>
<div class="team-col">Aggressive</div>
<div class="points-col">19</div>
<div class="wins-col">0</div>
<div class="fastest-col">30%</div>
<div class="podium-col">8.1%</div>
<div class="sharpe-col">1.21</div>
<div class="mdd-col">-18.9%</div>
</div>
<div class="table-row">
<div class="pos-col">7</div>
<div class="driver-col">Williams FW47</div>
<div class="team-col">Aggressive</div>
<div class="points-col">18</div>
<div class="wins-col">0</div>
<div class="fastest-col">38%</div>
<div class="podium-col">9.3%</div>
<div class="sharpe-col">1.33</div>
<div class="mdd-col">-16.3%</div>
</div>
<div class="table-row">
<div class="pos-col">8</div>
<div class="driver-col">Sauber C45</div>
<div class="team-col">Aggressive</div>
<div class="points-col">12</div>
<div class="wins-col">0</div>
<div class="fastest-col">25%</div>
<div class="podium-col">6.5%</div>
<div class="sharpe-col">1.10</div>
<div class="mdd-col">-20.1%</div>
</div>
</div>
</div>
<!-- Room Section (Work in Progress) -->
<div class="room-section" id="room" style="margin-top:40px;">
<h2 class="section-title" style="display:flex; align-items:center;"><h2 class="section-title">
<img alt="" class="title-icon" onerror="this.style.display='none'" src="Images/room_icon.png"/>
    Debrief Room
  <button class="nav-btn" id="getInsightsBtn" style="margin-left:auto; font-size:14px; padding:4px 10px;">GET INSIGHTS</button></h2>
<div class="muted" id="debriefStatus" style="display:none; margin:6px 0 0 0;">âœ” Data ready for LLM</div>
<div class="chart-panel">
<section class="panel" id="debriefSection" style="margin-top:20px">
<h2 class="section-title"></h2>
<div class="muted" id="debrief"></div>
</section>
</div>
</h2></div>
</div>
<!-- Audio elements for the telemetry alerts -->
<audio id="cagr-audio" preload="auto" src="audio/Weak_CAGR_voice.mp3"></audio>
<audio id="mdd-audio" preload="auto" src="audio/High_MDD_voice.mp3"></audio>
<audio id="sharpe-audio" preload="auto" src="audio/Low_Sharpe_voice.mp3"></audio>
<audio id="pf-audio" preload="auto" src="audio/Low_PF_voice.mp3"></audio>
<input accept=".csv" id="csvInput" style="display:none" type="file"/>
<div aria-labelledby="kmTitle" aria-modal="true" class="f1-modal-overlay" id="keyModal" role="dialog" style="display:none;"><div class="f1-modal-box">
<div class="modal-card">
<h3 id="kmTitle">Use Key to unlock debrief room</h3>
<p class="muted" style="margin-top:-4px"><code>sk-...</code>Hint: API key</p>
<label></label>
<input id="apiKeyField" placeholder="sk-..." type="password"/>
<div class="modal-actions">
<button class="btn ghost" id="kmCancel" type="button">Cancel</button>
<button class="btn" id="kmContinue" type="button">Continue</button>
</div></div>
</div>
</div>
<script>
// --- START: METRICS INSPECTOR CALCULATION ENGINE ---
function parseMoney(v){ if(v==null) return 0; var s=String(v).trim(); if(!s) return 0; var neg=/^\(.*\)$/.test(s); if(neg) s=s.replace(/^\(|\)$/g,''); s=s.replace(/,/g,'').replace(/[^\d.\-]+/g,''); var x=parseFloat(s); if(!isFinite(x)) x=0; return neg? -Math.abs(x): x; }
function parseNum(v){ if(v==null) return null; var s=String(v).trim(); if(!s) return null; s=s.replace(/,/g,''); var x=parseFloat(s); return isFinite(x)? x : null; }
function findFieldCI(fields, target){ var t=target.toLowerCase(); for(var i=0;i<fields.length;i++){ if(String(fields[i]).toLowerCase()===t) return fields[i]; } return null; }
function nameGuess(fields){ var lower=fields.map(function(c){return String(c).toLowerCase();}); function pick(names){ for(var i=0;i<names.length;i++){ var n=names[i]; var idx=lower.indexOf(String(n).toLowerCase()); if(idx!==-1) return fields[idx]; } return names[0]; } return { date:pick(['Date']), id:pick(['ID']), underlying:pick(['UNDERLYING_TICKER','UNDERLYING_RAW']), net:pick(['Net Amount (S$) (Fuel)','Net Amount (S$)','Net Amount']), status:pick(['Status']), qty:pick(['Quantity']), equity: findFieldCI(fields,'PORTFOLIO_EQUITY'), o: findFieldCI(fields,'OPEN')||findFieldCI(fields,'Open'), h: findFieldCI(fields,'HIGH')||findFieldCI(fields,'High'), l: findFieldCI(fields,'LOW')||findFieldCI(fields,'Low'), c: findFieldCI(fields,'CLOSE')||findFieldCI(fields,'Close'), strategy: findFieldCI(fields,'Strategy (Car)')||findFieldCI(fields,'Strategy') }; }

// === Open-by-ID reconstruction helpers (shared) ===
function __computeOpenById_fromParsedAndRaw(parsed, rows, fields){
  function findFieldCI(arr, target){ var t = String(target).toLowerCase(); for (var i=0;i<arr.length;i++){ if (String(arr[i]).toLowerCase()===t) return arr[i]; } return null; }
  var typeCol = findFieldCI(fields, 'Type') || findFieldCI(fields, 'Side') || findFieldCI(fields, 'Action') || findFieldCI(fields, 'Buy/Sell') || findFieldCI(fields, 'Direction');
  var statusOpen = function(s){ return (s||'').toString().trim().toLowerCase() === 'open'; };
  function toSigned(qty, rawSide){
    var q = (qty==null || qty==='') ? 0 : (function(v){ var s=String(v).replace(/,/g,''); var x=parseFloat(s); return isFinite(x)? x:0; })(qty);
    var side = (rawSide==null? '' : String(rawSide)).trim().toLowerCase();
    var isSell = /^(sell|short|sell to close|stc|s|sl)$/.test(side);
    return isSell ? -Math.abs(q) : Math.abs(q);
  }
  var byId = new Map();
  for (var idx=0; idx<parsed.length; idx++){
    var p = parsed[idx];
    var dateOk = p && p.date instanceof Date && isFinite(+p.date);
    if (!dateOk) continue;
    var id = (p.id!=null && p.id!=='') ? String(p.id) : String(p.i);
    if (!byId.has(id)) byId.set(id, {legs:[], lastStatus:null, lastDate:null});
    var bucket = byId.get(id);
    var rawSide = typeCol ? (rows[p.i] ? rows[p.i][typeCol] : null) : null;
    var signedQty = toSigned(p.qty, rawSide);
    var status = (p.status==null? '' : String(p.status)).trim();
    bucket.legs.push({date:p.date, status:status, qty:signedQty});
    if (status){
      if (!bucket.lastDate || p.date > bucket.lastDate){ bucket.lastDate = p.date; bucket.lastStatus = status; }
    }
  }
  var openIdSet = new Set();
  byId.forEach(function(obj, id){
    var netQty = 0;
    for (var k=0; k<obj.legs.length; k++){ var q = obj.legs[k].qty; if (!isFinite(q)) q=0; netQty += q; }
    var lastIsOpen = statusOpen(obj.lastStatus);
    var isOpen = lastIsOpen || Math.abs(netQty) > 1e-12;
    if (isOpen) openIdSet.add(id);
  });
  var openRows=0, closedRows=0;
  for (var j=0; j<parsed.length; j++){
    var p = parsed[j];
    var dateOk = p && p.date instanceof Date && isFinite(+p.date);
    if (!dateOk) continue;
    var id = (p.id!=null && p.id!=='') ? String(p.id) : String(p.i);
    if (openIdSet.has(id)) openRows++; else closedRows++;
  }
  return { openIdSet: openIdSet, openRows: openRows, closedRows: closedRows };
}
function summarizeRows(rows, fields, starting, cashColHint){
    var f=nameGuess(fields);
    if(cashColHint){ var idx= -1; for(var i=0; i<fields.length;i++){ if(String(fields[i]).toLowerCase()===String(cashColHint).toLowerCase()){ idx=i; break; } } if(idx!==-1) f.net=fields[idx]; }
    var out={ meta:{rowCount:rows.length, startingCapital:Number(starting), equitySource: f.equity? 'CSV column PORTFOLIO_EQUITY':'derived from net closed'}, columnsDetected:f, counts:{open:0,closed:0}, totals:{netClosedSgd:0, netAllSgd:0}, byUnderlying:{}, byEntryDOW:{}, equityCurveDaily:[], tripStats:{}, pnlByType:{}, pnlByUnderlying:{}, strategyStats:{}, marketContext:{} };
    function toDate(x){ var d=new Date(x); return isFinite(+d)? d:null; }

    var parsed=[]; for(var i=0;i<rows.length;i++){ var r=rows[i]; var date=r[f.date]? toDate(r[f.date]):null; var status=(r[f.status]||'').toString().trim().toLowerCase(); var id=(r[f.id]||'').toString(); var und=(r[f.underlying]||r['UNDERLYING_TICKER']||r['UNDERLYING_RAW']||'').toString(); var net=parseMoney(r[f.net]); var qty=parseFloat(String(r[f.qty]==null?'0':r[f.qty]).replace(/,/g,'')); var equityVal = f.equity!=null ? parseMoney(r[f.equity]) : null; var o=f.o? parseNum(r[f.o]) : null; var h=f.h? parseNum(r[f.h]) : null; var l=f.l? parseNum(r[f.l]) : null; var c=f.c? parseNum(r[f.c]) : null; var strat = f.strategy ? (r[f.strategy]||'').toString() : ''; if(date && !isNaN(+date)) parsed.push({i:i,date:date,status:status,id:id,und:und,net:net,qty:qty,equityVal:equityVal,o:o,h:h,l:l,c:c,strategy:strat}); }

    for(var j=0;j<parsed.length;j++){ var p=parsed[j]; if(p.status==='open') out.counts.open++; else out.counts.closed++; out.totals.netAllSgd+=p.net; if(p.status!=='open') out.totals.netClosedSgd+=p.net; if(!out.byUnderlying[p.und]) out.byUnderlying[p.und]=0; out.byUnderlying[p.und]+=p.net; }

    if (f.equity){
      var eqByDay=new Map();
      for(var k=0;k<parsed.length;k++){ var pp=parsed[k]; if(pp.equityVal!=null && isFinite(pp.equityVal)) { var key=pp.date.toISOString().slice(0,10); eqByDay.set(key, pp.equityVal); } }
      var arr = Array.from(eqByDay.entries()).sort(function(a,b){ return a[0].localeCompare(b[0]); }).map(function(e){ return {date:e[0], equity:e[1]}; });
      out.equityCurveDaily = arr;
      if(arr.length){
        var startEq = Number(starting); var endEq = arr[arr.length-1].equity; var startDate = arr[0].date; var endDate = arr[arr.length-1].date; var days = Math.max((new Date(endDate)-new Date(startDate))/(1000*60*60*24),0); var totalRet = startEq? (endEq/startEq - 1):0; var peak=-Infinity, maxDD=0, ddStart=null, ddEnd=null, peakDate=null;
        for (var a=0; a<arr.length; a++){ var pt=arr[a]; if (pt.equity > peak){ peak = pt.equity; peakDate = pt.date; } var dd = pt.equity/peak - 1; if (dd < maxDD){ maxDD = dd; ddEnd = pt.date; ddStart = peakDate; } }
        out.performance={startDate:startDate, endDate:endDate, daysSpan: Math.round(days), startEquity:startEq, endEquity:endEq, totalReturn:totalRet, cagr:(days>0 && startEq>0)? (Math.pow(endEq/startEq,365.25/days)-1):0, maxDD:maxDD, ddStart:ddStart, ddEnd:ddEnd};
      }
    } else {
      var byDay=new Map(); var sorted=parsed.slice().sort(function(a,b){ return (a.date-b.date); }); var eq=Number(starting);
      for(var s=0;s<sorted.length;s++){ var sp=sorted[s]; if(sp.status!=='open') eq+=sp.net; var key=sp.date.toISOString().slice(0,10); byDay.set(key,eq); }
      var arr2 = Array.from(byDay.entries()).map(function(e){ return {date:e[0], equity:e[1]}; }); out.equityCurveDaily = arr2;
      if(arr2.length){
        var startEq2 = Number(starting); var endEq2 = arr2[arr2.length-1].equity; var startDate2 = arr2[0].date; var endDate2 = arr2[arr2.length-1].date; var days2 = Math.max((new Date(endDate2)-new Date(startDate2))/(1000*60*60*24),0); var totalRet2 = startEq2? (endEq2/startEq2 - 1):0; var peak2=-Infinity, maxDD2=0, ddStart2=null, ddEnd2=null, peakDate2=null;
        for (var b=0; b<arr2.length; b++){ var pt2=arr2[b]; if (pt2.equity > peak2){ peak2 = pt2.equity; peakDate2 = pt2.date; } var dd2 = pt2.equity/peak2 - 1; if (dd2 < maxDD2){ maxDD2 = dd2; ddEnd2 = pt2.date; ddStart2 = peakDate2; } }
        out.performance={startDate:startDate2, endDate:endDate2, daysSpan: Math.round(days2), startEquity:startEq2, endEquity:endEq2, totalReturn:totalRet2, cagr:(days2>0 && startEq2>0)? (Math.pow(endEq2/startEq2,365.25/days2)-1):0, maxDD:maxDD2, ddStart:ddStart2, ddEnd:ddEnd2};
      }
    }

    var closed = parsed.filter(function(p){ return p.status==='closed' && isFinite(p.equityVal); });
    closed.sort(function(a,b){ return (a.date - b.date) || (a.i - b.i); });
    var rets=[]; for(var r=1;r<closed.length;r++){ var prev=closed[r-1].equityVal; var cur=closed[r].equityVal; if(prev>0 && isFinite(cur)){ var rr = (cur/prev)-1; if(isFinite(rr)) rets.push(rr); } }
    var mean=0, sd=0; if(rets.length){ var sum=0; for(var m=0;m<rets.length;m++) sum+=rets[m]; mean=sum/rets.length; if(rets.length>1){ var v=0; for(var n=0;n<rets.length;n++){ var d=rets[n]-mean; v+=d*d; } v = v/(rets.length-1); sd = Math.sqrt(v); } }
    var volAnn_event = sd * Math.sqrt(252); var sharpe_event = volAnn_event>0? (mean*252)/volAnn_event:0;
    if(!out.performance) out.performance={};
    out.performance.meanReturn_event = mean; out.performance.stdevReturn_event = sd; out.performance.volAnn_event = volAnn_event; out.performance.sharpe_event = sharpe_event; out.performance.eventReturnsUsed = rets.length;
    out.performance.annualizationBasis = { return_frequency: 'event', status_filter: 'closed', scaling: 'sqrt252', trading_days_per_year: 252 };

    var closedRowsForTrips = parsed.filter(function(p){ return p.status === 'closed'; });
    var byId = new Map();
    for (var bi=0; bi<closedRowsForTrips.length; bi++){ var pr = closedRowsForTrips[bi]; if (!byId.has(pr.id)) byId.set(pr.id, []); byId.get(pr.id).push(pr); }
    var trips = [];
    byId.forEach(function(legs, key){
      legs.sort(function(a,b){ return a.date - b.date; });
      var finalPos = 0; for (var iL=0; iL<legs.length; iL++){ var qv = (isFinite(legs[iL].qty) ? legs[iL].qty : 0); finalPos += qv; }
      var isClosed = Math.abs(finalPos) < 1e-9; if (!isClosed) return;
      var pnl = 0; for (var jL=0; jL<legs.length; jL++){ pnl += legs[jL].net; }
      var start = legs[0].date; var end = legs[legs.length-1].date;
      var q0 = 0; for (var u=0; u<legs.length; u++){ if (legs[u].qty!==0){ q0 = legs[u].qty; break; } }
      var dir = q0>0 ? 'long' : (q0<0 ? 'short' : 'unknown');
      var und = legs[legs.length-1].und || '';
      var stratVals = legs.map(function(x){ return (x.strategy||'').trim(); }).filter(function(s){ return s; });
      var strat = '(blank)'; if (stratVals.length){ strat = modeString(stratVals); }
      var holdingDays = Math.max((end - start) / (1000*60*60*24), 0);
      trips.push({ id:key, underlying:und, strategy:strat, direction:dir, startDate:start.toISOString().slice(0,10), endDate:end.toISOString().slice(0,10), holdingDays:holdingDays, legs:legs.length, pnl:pnl });
    });

    var wins=0, losses=0, sumPos=0, sumNeg=0; for(var t=0;t<trips.length;t++){ var T=trips[t]; if(T.pnl>0){ wins++; sumPos+=T.pnl; } else if(T.pnl<0){ losses++; sumNeg+=T.pnl; } }
    var n=trips.length; var avgWin=wins? (sumPos/wins):0; var avgLoss=losses? (sumNeg/losses):0; var payoff=(wins&&losses&&avgLoss!==0)? (avgWin/Math.abs(avgLoss)):0; var profitFactor=(wins&&losses)? (sumPos/Math.abs(sumNeg)):0; var exp = n? ((sumPos+sumNeg)/n):0;
    var holds = trips.map(function(t){return t.holdingDays;}).sort(function(a,b){return a-b;});
    var medianHold = trueMedian(holds);
    out.tripStats={n:n,wins:wins,losses:losses,winRate:n? wins/n:0,avgWin:avgWin,avgLoss:avgLoss,payoff:payoff,profitFactor:profitFactor,expectancy:exp,medianHold:medianHold};

    var byStrat = new Map();
    for (var si=0; si<trips.length; si++){
      var tr = trips[si]; var keyS = tr.strategy || '(blank)'; if(!byStrat.has(keyS)) byStrat.set(keyS, { n:0, wins:0, losses:0, sumPos:0, sumNeg:0, sumPnl:0, holds:[] });
      var agg = byStrat.get(keyS); agg.n += 1; agg.sumPnl += tr.pnl; agg.holds.push(tr.holdingDays); if (tr.pnl>0){ agg.wins++; agg.sumPos+=tr.pnl; } else if (tr.pnl<0){ agg.losses++; agg.sumNeg+=tr.pnl; }
    }
    var stratStats = {};
    byStrat.forEach(function(agg, name){ var avgW = agg.wins? agg.sumPos/agg.wins : 0; var avgL = agg.losses? agg.sumNeg/agg.losses : 0; var payoffS = (agg.wins && agg.losses && avgL!==0)? (avgW/Math.abs(avgL)) : 0; var pfS = (agg.wins && agg.losses)? (agg.sumPos/Math.abs(sumNeg)) : 0; var expS = agg.n? (agg.sumPnl/agg.n) : 0; var medH = trueMedian(agg.holds.slice().sort(function(a,b){return a-b;})); stratStats[name] = { n: agg.n, winRate: (agg.n? agg.wins/agg.n : 0), avgWin: avgW, avgLoss: avgL, payoff: payoffS, profitFactor: pfS, expectancy: expS, medianHold: medH, totalPnL: agg.sumPnl }; });
    out.strategyStats = stratStats;

    var byUnd={}; for(var tu=0;tu<trips.length;tu++){ var trp=trips[tu]; byUnd[trp.underlying]=(byUnd[trp.underlying]||0)+trp.pnl; } out.pnlByUnderlying=byUnd;
    out.topUnderlying=Object.keys(byUnd).map(function(k){ return {underlying:k||'(blank)',pnl:byUnd[k]}; }).sort(function(a,b){ return Math.abs(b.pnl)-Math.abs(a.pnl); }).slice(0,10);

    var byEntryDOW = {};
    for (var x=0; x<trips.length; x++){
      var dow = new Date(trips[x].startDate).toLocaleDateString(undefined,{weekday:'long'});
      if (!byEntryDOW[dow]) byEntryDOW[dow] = { trips: 0, pnl: 0 };
      byEntryDOW[dow].trips += 1; byEntryDOW[dow].pnl += trips[x].pnl;
    }
    out.byEntryDOW = byEntryDOW;

    var rowsWith = 0, sumRangePct=0, sumCloseBiasPct=0;
    for (var ci=0; ci<closedRowsForTrips.length; ci++){
      var rr = closedRowsForTrips[ci];
      if (isFinite(rr.o) && isFinite(rr.h) && isFinite(rr.l) && isFinite(rr.c) && rr.o>0){
        rowsWith += 1; sumRangePct += ( (rr.h - rr.l) / rr.o ); sumCloseBiasPct += ( (rr.c - rr.o) / rr.o );
      }
    }
    out.marketContext = { rowsWithOHLC: rowsWith, avgRangePct: rowsWith? (sumRangePct/rowsWith):0, avgCloseBiasPct: rowsWith? (sumCloseBiasPct/rowsWith):0 };
    
    // === Override counts using Open-by-ID reconstruction ===
    try{
      var __cmp = __computeOpenById_fromParsedAndRaw(parsed, rows, fields);
      if (!out.counts) out.counts = {};
      out.counts.open    = __cmp.openIdSet.size;     // unique open positions by ID
      out.counts.openIds = __cmp.openIdSet.size;     // alias
      out.counts.openRows = __cmp.openRows;          // legs in open IDs
      out.counts.closed  = __cmp.closedRows;
    }catch(__e){ /* no-op */ }
return out;
    function trueMedian(arr){ if(!arr || !arr.length) return 0; var n=arr.length; if(n%2===1) return arr[(n-1)/2]; return (arr[n/2 - 1] + arr[n/2]) / 2; }
    function modeString(a){ var m=new Map(); var best=null, bestC=-1; for(var i=0;i<a.length;i++){ var v=a[i]; var c=(m.get(v)||0)+1; m.set(v,c); if(c>bestC){ best=v; bestC=c; } } return best || a[a.length-1] || ''; }
}
// --- END: METRICS INSPECTOR CALCULATION ENGINE ---

document.addEventListener("DOMContentLoaded", function(){
  console.log("[F1] Controller init");

  var btnGetData = document.getElementById('ai-insights-btn');
  var btnGetInsights = document.getElementById('getInsightsBtn');
  var csvInput = document.getElementById('csvInput');
  var debriefStatus = document.getElementById('debriefStatus');
  var debriefEl = document.getElementById('debrief');
  var modal = document.getElementById('keyModal');
  var apiInput = modal ? (modal.querySelector('#apiKeyField') || modal.querySelector('input[type=\"password\"]') || modal.querySelector('input[type=\"text\"]')) : null;

  function enable(b, name){
    if (!b) { console.warn("[F1] Missing element:", name); return; }
    b.disabled = false;
    b.removeAttribute('aria-disabled');
    b.classList.remove('disabled');
    if (b.style){ b.style.pointerEvents=''; b.style.opacity=''; }
  }
  function show(el){ if(el){ el.style.display = 'flex'; } }
  function hide(el){ if(el){ el.style.display = 'none'; } }

  enable(btnGetData, 'GET DATA');
  enable(btnGetInsights, 'GET INSIGHTS');

  // GET DATA: choose CSV -> parse -> build summary (silent)
  if (btnGetData && csvInput){
    btnGetData.addEventListener('click', function(){
      console.log("[F1] GET DATA clicked");
      try { csvInput.value=''; } catch(e){}
      csvInput.click();
    });
      
    // REVISED: This now calls the powerful calculation engine
    
csvInput.addEventListener('change', function(){
      var file = csvInput.files && csvInput.files[0];
      if (!file) {
        console.warn("[F1] No file selected");
        return;
      }
      if (debriefStatus) {
          debriefStatus.style.display = 'block';
          debriefStatus.textContent = 'Loading ' + file.name + '...';
      }

      // --- NEW: If JSON selected, parse and apply directly ---
      if (/\.(json)$/i.test(file.name)) {
        var reader = new FileReader();
        reader.onload = function(ev){
          try{
            var m = JSON.parse(ev.target.result);
            applyMetricsAndSummary(m);
          }catch(e){
            console.error("[F1] JSON parse error:", e);
            alert("Invalid metrics JSON: " + e.message);
            if (debriefStatus) debriefStatus.textContent = 'Invalid metrics JSON';
          }
        };
        reader.onerror = function(){ alert("Failed to read JSON file."); };
        reader.readAsText(file);
        return;
      }

      // --- Fallback: CSV path (existing flow) ---
      if (!window.Papa){
        alert("CSV parser (PapaParse) is not loaded on this page.");
        return;
      }
      
      console.log("[F1] Parsing CSV for full analysis:", file.name);
      if (debriefStatus) {
          debriefStatus.style.display = 'block';
          debriefStatus.textContent = 'Parsing ' + file.name + '...';
      }

      Papa.parse(file, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function(results){
          try {
            var rows = results.data || [];
            var fields = results.meta && results.meta.fields || Object.keys(rows[0]||{});
            
            if (debriefStatus) debriefStatus.textContent = 'Parsed ' + rows.length + ' rows. Computing detailed summary...';

            var startingCapital = 10000; 

            // Call the powerful calculation engine!
            var detailedSummary = summarizeRows(rows, fields, startingCapital, '');
            
            // --- Map summary to dashboard metrics and update the UI ---
            const metricsForDashboard = {
                CAGR: detailedSummary.performance.cagr,
                Sharpe: detailedSummary.performance.sharpe_event,
                ROI: detailedSummary.performance.totalReturn,
                MaxDrawdown: detailedSummary.performance.maxDD,
                WinRate: detailedSummary.tripStats.winRate,
                ProfitFactor: detailedSummary.tripStats.profitFactor,
                OpenTrades: detailedSummary.counts.open
            };
            updateDashboardMetrics(metricsForDashboard);
            
            // Build summary for LLM
            var summaryForLlm = {
                meta: detailedSummary.meta,
                counts: detailedSummary.counts,
                totals: detailedSummary.totals,
                performance: detailedSummary.performance,
                topUnderlying: detailedSummary.topUnderlying,
                pnlByUnderlying: detailedSummary.pnlByUnderlying,
                byEntryDOW: detailedSummary.byEntryDOW,
                tripStats: detailedSummary.tripStats,
                strategyStats: detailedSummary.strategyStats,
                marketContext: detailedSummary.marketContext,
                equityCurvePreview: { 
                    head: (detailedSummary.equityCurveDaily || []).slice(0,3),
                    tail: (detailedSummary.equityCurveDaily || []).slice(-3)
                }
            };

            window.DEBRIEF_SUMMARY = summaryForLlm;
            console.log("[F1] Detailed summary ready:", summaryForLlm);
            if (debriefStatus){
              debriefStatus.textContent = 'Ready for analysis.';
            }
          } catch(e){
            console.error("[F1] Detailed summary build error:", e);
            if (debriefStatus) debriefStatus.textContent = 'Error: ' + e.message;
            alert("Failed to build detailed summary: " + e.message);
          }
        },
        error: function(err){
          console.error("[F1] CSV parse error:", err);
          if (debriefStatus) debriefStatus.textContent = 'Error: ' + err;
          alert("CSV parse error: " + err);
        }
      });
    });
  }


  // GET INSIGHTS: require summary, open modal
  if (btnGetInsights){
    btnGetInsights.addEventListener('click', function(){
      console.log("[F1] GET INSIGHTS clicked");
      if (!window.DEBRIEF_SUMMARY){
        alert("Please click GET DATA first to select a CSV and build the summary.");
        return;
      }
      show(modal);
      if (apiInput){ try { apiInput.focus(); } catch(e){} }
    });
  }

  // Modal: Cancel/Continue (overlay click disabled)
  if (modal){
    modal.addEventListener('click', function(ev){
      var btn = ev.target && ev.target.closest('button');
      if (!btn) return; // Ignore overlay and non-button clicks
      var label = (btn.textContent || "").trim().toLowerCase();
      var isCancel = btn.id === 'kmCancel' || btn.classList.contains('cancel') || label === 'cancel';
      var isContinue = btn.id === 'kmContinue' || btn.classList.contains('continue') || label === 'continue';
      if (isCancel){
        ev.preventDefault(); hide(modal);
        console.log("[F1] Modal cancelled");
      } else if (isContinue){
        ev.preventDefault();
        var key = apiInput ? apiInput.value : "";
        window.OPENAI_API_KEY = key;
        console.log("[F1] Modal continue: starting LLM analysis");
        try {
          if (window.runLLMAnalysis) {
            window.runLLMAnalysis(window.DEBRIEF_SUMMARY, key);
          } else {
            console.warn("[F1] runLLMAnalysis not defined");
          }
        } catch(e){
          console.error("[F1] runLLMAnalysis error:", e);
        }
        hide(modal);
      }
    });
  }
});
</script>
<script>
window.runLLMAnalysis = function(summary, apiKey){
  try {
    if (typeof window.__normalizeDebriefSummary === 'function') {
      summary = window.__normalizeDebriefSummary(summary);
    } else {
      // minimal normalization
      if (summary && summary.meta) {
        if (summary.meta.rowCount == null) {
          var rc = null;
          if (typeof summary.meta.rows === 'number') rc = summary.meta.rows;
          if (rc == null && summary.counts && typeof summary.counts.openRows==='number' && typeof summary.counts.closedRows==='number') {
            rc = summary.counts.openRows + summary.counts.closedRows;
          }
          if (rc == null && summary.tripStats && typeof summary.tripStats.n === 'number') rc = summary.tripStats.n;
          summary.meta.rowCount = rc != null ? rc : 0;
        }
      }
    }
  } catch(_e) {}

  var out = document.getElementById('debrief');
  if (!out) return;
  if (!summary || !summary.meta || !summary.meta.rowCount){
    out.innerHTML = '<div class="muted">No summary available. Please click GET DATA first.</div>';
    return;
  }
  if (!apiKey || !apiKey.trim()){
    out.innerHTML = '<div class="muted">Missing API key. Please click GET INSIGHTS and enter a valid key.</div>';
    return;
  }

  // Show progress
  out.innerHTML = '<h3>Portfolio Analysis Report</h3><div class="muted">Running analysis</div>';

  // --- Construct the detailed user prompt from the summary data ---

  // --- Payload size guard: reduce bulky arrays if needed ---
  (function enforcePayloadBudget(){
    try {
      var approx = JSON.stringify(summary).length;
      if (approx > 100000) {
        if (Array.isArray(summary.topUnderlying)) summary.topUnderlying = summary.topUnderlying.slice(0, 10);
        if (Array.isArray(summary.pnlByUnderlying)) summary.pnlByUnderlying = summary.pnlByUnderlying.slice(0, 20);
        if (Array.isArray(summary.strategyStats)) summary.strategyStats = summary.strategyStats.slice(0, 20);
        if (Array.isArray(summary.byEntryDOW)) summary.byEntryDOW = summary.byEntryDOW.slice(0, 7);
        if (summary.extras && Array.isArray(summary.extras.monthlyTable)) summary.extras.monthlyTable = summary.extras.monthlyTable.slice(-24);
        if (summary.equityCurvePreview && Array.isArray(summary.equityCurvePreview.head)) summary.equityCurvePreview.head = summary.equityCurvePreview.head.slice(0,3);
        if (summary.equityCurvePreview && Array.isArray(summary.equityCurvePreview.tail)) summary.equityCurvePreview.tail = summary.equityCurvePreview.tail.slice(-3);
        console.log("[F1] Payload trimmed to fit budget. Size now ~", JSON.stringify(summary).length);
      }
    } catch(e) {
      console.warn("[F1] Payload budget check failed:", e);
    }
  })();

  const perf = summary.performance || {};
  const trips = summary.tripStats || {};
  const counts = summary.counts || {};
  const meta = summary.meta || {};

  const userPromptContent = `Context

You are given a client-side computed summary of my trading portfolio. Use only the provided data. Do not invent numbers.

Task

Produce a professional, portfolio-manager grade Performance Debrief â€” â€œRace Engineerâ€ Report in the same style and section order as below.
Tone & Persona

Encouraging, professional, F1 race-engineer analogies where helpful. Be concise and actionable.
Deliverable â€” Section Outline (use exact headings):

Executive Summary (Pit Wall View) â€“ 6â€“10 bullet insights: returns, Sharpe, drawdown, whatâ€™s driving P/L, key risks.
Quantitative Performance Review â€“ headline returns, event-level Sharpe (âˆš252), volatility, drawdown timing, holding period notes.
Strategy Effectiveness (Garage Breakdown) â€“ table-driven interpretation: which strategy types work/struggle; expectancy, PF, payoff drivers; sample-size caveats.
Concentration & Exposure (Track Map) â€“ top underlyings by P/L, factor/sector tilt, day-of-week/time clustering if any.
Open Positions â€“ Risk Readiness (Live Stint) â€“ identify unrealized drag, margin/collateral considerations, near-term catalysts, and immediate actions.
Risk Diagnostics (Safety Car Procedures) â€“ tail risks, gamma/vega heat, drawdown governance triggers.
Strategic Recommendations (Actionable Upgrades) â€“ entry filters, exits, sizing rails, event gating, diversification; bullet points with numeric guardrails.
Whatâ€™s Working / What Can Break / Opportunities â€“ three short bullets each.
Immediate Checklist (Before Next Stint) â€“ 5â€“7 concrete steps.
Final Word (Parc FermÃ©) â€“ brief wrap-up.
Rules & Conventions

Use currency symbol and units exactly as in the input (e.g., â€œUS$â€).
Treat â€œSharpeâ€ as event-level (closed-event returns, annualized by âˆš252).
Do not restate raw tables; interpret them.
Call out sample-size limitations.
If an accounting mismatch appears (e.g., Net All vs End Equity), flag it and propose reconciliation steps.
No code, no formulas, no images in the output.
Inputs (paste below each time):

Period & Capital: ${perf.startDate} â†’ ${perf.endDate}; Starting Capital US$${meta.startingCapital}.
Headline Metrics: Total Return: ${(perf.totalReturn * 100).toFixed(2)}%, CAGR: ${(perf.cagr * 100).toFixed(2)}%, Sharpe (event): ${perf.sharpe_event ? perf.sharpe_event.toFixed(2) : 'N/A'}, Volatility (ann, event): ${perf.volAnn_event ? (perf.volAnn_event * 100).toFixed(2) : 'N/A'}%, Max Drawdown: ${(perf.maxDD * 100).toFixed(2)}%, Median Hold (days): ${trips.medianHold ? trips.medianHold.toFixed(1) : 'N/A'}, Closed Rows: ${counts.closed}, Open Rows: ${counts.open}, Closed Trips: ${trips.n}, Win Rate: ${(trips.winRate * 100).toFixed(1)}%, Profit Factor: ${trips.profitFactor ? trips.profitFactor.toFixed(2) : 'N/A'}, Payoff Ratio: ${trips.payoff ? trips.payoff.toFixed(2) : 'N/A'}, Expectancy: ${trips.expectancy ? trips.expectancy.toFixed(2) : 'N/A'}.
By-Strategy Table (closed trips): ${JSON.stringify(summary.strategyStats, null, 2)}
Top Underlyings by |P/L|: ${JSON.stringify(summary.topUnderlying, null, 2)}
DOW or other slices (optional): ${JSON.stringify(summary.byEntryDOW, null, 2)}
Market Context from OHLC (closed rows): ${JSON.stringify(summary.marketContext, null, 2)}
Any notes on open positions / unrealized P/L: Unrealized P&L is not tracked in this summary. Open positions count: ${counts.open}.
Acceptance Criteria

Uses the exact section headings listed above.
Quantitative statements must be grounded in the provided inputs.
Includes explicit numeric guardrails in the Recommendations (e.g., IVR thresholds, delta bands, max-loss per trade, exposure caps).
Flags sample-size constraints and accounting mismatches when present.`;

  fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify({
      model: (document.getElementById("modelInput") && document.getElementById("modelInput").value) || "gpt-5.1",
      messages: [
        { role: "system",
          content: "You are 'GP', an expert F1 Race Engineer and world-class Portfolio Analyst. Use an encouraging, professional tone with F1 analogies. You are given a detailed, client-side computed summary of a trading portfolio. Your task is to provide a comprehensive, multi-faceted performance and risk analysis of the attached trading portfolio history. The report should be structured for a portfolio manager and go beyond simple profit/loss calculations. I need a deep, qualitative and quantitative assessment of strategy effectiveness, an analysis of holdings and concentration risk, a review of open positions, and a concluding section with actionable, strategic recommendations. The final output should be a professional-grade report that identifies key strengths, critical vulnerabilities, and clear opportunities for improvement."
        },
        { role: "user", content: userPromptContent }
      ]
    })
  })
  .then(function(r){
    if (!r.ok) {
      return r.text().then(function(t){
        var msg = 'HTTP ' + r.status + ' - ' + (r.statusText || '');
        try { var j = JSON.parse(t); if (j && j.error && j.error.message) msg += ' | ' + j.error.message; } catch(_) {}
        throw new Error(msg);
      });
    }
    return r.json();
  })
  .then(function(resp){
    try {
      var content = (resp && resp.choices && resp.choices[0] && resp.choices[0].message && resp.choices[0].message.content) || "";
      if (!content){
        out.innerHTML = '<div class="muted">No content returned from LLM. Check API key or model.</div>';
        return;
      }
      out.innerHTML = '<h3>Portfolio Analysis Report</h3><div style="white-space:pre-wrap; line-height:1.5; font-size:15px;">' + content + '</div>';
    } catch (e2){
      out.innerHTML = '<div class="muted">Response parse error: ' + (e2 && e2.message ? e2.message : e2) + '</div>';
    }
  })
  .catch(function(err){
    var hint = '';
    if (String(err).includes('Failed to fetch')) {
      hint = '<br><br><small>Hint: If a network/CORS error occurs, verify that your browser/network allows direct requests to api.openai.com from local files.</small>';
    }
    var extra = '<br><small>If opening this HTML directly from disk, browsers often block cross-origin requests. Serve via a local server (e.g., <code>python -m http.server 8000</code>) and open <code>http://localhost:8000</code>. Ensure the model name is valid and your API key has access.</small>';out.innerHTML = '<div class="muted">LLM request failed: ' + (err && err.message ? err.message : err) + '</div>' + hint + extra;
  });
};
</script>
<!-- Confirm Analysis Modal (F1 theme) -->
<div class="f1-modal-overlay" id="confirmModal" style="display:none;">
<div class="f1-modal-box">
<h3>Confirm Analysis</h3>
<p>Proceed to analyze with the prepared summary?</p>
<div class="btn-row" style="margin-top:12px;">
<button class="cancel" id="btnConfirmNo">No</button>
<button class="continue" id="btnConfirmYes">Yes</button>
</div>
</div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function(){
  var modal = document.getElementById('keyModal');
  var confirmModal = document.getElementById('confirmModal');
  var apiInput = modal ? (modal.querySelector('#apiKeyField') || modal.querySelector('input[type=\"password\"]') || modal.querySelector('input[type=\"text\"]')) : null;
  var btnYes = document.getElementById('btnConfirmYes');
  var btnNo = document.getElementById('btnConfirmNo');

  function show(el){ if(el){ el.style.display = 'flex'; } }
  function hide(el){ if(el){ el.style.display = 'none'; } }

  // Intercept "Continue" in API modal before other handlers (capture phase) and route to confirm modal
  if (modal){
    modal.addEventListener('click', function(ev){
      var btn = ev.target && ev.target.closest('button');
      if (!btn) return;
      var label = (btn.textContent || '').trim().toLowerCase();
      var isContinue = btn.id === 'kmContinue' || btn.classList.contains('continue') || label === 'continue';
      if (isContinue){
        ev.preventDefault();
        ev.stopPropagation();
        var key = apiInput ? apiInput.value : '';
        window.OPENAI_API_KEY = key;
        hide(modal);
        // Show confirmation modal
        show(confirmModal);
      }
    }, true); // capture = true
  }

  // Confirm modal buttons
  if (btnYes){
    btnYes.addEventListener('click', function(){
      hide(confirmModal);
      try {
        if (window.runLLMAnalysis) {
          window.runLLMAnalysis(window.DEBRIEF_SUMMARY, window.OPENAI_API_KEY || '');
        } else {
          console.warn('[F1] runLLMAnalysis not defined');
        }
      } catch(e){
        console.error('[F1] runLLMAnalysis error:', e);
      }
    });
  }
  if (btnNo){
    btnNo.addEventListener('click', function(){
      hide(confirmModal);
    });
  }
});
</script>
</div><script>
// --- Global Variables ---
let cagrGauge, sharpeGauge, volGauge;
let latestMetrics = null;
let telemetryQueue = []; 
let telemetryInterval = null;

// --- Champagne Celebration Effect Variables ---
let celebrationApp;
let celebrationParticles = [];
let celebrationBottle;
const celebrationGravity = 0.1;
let celebrationHue = 0;
let sprayInterval = null;

/**
 * Bottle Class for Champagne Effect
 */
class CelebrationBottle extends PIXI.Sprite {
    constructor() {
        const texture = PIXI.Texture.from('https://s3-us-west-2.amazonaws.com/s.cdpn.io/53148/champagne.png');
        super(texture);
        this.anchor.set(0.5, 0.15); // Anchor near the mouth
        this.width = 150;
        this.height = 380;
        this.x = window.innerWidth / 2; 
        this.y = window.innerHeight / 2; 
        this.rotation = -20 * (Math.PI / 180); 
        this.visible = false; // Hidden by default
    }
}

/**
 * Particle Class for Champagne Effect
 */
class CelebrationParticle {
    constructor() {
        this.radius = 3 + Math.random() * 4;
        this.graphics = new PIXI.Graphics();
        this.sprite = new PIXI.Sprite(celebrationApp.renderer.generateTexture(this.graphics));
        this.sprite.anchor.set(0.5);
        this.sprite.visible = false;
        celebrationApp.stage.addChild(this.sprite);
    }
    reset(x, y, color, angle) {
        this.graphics.clear();
        this.graphics.beginFill(Number(color));
        this.graphics.drawCircle(0, 0, this.radius);
        this.graphics.endFill();
        if (this.sprite.texture) this.sprite.texture.destroy(true);
        this.sprite.texture = celebrationApp.renderer.generateTexture(this.graphics);
        
        this.sprite.x = x;
        this.sprite.y = y;
        this.sprite.alpha = 0.8 + Math.random() * 0.2;
        this.sprite.visible = true;

        const sprayAngle = angle + (Math.random() - 0.5) * 0.8; // Wider spray
        const velocity = 15 + Math.random() * 10; // Stronger spray
        this.vx = Math.cos(sprayAngle) * velocity;
        this.vy = Math.sin(sprayAngle) * velocity;
    }
    update() {
        if (!this.sprite.visible) return;
        this.vy += celebrationGravity;
        this.sprite.x += this.vx;
        this.sprite.y += this.vy;
        this.sprite.alpha -= 0.015;
        if (this.sprite.alpha <= 0) this.sprite.visible = false;
    }
}

/**
 * Initializes the PIXI.js application for the celebration effect.
 */
function initChampagneEffect() {
    celebrationApp = new PIXI.Application({
        width: window.innerWidth,
        height: window.innerHeight,
        transparent: true,
        antialias: true,
        view: document.createElement('canvas') // Create canvas element dynamically
    });
    celebrationApp.view.id = 'celebration-canvas'; // Assign an ID for styling
    document.body.appendChild(celebrationApp.view);

    celebrationBottle = new CelebrationBottle();
    celebrationApp.stage.addChild(celebrationBottle);

    for (let i = 0; i < 500; i++) {
        celebrationParticles.push(new CelebrationParticle());
    }

    celebrationApp.ticker.add(() => {
        for (const particle of celebrationParticles) {
            particle.update();
        }
    });
    
    window.addEventListener('resize', () => {
        celebrationApp.renderer.resize(window.innerWidth, window.innerHeight);
        if(celebrationBottle) {
            celebrationBottle.x = window.innerWidth / 2;
            celebrationBottle.y = window.innerHeight / 2;
        }
    });
}

/**
 * Triggers the champagne spray effect for a given duration.
 * @param {number} durationMs - The duration of the effect in milliseconds.
 */
function triggerChampagneSpray(durationMs) {
    if (sprayInterval) {
        clearInterval(sprayInterval);
    }
    let particleIndex = 0;

    if (celebrationBottle) {
        celebrationBottle.visible = true;
        celebrationBottle.x = window.innerWidth / 2; // Reset position in case of resize
        celebrationBottle.y = window.innerHeight / 2;
    }

    sprayInterval = setInterval(() => {
        // Correctly calculate the mouth's position and spray angle
        const mouthOffset = 50; // An offset in pixels from the anchor to the tip of the mouth
        const sprayDirection = celebrationBottle.rotation - (Math.PI / 2); // Angle should be "up" relative to the bottle
        
        // Calculate the actual origin point of the spray at the bottle's mouth
        const sprayOriginX = celebrationBottle.x + Math.cos(sprayDirection) * mouthOffset;
        const sprayOriginY = celebrationBottle.y + Math.sin(sprayDirection) * mouthOffset;

        for (let i = 0; i < 20; i++) { // Increase particle count for a richer effect
            if (particleIndex >= celebrationParticles.length) particleIndex = 0;
            celebrationHue = (celebrationHue + 2) % 360; // Faster color change
            const color = '0x' + tinycolor({ h: celebrationHue, s: 0.9, l: 0.7 }).toHex();
            celebrationParticles[particleIndex].reset(sprayOriginX, sprayOriginY, color, sprayDirection);
            particleIndex++;
        }
    }, 16);

    setTimeout(() => {
        clearInterval(sprayInterval);
        sprayInterval = null;
        if (celebrationBottle) {
            celebrationBottle.visible = false;
        }
    }, durationMs);
}

/**
 * F1-Style Glossy Gauge (SVG) - Enhanced for Portfolio Dashboard
 */
function createGauge(root, opts = {}) {
  const size = opts.size || 280;
  const minAngle = (opts.minAngleDeg ?? -120) * Math.PI/180;
  const maxAngle = (opts.maxAngleDeg ??  120) * Math.PI/180;
  const cx = size/2, cy = size/2, r = size*0.43;
  const range = opts.range || [0, 100];
  const format = opts.format || (val => val);

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
  svg.style.width = "100%";
  svg.style.height = "100%";

  // Create gradient definitions
  const defs = document.createElementNS(svgNS, "defs");
  
  // Rim gradient
  const rimGrad = document.createElementNS(svgNS, "radialGradient");
  rimGrad.id = `rimGrad-${Math.random().toString(36).substr(2,9)}`;
  rimGrad.innerHTML = `
    <stop offset="0%" stop-color="var(--rim-highlight)"/>
    <stop offset="70%" stop-color="var(--rim)"/>
    <stop offset="100%" stop-color="#0a0d11"/>
  `;
  
  // Face gradient
  const faceGrad = document.createElementNS(svgNS, "radialGradient");
  faceGrad.id = `faceGrad-${Math.random().toString(36).substr(2,9)}`;
  faceGrad.innerHTML = `
    <stop offset="0%" stop-color="#1a1f26"/>
    <stop offset="100%" stop-color="var(--face)"/>
  `;

  const neonFilter = document.createElementNS(svgNS, "filter");
  neonFilter.id = `neon-glow-${Math.random().toString(36).substr(2,9)}`;
  neonFilter.innerHTML = `
    <feGaussianBlur in="SourceAlpha" stdDeviation="1.5" result="blur"/>
    <feFlood flood-color="#4da3ff" result="flood"/>
    <feComposite in="flood" in2="blur" operator="in" result="glow"/>
    <feMerge>
        <feMergeNode in="glow"/>
        <feMergeNode in="SourceGraphic"/>
    </feMerge>
  `;

  const yellowNeonFilter = document.createElementNS(svgNS, "filter");
  yellowNeonFilter.id = `neon-yellow-glow-${Math.random().toString(36).substr(2,9)}`;
  yellowNeonFilter.innerHTML = `
    <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
    <feFlood flood-color="var(--accent2)" flood-opacity="0.9" result="flood"/>
    <feComposite in="flood" in2="blur" operator="in" result="glow"/>
    <feMerge>
        <feMergeNode in="glow"/>
        <feMergeNode in="SourceGraphic"/>
    </feMerge>
  `;

  defs.appendChild(rimGrad);
  defs.appendChild(faceGrad);
  defs.appendChild(neonFilter);
  defs.appendChild(yellowNeonFilter);
  svg.appendChild(defs);

  // Outer rim
  const outerRim = document.createElementNS(svgNS, "circle");
  outerRim.setAttribute("cx", cx);
  outerRim.setAttribute("cy", cy);
  outerRim.setAttribute("r", r + 12);
  outerRim.setAttribute("fill", `url(#${rimGrad.id})`);
  outerRim.setAttribute("stroke", "rgba(255,255,255,0.1)");
  outerRim.setAttribute("stroke-width", "1");
  svg.appendChild(outerRim);

  // Main face
  const face = document.createElementNS(svgNS, "circle");
  face.setAttribute("cx", cx);
  face.setAttribute("cy", cy);
  face.setAttribute("r", r);
  face.setAttribute("fill", `url(#${faceGrad.id})`);
  face.setAttribute("stroke", "rgba(255,255,255,0.05)");
  face.setAttribute("stroke-width", "2");
  svg.appendChild(face);

  // Conditional performance arc for CAGR, Sharpe, and ROI gauges
  if (root.id === 'gauge-cagr' || root.id === 'gauge-sharpe' || root.id === 'gauge-vol') {
      let perfStartValue, perfEndValue;

      if (root.id === 'gauge-cagr') {
          perfStartValue = 0.12; // 12%
          perfEndValue = 1.0;   // 100%
      } else if (root.id === 'gauge-sharpe') {
          perfStartValue = 1.0;
          perfEndValue = 3.2;
      } else { // gauge-vol
          perfStartValue = 0.1; // 10%
          perfEndValue = 1.0;   // 100%
      }
      
      const angleRange = maxAngle - minAngle;
      const valueRange = range[1] - range[0];

      const startPercent = (perfStartValue - range[0]) / valueRange;
      const endPercent = (perfEndValue - range[0]) / valueRange;

      const startAngle = minAngle + (angleRange * startPercent);
      const endAngle = minAngle + (angleRange * endPercent);

      const r_outer = r + 12; // Radius of the outer edge of the gap (rim)
      const r_inner = r;     // Radius of the inner edge of the gap (face)

      const x_outer_start = cx + r_outer * Math.cos(startAngle);
      const y_outer_start = cy + r_outer * Math.sin(startAngle);
      const x_outer_end = cx + r_outer * Math.cos(endAngle);
      const y_outer_end = cy + r_outer * Math.sin(endAngle);

      const x_inner_start = cx + r_inner * Math.cos(startAngle);
      const y_inner_start = cy + r_inner * Math.sin(startAngle);
      const x_inner_end = cx + r_inner * Math.cos(endAngle);
      const y_inner_end = cy + r_inner * Math.sin(endAngle);

      const largeArcFlag = (endAngle - startAngle) > Math.PI ? 1 : 0;

      // Construct the path for the arc segment
      const d = [
        `M ${x_outer_start} ${y_outer_start}`,
        `A ${r_outer} ${r_outer} 0 ${largeArcFlag} 1 ${x_outer_end} ${y_outer_end}`,
        `L ${x_inner_end} ${y_inner_end}`,
        `A ${r_inner} ${r_inner} 0 ${largeArcFlag} 0 ${x_inner_start} ${y_inner_start}`,
        'Z'
      ].join(' ');

      const performanceArc = document.createElementNS(svgNS, "path");
      performanceArc.setAttribute('d', d);
      performanceArc.setAttribute('fill', 'var(--accent2)');
      performanceArc.setAttribute('opacity', '0.85'); // Adjusted for neon effect
      performanceArc.setAttribute('filter', `url(#${yellowNeonFilter.id})`);
      performanceArc.setAttribute("transform", `rotate(-89 ${cx} ${cy})`);
      svg.appendChild(performanceArc);
  }

  const scaleGroup = document.createElementNS(svgNS, "g");
  // Rotate the entire scale to align the '0' mark with the needle's start position.
  scaleGroup.setAttribute("transform", `rotate(-89 ${cx} ${cy})`);

  // Draw ticks
  const tickCount = 21;
  for (let i = 0; i < tickCount; i++) {
    const angle = minAngle + (maxAngle - minAngle) * i / (tickCount - 1);
    const isStrong = i % 5 === 0;
    const tickR1 = r - (isStrong ? 25 : 15);
    const tickR2 = r - 5;
    
    const x1 = cx + tickR1 * Math.cos(angle);
    const y1 = cy + tickR1 * Math.sin(angle);
    const x2 = cx + tickR2 * Math.cos(angle);
    const y2 = cy + tickR2 * Math.sin(angle);
    
    const tick = document.createElementNS(svgNS, "line");
    tick.setAttribute("x1", x1);
    tick.setAttribute("y1", y1);
    tick.setAttribute("x2", x2);
    tick.setAttribute("y2", y2);
    tick.setAttribute("stroke", isStrong ? "var(--tick-strong)" : "var(--tick)");
    tick.setAttribute("stroke-width", isStrong ? "2" : "1");
    tick.setAttribute("stroke-linecap", "round");
    scaleGroup.appendChild(tick);

    if (isStrong) {
      const labelR = r - 40;
      const x = cx + labelR * Math.cos(angle);
      const y = cy + labelR * Math.sin(angle);
      const value = range[0] + (range[1] - range[0]) * (i / (tickCount - 1));
      const label = format(value);

      const text = document.createElementNS(svgNS, "text");
      text.setAttribute("x", x);
      text.setAttribute("y", y);
      text.setAttribute("fill", "#4da3ff");
      text.setAttribute("font-size", "18");
      text.setAttribute('font-weight', '500');
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('alignment-baseline', 'middle');
      text.setAttribute("filter", `url(#${neonFilter.id})`);
      
      // Counter-rotate the text to make it appear upright
      text.setAttribute("transform", `rotate(89 ${x} ${y})`);
      
      text.textContent = label;
      scaleGroup.appendChild(text);
    }
  }
  svg.appendChild(scaleGroup);

  // Needle
  const needle = document.createElementNS(svgNS, "g");
  needle.style.transformOrigin = `${cx}px ${cy}px`;
  
  const needlePath = document.createElementNS(svgNS, "path");
  needlePath.setAttribute("d", `M ${cx-2} ${cy} L ${cx} ${cy-r*0.8} L ${cx+2} ${cy} Z`);
  needlePath.setAttribute("fill", "var(--needle)");
  needlePath.setAttribute("stroke", "#fff");
  needlePath.setAttribute("stroke-width", "0.5");
  needle.appendChild(needlePath);

  // Needle hub
  const hub = document.createElementNS(svgNS, "circle");
  hub.setAttribute("cx", cx);
  hub.setAttribute("cy", cy);
  hub.setAttribute("r", "8");
  hub.setAttribute("fill", "var(--needle-hub)");
  hub.setAttribute("stroke", "var(--needle)");
  hub.setAttribute("stroke-width", "2");
  needle.appendChild(hub);

  svg.appendChild(needle);

  // Glass overlay
  const glass = document.createElementNS(svgNS, "circle");
  glass.setAttribute("cx", cx);
  glass.setAttribute("cy", cy);
  glass.setAttribute("r", r);
  glass.setAttribute("fill", "url(#glassGrad)");
  glass.setAttribute("opacity", "0.3");
  
  const glassGrad = document.createElementNS(svgNS, "radialGradient");
  glassGrad.id = "glassGrad";
  glassGrad.innerHTML = `
    <stop offset="0%" stop-color="rgba(255,255,255,0.2)"/>
    <stop offset="50%" stop-color="rgba(255,255,255,0.05)"/>
    <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
  `;
  defs.appendChild(glassGrad);
  svg.appendChild(glass);

  root.appendChild(svg);

  // Set initial needle position to point at 0
  const initialAngle = minAngle; // This corresponds to the 0 value on the scale
  needle.style.transform = `rotate(${initialAngle * 180 / Math.PI}deg)`;

  // Animation function
  function animateNeedle(targetPercent, duration = 2000) {
    const targetAngle = minAngle + (maxAngle - minAngle) * (targetPercent / 100);
    const currentTransform = needle.style.transform || `rotate(${initialAngle * 180 / Math.PI}deg)`;
    const startAngleRad = (parseFloat(currentTransform.replace(/[^\d.-]/g, ''))) * Math.PI / 180;
    const startAngle = isNaN(startAngleRad) ? minAngle : startAngleRad;
    const startTime = Date.now();

    function animate() {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      
      const currentAngle = startAngle + (targetAngle - startAngle) * easeProgress;
      const degrees = currentAngle * 180 / Math.PI;
      
      needle.style.transform = `rotate(${degrees}deg)`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }
    
    animate();
  }

  return { animateNeedle };
}

// Data loading and refresh functions
async function loadPodiumData() {
  console.log('Loading podium data...');
  
  // Using static mock data for preview.
  const mockData = [
    { position: 1, team: 'Mercedes', car: 'Mercedes W16', points: 61, wins: 1, winRate: '79%', cagr: '18.4%', sharpe: 2.15, mdd: '-8.5%' },
    { position: 2, team: 'Ferrari', car: 'Ferrari SF-24', points: 52, wins: 2, winRate: '65%', cagr: '15.2%', sharpe: 1.98, mdd: '-11.2%' },
    { position: 3, team: 'McLaren', car: 'McLaren MCL38', points: 52, wins: 2, winRate: '71%', cagr: '16.8%', sharpe: 2.05, mdd: '-9.1%' },
    { position: 4, team: 'Red Bull Racing', car: 'Red Bull RB21', points: 33, wins: 0, winRate: '45%', cagr: '11.0%', sharpe: 1.50, mdd: '-15.4%' },
    { position: 5, team: 'Aston Martin', car: 'Aston Martin AMR25', points: 30, wins: 0, winRate: '55%', cagr: '12.5%', sharpe: 1.85, mdd: '-10.5%' },
    { position: 6, team: 'Alpine', car: 'Alpine A525', points: 19, wins: 0, winRate: '30%', cagr: '8.1%', sharpe: 1.21, mdd: '-18.9%' },
    { position: 7, team: 'Williams', car: 'Williams FW47', points: 18, wins: 0, winRate: '38%', cagr: '9.3%', sharpe: 1.33, mdd: '-16.3%' },
    { position: 8, team: 'Kick Sauber', car: 'Sauber C45', points: 12, wins: 0, winRate: '25%', cagr: '6.5%', sharpe: 1.10, mdd: '-20.1%' }
  ];
  
  return Promise.resolve(mockData);
}

function updatePodiumDisplay(data) {
  console.log('Updating podium display...');
  try {
    if (data.length >= 1) {
      const gold = data[0];
      const goldElement = document.querySelector('#base-podium .gold');
      if (goldElement) {
        goldElement.querySelector('.car-name').textContent = gold.car;
        goldElement.querySelector('.driver-name').textContent = gold.team;
        goldElement.querySelector('.points-badge').textContent = gold.points;
        goldElement.querySelector('.achievements').innerHTML = 
          `<span class="achievement-badge">🏆 0</span><span class="achievement-badge">⚡ ${gold.wins}</span>`;
      }
    }
    if (data.length >= 2) {
      const silver = data[1];
      const silverElement = document.querySelector('#base-podium .silver');
      if (silverElement) {
        silverElement.querySelector('.car-name').textContent = silver.car;
        silverElement.querySelector('.driver-name').textContent = silver.team;
        silverElement.querySelector('.points-badge').textContent = silver.points;
        silverElement.querySelector('.achievements').innerHTML = 
          `<span class="achievement-badge">🏆 0</span><span class="achievement-badge">⚡ ${silver.wins}</span>`;
      }
    }
    if (data.length >= 3) {
      const bronze = data[2];
      const bronzeElement = document.querySelector('#base-podium .bronze');
      if (bronzeElement) {
        bronzeElement.querySelector('.car-name').textContent = bronze.car;
        bronzeElement.querySelector('.driver-name').textContent = bronze.team;
        bronzeElement.querySelector('.points-badge').textContent = bronze.points;
        bronzeElement.querySelector('.achievements').innerHTML = 
          `<span class="achievement-badge">🏆 0</span><span class="achievement-badge">⚡ ${bronze.wins}</span>`;
      }
    }
  } catch (error) {
    console.error('Error updating podium display:', error);
  }
}

function updateStandingsTable(data) {
  console.log('Updating standings table...');
  try {
    const tableContainer = document.querySelector('#standings-table');
    if (!tableContainer) return;
    
    // Clear existing rows (keep header)
    const existingRows = tableContainer.querySelectorAll('.table-row');
    existingRows.forEach(row => row.remove());
    
    // Add new rows
    data.forEach((item, index) => {
      const row = document.createElement('div');
      row.className = 'table-row';
      
      if (index === 0) row.className += ' gold-row';
      else if (index === 1) row.className += ' silver-row';
      else if (index === 2) row.className += ' bronze-row';
      
      row.innerHTML = `
        <div class="pos-col">${item.position}</div>
        <div class="driver-col">${item.car}</div>
        <div class="team-col">${item.team}</div>
        <div class="points-col">${item.points}</div>
        <div class="wins-col">${item.wins}</div>
        <div class="fastest-col">${item.winRate}</div>
        <div class="podium-col">${item.cagr}</div>
        <div class="sharpe-col">${item.sharpe}</div>
        <div class="mdd-col">${item.mdd}</div>
      `;
      
      tableContainer.appendChild(row);
    });
  } catch (error) {
    console.error('Error updating standings table:', error);
  }
}

// Navigation Functions
function showTelemetry() {
  document.getElementById('telemetry-page').style.display = 'block';
  document.getElementById('podium-page').style.display = 'none';
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.nav-btn[onclick="showTelemetry()"]').classList.add('active');
}

function showPodium() {
  document.getElementById('telemetry-page').style.display = 'none';
  document.getElementById('podium-page').style.display = 'block';
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.nav-btn[onclick="showPodium()"]').classList.add('active');
  
  // Trigger podium animations
  setTimeout(() => {
    document.querySelectorAll('.podium-position').forEach((pos, index) => {
      pos.style.animation = 'none';
      pos.offsetHeight; // Trigger reflow
      pos.style.animation = `podiumRise 1s ease-out forwards`;
      pos.style.animationDelay = `${0.2 + index * 0.2}s`;
    });
  }, 100);
}

// --- Robust date parsing function ---
function parseDateString(dateStr) {
    if (typeof dateStr !== 'string') return null;
    const normalizedDateStr = dateStr.replace(/[\/\s]/g, '-');
    const parts = normalizedDateStr.split('-');
    if (parts.length !== 3) return null;

    let year, month, day;
    if (parts[0].length === 4) { // YYYY-MM-DD
        year = parseInt(parts[0], 10);
        month = parseInt(parts[1], 10);
        day = parseInt(parts[2], 10);
    } else { // DD-MM-YYYY
        day = parseInt(parts[0], 10);
        month = parseInt(parts[1], 10);
        year = parseInt(parts[2], 10);
    }

    if (isNaN(year) || isNaN(month) || isNaN(day) || String(year).length < 4) return null;
    const dateObj = new Date(Date.UTC(year, month - 1, day));
    if (dateObj.getUTCFullYear() !== year || dateObj.getUTCMonth() !== month - 1 || dateObj.getUTCDate() !== day) return null;
    return dateObj;
}

// --- Function to draw the equity curve SVG ---
function drawEquityCurve(data, containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = ''; 

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("width", "100%");
  svg.setAttribute("height", "100%");
  svg.setAttribute("viewBox", "0 0 800 300");

  if (!data || data.length < 2) {
    const placeholderText = document.createElementNS(svgNS, "text");
    placeholderText.setAttribute("x", "400");
    placeholderText.setAttribute("y", "150");
    placeholderText.setAttribute("fill", "#aeb7c5");
    placeholderText.setAttribute("text-anchor", "middle");
    placeholderText.textContent = "Upload a CSV file to see the equity curve.";
    svg.appendChild(placeholderText);
    container.appendChild(svg);
    return;
  }

  // Data Processing
  const equities = data.map(d => d.Equity);
  const dates = data.map(d => d.Date);
  const minEquity = Math.min(...equities);
  const maxEquity = Math.max(...equities);
  const equityRange = maxEquity - minEquity;
  const paddedMinEquity = minEquity - equityRange * 0.1;
  const paddedMaxEquity = maxEquity + equityRange * 0.1;
  const paddedEquityRange = paddedMaxEquity - paddedMinEquity;
  const startDate = dates[0];
  const endDate = dates[dates.length - 1];
  const dateRange = endDate.getTime() - startDate.getTime();
  const margin = { top: 40, right: 40, bottom: 80, left: 60 };
  const width = 800 - margin.left - margin.right;
  const height = 300 - margin.top - margin.bottom;
  const xScale = (date) => margin.left + ((date.getTime() - startDate.getTime()) / dateRange) * width;
  const yScale = (equity) => margin.top + height - (((equity - paddedMinEquity) / paddedEquityRange) * height);

  // Drawing Grid
  const defs = document.createElementNS(svgNS, "defs");
  defs.innerHTML = `<pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse"><path d="M 40 0 L 0 0 0 30" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern>`;
  svg.appendChild(defs);
  const gridRect = document.createElementNS(svgNS, 'rect');
  gridRect.setAttribute('width', '100%');
  gridRect.setAttribute('height', '100%');
  gridRect.setAttribute('fill', 'url(#grid)');
  svg.appendChild(gridRect);

  // Axes labels
  for (let i = 0; i <= 4; i++) {
    const value = paddedMinEquity + (paddedEquityRange / 4) * i;
    const y = yScale(value);
    const text = document.createElementNS(svgNS, 'text');
    text.setAttribute('x', margin.left - 10);
    text.setAttribute('y', y);
    text.setAttribute('fill', '#aeb7c5');
    text.setAttribute('font-size', '10');
    text.setAttribute('text-anchor', 'end');
    text.setAttribute('alignment-baseline', 'middle');
    text.textContent = `$${value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    svg.appendChild(text);
  }
  const numLabels = dates.length;
for (let i = 0; i < numLabels; i++) {
  const index = i;
  const date = dates[index];
  const x = xScale(date);
  const y = margin.top + height + 20;

  const text = document.createElementNS(svgNS, 'text');
  text.setAttribute('x', x);
  text.setAttribute('y', y);
  text.setAttribute('fill', '#aeb7c5');
  text.setAttribute('font-size', '10');
  text.setAttribute('text-anchor', 'end');
  text.setAttribute('alignment-baseline', 'middle');
  text.setAttribute('transform', `rotate(-90 ${x} ${y})`);

  const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
  const yy = String(date.getUTCFullYear()).slice(-2);
  text.textContent = `${mm} ${yy}`;

  svg.appendChild(text);
}

  // Drawing Path
  const pathData = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(d.Date)} ${yScale(d.Equity)}`).join(' ');
  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("d", pathData);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "#2ce58c");
  path.setAttribute("stroke-width", "4");
  path.setAttribute("stroke-linecap", "round");
  svg.appendChild(path);

  // Decorative Elements & Performance Indicators
  data.forEach((d, i) => {
    const cx = xScale(d.Date);
    const cy = yScale(d.Equity);

    const circle = document.createElementNS(svgNS, 'circle');
    circle.setAttribute('cx', cx);
    circle.setAttribute('cy', cy);
    circle.setAttribute('r', '6');
    circle.setAttribute('stroke', '#fff');
    circle.setAttribute('stroke-width', '2');
    circle.setAttribute('fill', i === 0 ? '#dc143c' : (i === data.length - 1 ? '#2ce58c' : '#ffb200'));
    svg.appendChild(circle);

    // --- Flag Drawing Logic ---
    const flagGroup = document.createElementNS(svgNS, 'g');
    const poleHeight = 25;
    const poleYStart = cy - 25;
    const pole = document.createElementNS(svgNS, 'line');
    pole.setAttribute('x1', cx);
    pole.setAttribute('y1', cy);
    pole.setAttribute('x2', cx);
    pole.setAttribute('y2', poleYStart);
    pole.setAttribute('stroke', '#aeb7c5');
    pole.setAttribute('stroke-width', '2');
    flagGroup.appendChild(pole);

    if (i === 0) { // Start Flag
        const startBanner = document.createElementNS(svgNS, 'rect');
        startBanner.setAttribute('x', cx);
        startBanner.setAttribute('y', poleYStart - 10);
        startBanner.setAttribute('width', '40');
        startBanner.setAttribute('height', '12');
        startBanner.setAttribute('fill', '#dc143c');
        flagGroup.appendChild(startBanner);
        const startText = document.createElementNS(svgNS, 'text');
        startText.setAttribute('x', cx + 20);
        startText.setAttribute('y', poleYStart - 3);
        startText.setAttribute('fill', '#fff');
        startText.setAttribute('font-size', '8');
        startText.setAttribute('font-weight', 'bold');
        startText.setAttribute('text-anchor', 'middle');
        startText.textContent = 'START';
        flagGroup.appendChild(startText);
    } else if (i === data.length - 1) { // Finish Flag (Checkered)
        const checkeredGroup = document.createElementNS(svgNS, 'g');
        const squareSize = 5;
        for(let row = 0; row < 2; row++) {
            for(let col = 0; col < 5; col++) {
                const square = document.createElementNS(svgNS, 'rect');
                square.setAttribute('x', cx + col * squareSize);
                square.setAttribute('y', poleYStart - 10 + row * squareSize);
                square.setAttribute('width', squareSize);
                square.setAttribute('height', squareSize);
                square.setAttribute('fill', (row + col) % 2 === 0 ? '#000000' : '#ffffff');
                checkeredGroup.appendChild(square);
            }
        }
        flagGroup.appendChild(checkeredGroup);
    } else { // Checkpoint Flag (Pennant)
        const pennant = document.createElementNS(svgNS, 'path');
        const pathData = `M ${cx} ${poleYStart} L ${cx + 20} ${poleYStart + 5} L ${cx} ${poleYStart + 10} Z`;
        pennant.setAttribute('d', pathData);
        pennant.setAttribute('fill', '#ffb200');
        flagGroup.appendChild(pennant);
    }
    svg.appendChild(flagGroup);
  });
  const startEquity = data[0].Equity;
  const endEquity = data[data.length - 1].Equity;
  const totalReturn = ((endEquity - startEquity) / startEquity) * 100;
  const totalProfit = endEquity - startEquity;

  const returnText = document.createElementNS(svgNS, 'text');
  returnText.setAttribute('x', '400');
  returnText.setAttribute('y', '20');
  returnText.setAttribute('fill', totalReturn >= 0 ? '#2ce58c' : '#ff3b3b');
  returnText.setAttribute('font-size', '14');
  returnText.setAttribute('font-weight', 'bold');
  returnText.setAttribute('text-anchor', 'middle');
  returnText.textContent = `${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(1)}% Total Return`;
  svg.appendChild(returnText);

  const profitText = document.createElementNS(svgNS, 'text');
  profitText.setAttribute('x', '400');
  profitText.setAttribute('y', '38');
  profitText.setAttribute('fill', '#aeb7c5');
  profitText.setAttribute('font-size', '10');
  profitText.setAttribute('text-anchor', 'middle');
  profitText.textContent = `Racing to Victory: $${totalProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Profit`;
  svg.appendChild(profitText);

  container.appendChild(svg);
}

// --- Equity curve CSV upload handler ---
function handleEquityCurveUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            if (!results.data || results.data.length === 0) {
                alert("The CSV file is empty or invalid.");
                return;
            }
            const firstRow = results.data[0];
            const dateColumnName = firstRow.hasOwnProperty('Month') ? 'Month' : (firstRow.hasOwnProperty('Date') ? 'Date' : null);
            const equityColumnName = firstRow.hasOwnProperty('Equity') ? 'Equity' : null;

            if (dateColumnName && equityColumnName) {
                let processedData = [];
                for (const row of results.data) {
                    const dateStr = row[dateColumnName];
                    const equity = row[equityColumnName];
                    if (!dateStr || equity === null) continue;
                    
                    const dateObj = parseDateString(String(dateStr));
                    
                    if (dateObj) {
                        processedData.push({ Date: dateObj, Equity: equity });
                    }
                }

                if (processedData.length > 0) {
                    drawEquityCurve(processedData, 'equity-chart-container');
                    
                    // --- NEW TRIGGER CONDITION ---
                    // Check if there are at least two data points to compare
                    if (processedData.length >= 2) {
                        const lastEquity = processedData[processedData.length - 1].Equity;
                        const previousEquity = processedData[processedData.length - 2].Equity;

                        // Only trigger the celebration if the latest equity is higher than the previous one
                        if (lastEquity > previousEquity) {
                            triggerChampagneSpray(5000); 
                        }
                    }
                } else {
                    alert("Could not find any valid data rows in the CSV. Please check the date format (e.g., YYYY-MM-DD or DD-MM-YYYY).");
                }
            } else {
                alert("Invalid CSV format. Please ensure it has a date ('Month' or 'Date') and an 'Equity' column.");
            }
        },
        error: function(error) {
            console.error("Error parsing equity curve CSV:", error);
            alert(`An error occurred while parsing the equity curve CSV: ${error.message}`);
        }
    });
}

// --- Telemetry Alert Cycling (Restored) ---
function processTelemetryQueue() {
    if (telemetryInterval) {
        clearInterval(telemetryInterval);
        telemetryInterval = null;
    }

    const titleEl = document.getElementById('telemetry-card-title');
    const messageEl = document.getElementById('telemetry-card-message');

    if (telemetryQueue.length === 0) {
        if (titleEl) titleEl.textContent = 'Telemetry Alerts';
        if (messageEl) messageEl.textContent = 'No new alerts. All clear!';
        return;
    }

    let currentIndex = 0;

    const updateAlertCard = () => {
        const alert = telemetryQueue[currentIndex];
        const contentEl = document.getElementById('telemetry-alert-content');

        contentEl.classList.add('fade-out');

        setTimeout(() => {
            if (titleEl) titleEl.textContent = alert.title;
            if (messageEl) messageEl.textContent = alert.message;
            contentEl.classList.remove('fade-out');
        }, 500); // Match fade-out duration

        currentIndex = (currentIndex + 1) % telemetryQueue.length;
    };

    updateAlertCard(); // Show first message immediately
    if (telemetryQueue.length > 1) {
        telemetryInterval = setInterval(updateAlertCard, 8000); // Cycle every 8 seconds
    }
}

function playAudioAlertsSequentially(queue) {
    let audioIndex = 0;

    function playNext() {
        if (audioIndex >= queue.length) return; // Finished queue
        
        const alert = queue[audioIndex];
        const audioEl = document.getElementById(alert.audioId);
        
        audioIndex++; // Move to next for the subsequent call

        if (audioEl) {
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
            const playPromise = audioEl.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    audioEl.onended = () => setTimeout(playNext, 3000); // 3-second gap
                }).catch(error => {
                    console.warn(`Audio playback for ${alert.audioId} failed:`, error);
                    setTimeout(playNext, 3000);
                });
            }
        } else {
            console.warn(`Audio element with ID '${alert.audioId}' not found. Skipping.`);
            setTimeout(playNext, 3000);
        }
    }

    playNext();
}

// --- **NEW** CENTRALIZED FUNCTION TO UPDATE ALL DASHBOARD METRICS ---
function updateDashboardMetrics(metrics) {
  const metricMapping = {
    'WinRate': { elementId: 'win-rate-value', format: val => `${(val * 100).toFixed(0)}%` },
    'ProfitFactor': { elementId: 'drs-value', format: val => val.toFixed(2) },
    'OpenTrades': { elementId: 'pole-positions-value', format: val => val.toFixed(0) },
    'MaxDrawdown': { elementId: 'breakdown-value', format: val => `${(val * 100).toFixed(1)}%` },
    'CAGR': { elementId: 'cagr-gauge-value', format: val => `${(val * 100).toFixed(1)}%`, gauge: { instance: gaugeConfig.cagr.instance, range: gaugeConfig.cagr.range } },
    'Sharpe': { elementId: 'sharpe-gauge-value', format: val => val.toFixed(2), gauge: { instance: gaugeConfig.sharpe.instance, range: gaugeConfig.sharpe.range } },
    'ROI': { elementId: 'roi-gauge-value', format: val => `${(val * 100).toFixed(1)}%`, gauge: { instance: gaugeConfig.roi.instance, range: gaugeConfig.roi.range } }
  };

  for (const column in metricMapping) {
    if (metrics.hasOwnProperty(column) && metrics[column] !== null && isFinite(metrics[column])) {
      const config = metricMapping[column];
      const value = metrics[column];
      
      const element = document.getElementById(config.elementId);
      if (element) {
        element.textContent = config.format(value);
      }
      
      if (config.gauge && config.gauge.instance) {
        const [min, max] = config.gauge.range;
        const percentage = Math.max(0, Math.min(100, ((value - min) / (max - min)) * 100));
        config.gauge.instance.animateNeedle(percentage, 1200);
      }
    }
  }
}

// --- REFACTORED: General metrics CSV upload handler ("Upload Metrics" button) ---
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      if (!results.data || results.data.length === 0) {
        alert("Error: The selected CSV file appears to be empty.");
        return;
      }
      latestMetrics = results.data[0];
      
      // Call the new centralized update function
      updateDashboardMetrics(latestMetrics);

      },
    error: (error) => alert(`Error parsing CSV: ${error.message}`)
  });
}

// --- Standings CSV upload handler ---
function mapCsvDataToInternalFormat(csvData) {
    return csvData.filter(row => row.POS != null).map(row => ({
        position: row.POS,
        team: row.Team,
        car: row.Strategy,
        points: row.TotalPoints ? Math.round(row.TotalPoints) : 0,
        wins: row.Trades,
        winRate: row.WinRate != null ? `${(row.WinRate * 100).toFixed(0)}%` : 'N/A',
        cagr: row.CAGR != null ? `${(row.CAGR * 100).toFixed(1)}%` : 'N/A',
        sharpe: row.Sharpe != null ? row.Sharpe.toFixed(2) : 'N/A',
        mdd: row.MDD != null ? `${(row.MDD * 100).toFixed(1)}%` : 'N/A'
    }));
}
function handleStandingsUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            if (!results.data || results.data.length === 0) {
                alert("Error: The standings CSV file is empty.");
                return;
            }
            const mappedData = mapCsvDataToInternalFormat(results.data);
            mappedData.sort((a, b) => a.position - b.position);
            updatePodiumDisplay(mappedData);
            updateStandingsTable(mappedData);
        },
        error: (error) => alert(`Error parsing standings CSV: ${error.message}`)
    });
}

// --- Page Initialization ---
const gaugeConfig = {
    cagr: { id: 'gauge-cagr', valueId: 'cagr-gauge-value', initialValue: 0, range: [0, 1], format: (val) => `${(val * 100).toFixed(0)}`, instance: null },
    sharpe: { id: 'gauge-sharpe', valueId: 'sharpe-gauge-value', initialValue: 0, range: [0, 3.2], format: (val) => val.toFixed(1), instance: null },
    roi: { id: 'gauge-vol', valueId: 'roi-gauge-value', initialValue: 0, range: [0, 1], format: (val) => `${(val * 100).toFixed(0)}`, instance: null }
};

document.addEventListener('DOMContentLoaded', function() {
  console.log('F1 Portfolio Dashboard initializing...');
  try {
      initChampagneEffect(); // Initialize the PIXI app for the effect

      const initialEquityData = [
        { Date: new Date(Date.UTC(2025, 4, 31)), Equity: 10403.46 },
        { Date: new Date(Date.UTC(2025, 5, 30)), Equity: 11056.73 },
        { Date: new Date(Date.UTC(2025, 6, 31)), Equity: 11234.83 },
        { Date: new Date(Date.UTC(2025, 7, 31)), Equity: 11378.54 },
        { Date: new Date(Date.UTC(2025, 8, 30)), Equity: 11626.96 }
      ];
      drawEquityCurve(initialEquityData, 'equity-chart-container');

      Object.entries(gaugeConfig).forEach(([key, config]) => {
          config.instance = createGauge(document.getElementById(config.id), {
            range: config.range,
            format: config.format
          });
          
          const valueElement = document.getElementById(config.valueId);

          // Reset all gauges to 0 on initial load
          config.instance.animateNeedle(0, 1); 
          if (key === 'sharpe') {
            valueElement.textContent = '0.00';
          } else { // For CAGR and ROI
            valueElement.textContent = '0.0%';
          }
      });
      // === Gauge wobble (micro animation) ===
      window.__GAUGE_WOBBLE__ = (function(){
        const WOBBLE = {
          amplitudePct: { cagr: 1.2, sharpe: 2.0, roi: 2.5 },
          intervalMs: 500,
          durationMs: 500,
          mode: 'sine' // 'random' | 'sine'
        };
        let _phase = 0;
        const clamp = v => Math.max(0, Math.min(100, v));
        function wobbleDelta(ampl){
          if (WOBBLE.mode === 'sine'){
            _phase += Math.PI/8;
            return ampl * Math.sin(_phase);
          }
          return (Math.random()*2 - 1) * ampl;
        }
        function readValueAsNumber(txt){
          if (!txt) return NaN;
          const t = String(txt).trim();
          if (t.endsWith('%')) return parseFloat(t)/100;
          return parseFloat(t);
        }
        function tick(){
          if (document.hidden) return;
          Object.entries(gaugeConfig).forEach(([key, cfg]) => {
            try{
              const inst = cfg.instance;
              const [min, max] = cfg.range;
              const valEl = document.getElementById(cfg.valueId);
              const raw = valEl ? valEl.textContent : '';
              const val = readValueAsNumber(raw);
              if (!isFinite(val) || !inst || !isFinite(min) || !isFinite(max) || max<=min) return;
              const basePct = clamp(((val - min)/(max - min))*100);
              const ampl = (WOBBLE.amplitudePct[key] ?? 1.0);
              inst.animateNeedle(clamp(basePct + wobbleDelta(ampl)), WOBBLE.durationMs);
            }catch(e){ /* noop */ }
          });
        }
        const id = setInterval(tick, WOBBLE.intervalMs);
        return { stop: ()=>clearInterval(id), config: WOBBLE };
      })();

      document.getElementById('csv-upload')?.addEventListener('change', handleFileUpload);
      document.getElementById('equity-curve-upload')?.addEventListener('change', handleEquityCurveUpload);
      document.getElementById('standings-upload')?.addEventListener('change', handleStandingsUpload);
      // document.getElementById('ai-insights-btn')?.addEventListener('click', getAIEngineerInsights);

      loadPodiumData().then(data => {
        updatePodiumDisplay(data);
        updateStandingsTable(data);
      });

  } catch (e) {
      console.error("A critical error occurred during dashboard initialization:", e);
  }
  
  console.log('Dashboard initialization complete');
});
</script>
<audio id="cagr-audio" preload="auto" src="C:/Temp/Dashboard/audio/Weak_CAGR_voice.mp3"></audio><audio id="sharpe-audio" preload="auto" src="C:/Temp/Dashboard/audio/Low_Sharpe_voice.mp3"></audio><audio id="pf-audio" preload="auto" src="C:/Temp/Dashboard/audio/Low_PF_voice.mp3"></audio><audio id="mdd-audio" preload="auto" src="C:/Temp/Dashboard/audio/High_MDD_voice.mp3"></audio><script>
// === Telemetry (decoupled): cycle messages every 5s; audio plays once per upload ===
(function(){
  if (typeof window.updateDashboardMetrics !== 'function') return;

  // Shared state
  window.telemetryQueue = [];
  window.telemetryInterval = null;

  function num(v){ var n = Number(v); return isNaN(n) ? null : n; }

  // Message rotation (forever)
  window.processTelemetryQueue = function(){
    var titleEl = document.querySelector('.telemetry-title');
    var msgEl   = document.getElementById('telemetry-live-message');
    if (!titleEl || !msgEl) return;

    // clear any previous interval
    if (window.telemetryInterval) { clearInterval(window.telemetryInterval); window.telemetryInterval = null; }

    if (!window.telemetryQueue || window.telemetryQueue.length === 0) {
      titleEl.textContent = 'TELEMETRY ALERT';
      msgEl.textContent   = 'No live message';
      return;
    }

    var i = 0;
    function render(){
      var a = window.telemetryQueue[i];
      titleEl.textContent = a.title || 'TELEMETRY ALERT';
      msgEl.textContent   = a.message || '';
    }
    render();
    window.telemetryInterval = setInterval(function(){
      i = (i + 1) % window.telemetryQueue.length;
      render();
    }, 8000);
  };

  // Audio: play once per alert in the queue, 5s apart, then stop (no repeats)
  window.playTelemetryAudioOnce = function(queue){
    if (!queue || queue.length === 0) return;
    queue.forEach(function(a, idx){
      if (!a || !a.audioId) return;
      setTimeout(function(){
        try {
          var audio = document.getElementById(a.audioId);
          if (audio) { audio.currentTime = 0; audio.play().catch(function(e){ console.warn('Audio play failed', e); }); }
        } catch(e){ console.warn('Audio error', e); }
      }, idx * 8000); // align with 5s message rotation
    });
  };

  // Wrap the existing updateDashboardMetrics so telemetry runs AFTER gauges/stats update
  var __origUpdate = window.updateDashboardMetrics;
  window.updateDashboardMetrics = function(metricsForDashboard){
    var result = __origUpdate.apply(this, arguments);
    try {
      var m = metricsForDashboard || (window.latestMetrics || {});
      var q = [];
      var cagr = num(m.CAGR);
      var mdd  = num(m.MaxDrawdown);
      var shrp = num(m.Sharpe);
      var drs  = (m.DRS != null ? num(m.DRS) : (m.ProfitFactor != null ? num(m.ProfitFactor) : null));

      if (cagr != null && cagr < 0.12) {
        q.push({ title: 'CAGR ALERT!', message: 'We are seeing slower pace in your CAGR, keep pushing!', audioId: 'cagr-audio' });
      }
      if (shrp != null && shrp < 1.0) {
        q.push({ title: 'SHARPE RATIO ALERT!', message: 'On this sector, your throttle application is inconsistent. Try a smoother approach to carry more momentum.', audioId: 'sharpe-audio' });
      }
      if (drs != null && drs < 1) {
        q.push({ title: 'DRS ALERT!', message: 'DRS enabled. Gap is eight tenths. You should see the speed differential in a moment.', audioId: 'pf-audio' });
      }
      if (mdd != null && mdd > 0.30) {
        q.push({ title: 'MAX DRAWDOWN ALERT!', message: 'We have a slight issue for the front-left wheel nut. Need to be careful with it, driver.', audioId: 'mdd-audio' });
      }

      window.telemetryQueue = q;
      window.processTelemetryQueue();
      window.playTelemetryAudioOnce(q);
    } catch(e){
      console.warn('Telemetry decoupled wiring failed', e);
    }
    return result;
  };
})();
</script>
<script>
// F1 Live (safe wiring) â€” CLEAN REPLACEMENT
(function(){
  var state = { positions: [], quotes: {} };

  // Elements
  var statusEl  = document.getElementById('live-status');
  var keyInput  = document.getElementById('av-key-input');
  var saveBtn   = document.getElementById('save-av-key');
  var refreshBtn= document.getElementById('refresh-f1-live');
  var uploadEl  = document.getElementById('csvInput'); // existing file input used by GET DATA
  var tableBody = document.querySelector('#live-table tbody');
  var widgetsEl = document.getElementById('live-widgets');
  var summaryEl = document.getElementById('live-summary');

  function say(msg, ok){
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.color = ok ? '' : '#cc2e2e';
    setTimeout(function(){ statusEl.textContent=''; }, 3000);
  }

  function getField(obj, names){
    var norm = {};
    Object.keys(obj).forEach(function(k){
      var nk = String(k||'').toLowerCase().replace(/[()$]/g,'').replace(/\s+/g,'');
      norm[nk] = k;
    });
    for (var i=0;i<names.length;i++){
      var nk2 = String(names[i]).toLowerCase().replace(/[()$]/g,'').replace(/\s+/g,'');
      if (norm[nk2] != null) return obj[norm[nk2]];
    }
    return undefined;
  }

  function toNum(x){
    if (x==null || x==='') return NaN;
    var s = String(x).replace(/,/g,'').replace(/USD|US\$|S\$|\$/g,'');
    if (/^\(.*\)$/.test(s)) s = '-' + s.slice(1,-1);
    return parseFloat(s);
  }

  // FIFO per ticker (handles short/long; options use x100 multiplier by ID length>15)
  function fifoFromTrades(trades){
    trades.sort(function(a,b){ return a.date - b.date; });
    var isOption = (trades[0].ticker||'').length > 15;
    var mult = isOption ? 100 : 1;
    var longLots=[], shortLots=[], net=0, longCost=0, shortPro=0;

    for (var t of trades){
      if (t.qty > 0){
        var rem=t.qty;
        // cover shorts first
        while(rem>1e-12 && shortLots.length){
          var lot=shortLots[0], take=Math.min(lot.qty,rem);
          shortPro -= take*lot.entry*mult; net += take;
          lot.qty -= take; rem -= take;
          if(lot.qty<=1e-12) shortLots.shift();
        }
        if (rem>1e-12){
          longLots.push({qty:rem, price:t.price});
          longCost += rem*t.price*mult;
          net += rem;
        }
      }else if (t.qty < 0){
        var sell=-t.qty;
        while(sell>1e-12 && longLots.length){
          var lot2=longLots[0], take2=Math.min(lot2.qty,sell);
          longCost -= take2*lot2.price*mult; net -= take2;
          lot2.qty -= take2; sell -= take2;
          if(lot2.qty<=1e-12) longLots.shift();
        }
        if (sell>1e-12){
          shortLots.push({qty:sell, entry:t.price});
          shortPro += sell*t.price*mult;
          net -= sell;
        }
      }
    }
    if (net>1e-12) return {qty:net, avg:(longCost/(net*mult))||0, basis:longCost, mult:mult};
    if (net<-1e-12){ var qS=-net; return {qty:net, avg:(shortPro/(qS*mult))||0, basis:shortPro, mult:mult}; }
    return {qty:0, avg:0, basis:0, mult:mult};
  }

  function buildPositions(rows){
    var filtered = rows.filter(function(r){
      var acct = String(getField(r,['Acct ID (Team)','AcctID(Team)','AcctID Team','Acct ID','Account'])||'').trim().toLowerCase();
      var status = String(getField(r,['Status'])||'').trim().toLowerCase();
      return (acct==='stock ibkr' || acct==='option ibkr') && status==='open';
    });
    if (!filtered.length) return [];

    var norm=[];
    for (var i=0;i<filtered.length;i++){
      var r=filtered[i];
      var id = getField(r,['ID']);
      var sym = getField(r,['Symbol','Ticker']);
      var und = getField(r,['UNDERLYING_TICKER','UNDERLYING_RAW']);
      var side = String(getField(r,['Type','Side','Action'])||'').toLowerCase();
      var q = toNum(getField(r,['Quantity','Qty','Shares','Units']));
      if (!isFinite(q)) continue;
      q = (side.indexOf('sell')>=0 || side.indexOf('short')>=0) ? -Math.abs(q) : Math.abs(q);
      var px = toNum(getField(r,['Price (US$)','Price USD','PriceUS$','Price','Fill Price','Avg Price','Average Price']));
      if (!isFinite(px)) continue;
      var d = new Date(getField(r,['Date','Trade Date','Execution Time'])||Date.now());
      var ticker = (id && String(id).trim()) ? String(id).trim().toUpperCase().replace(/\s/g,'')
                  : (und && String(und).trim() ? String(und).trim().toUpperCase()
                  : (sym ? String(sym).trim().toUpperCase() : ''));
      var display = sym ? String(sym).trim() : ticker;
      norm.push({ticker:ticker, display:display, date:d, qty:q, price:px});
    }

    var by = new Map();
    norm.forEach(function(t){ var key=t.ticker; if (!by.has(key)) by.set(key, []); by.get(key).push(t); });

    var out=[];
    by.forEach(function(trs, key){
      var res = fifoFromTrades(trs);
      if (Math.abs(res.qty)>1e-12){
        out.push({symbol:key, display:trs[0].display, qty:res.qty, avgCost:res.avg, costTotal:res.basis, mult:res.mult});
      }
    });
    return out;
  }

  // Rendering
  function renderSummary(positions){
    if(!summaryEl) return;
    var cost=0, mv=0;
    positions.forEach(function(p){
      cost += (p.qty>0 ? p.costTotal : -p.costTotal);
      var last = (state.quotes[p.symbol] && state.quotes[p.symbol].last) || p.avgCost;
      mv += last * p.qty * (p.mult||1);
    });
    var pl = mv - cost; var plPct = cost ? (pl/cost*100) : 0;
    summaryEl.innerHTML='';
    [['Total Cost Basis','$'+cost.toFixed(2)],['Current Market Value','$'+mv.toFixed(2)],
     ['Unrealized P/L',(pl>=0?'+':'')+'$'+pl.toFixed(2)],['Unrealized P/L %',(plPct>=0?'+':'')+plPct.toFixed(2)+'%']]
    .forEach(function(kv,idx){
      var d=document.createElement('div'); d.className='kpi';
      d.innerHTML='<div style="font-size:12px;opacity:.8">'+kv[0]+'</div><div style="font-size:18px;font-weight:700;'+(idx>1?(pl>=0?'color:#1aa65b;':'color:#cc2e2e;'):'')+'">'+kv[1]+'</div>';
      summaryEl.appendChild(d);
    });
  }

  function renderTable(positions){
    if(!tableBody) return;
    tableBody.innerHTML='';
    if(!positions.length){ tableBody.innerHTML='<tr><td colspan="6" class="live-empty">No open positions for Stock/Option IBKR.</td></tr>'; return; }
    positions.forEach(function(p){
      var isShort=p.qty<0; var last=(state.quotes[p.symbol] && state.quotes[p.symbol].last) || p.avgCost; var mult=p.mult||1;
      var pl = isShort ? (p.costTotal - last*Math.abs(p.qty)*mult) : (last*p.qty*mult - p.costTotal);
      var plPct = p.avgCost ? (isShort ? ((p.avgCost/last-1)*100) : ((last/p.avgCost-1)*100)) : 0;
      var tr=document.createElement('tr');
      tr.innerHTML='<td style="font-weight:600">'+(p.display||p.symbol)+'</td><td>'+p.qty.toLocaleString()+'</td><td>$'+p.avgCost.toFixed(2)+'</td><td>$'+(isFinite(last)?last.toFixed(2):'â€”')+'</td><td class="'+(pl>=0?'live-pl-pos':'live-pl-neg')+'">'+(pl>=0?'+':'')+'$'+(isFinite(pl)?pl.toFixed(2):'â€”')+'</td><td class="'+(plPct>=0?'live-pl-pos':'live-pl-neg')+'">'+(plPct>=0?'+':'')+(isFinite(plPct)?plPct.toFixed(2)+'%':'â€”')+'</td>';
      tableBody.appendChild(tr);
    });
  }

  function toTVSymbol(t){
    if(!t) return '';
    t=String(t).toUpperCase();
    if(t.indexOf(':')!==-1) return t;
    var MAP={'PLTR':'BATS:PLTR','DECK':'NYSE:DECK','TSLA':'NASDAQ:TSLA','META':'NASDAQ:META','BIDU':'NASDAQ:BIDU','TQQQ':'NASDAQ:TQQQ','SQQQ':'NASDAQ:SQQQ','AAPL':'NASDAQ:AAPL','SPY':'AMEX:SPY','QQQ':'NASDAQ:QQQ','IWM':'AMEX:IWM','DIA':'AMEX:DIA'};
    return MAP[t]||t;
  }

  function renderWidgets(positions){
    if(!widgetsEl) return;
    widgetsEl.innerHTML='';
    var und=new Set();
    positions.forEach(function(p){
      var t=p.symbol||'';
      if(t.length>15) t = t.slice(0,t.length-15);
      if(t) und.add(t);
    });
    und.forEach(function(ticker){
      var tv=toTVSymbol(ticker);
      var container=document.createElement('div');
      container.className='live-card tradingview-widget-container';
      var inner=document.createElement('div');
      inner.className='tradingview-widget-container__widget'; inner.style.height='100%';
      container.appendChild(inner); widgetsEl.appendChild(container);
      var s=document.createElement('script');
      s.type='text/javascript'; s.src='https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js'; s.async=true;
      s.innerHTML=JSON.stringify({symbol:tv, chartOnly:false, dateRange:'12M', noTimeScale:true, colorTheme:'dark', isTransparent:true, locale:'en', width:'100%', autosize:false, height:'100%'});
      container.appendChild(s);
    });
  }

  function renderAll(){ renderSummary(state.positions); renderTable(state.positions); renderWidgets(state.positions); }

  // Alpha Vantage
  function ymdYesterday(){ var y=new Date(); y.setDate(y.getDate()-1); return y.toISOString().slice(0,10); }
  async function fetchAlphaQuote(sym,key){
    try{
      var url='https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol='+encodeURIComponent(sym)+'&apikey='+encodeURIComponent(key);
      var r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      var data=await r.json(); var gq=data && (data['Global Quote']||data['globalQuote']);
      var px=gq?parseFloat(gq['05. price']||gq['price']):NaN;
      if(isFinite(px)) return {last:px,time:new Date()};
      return null;
    }catch(e){ return null; }
  }
  async function fetchAlphaOptionQuote(contractId,key){
    try{
      var symbol=contractId.substring(0,contractId.length-15).trim();
      var date=ymdYesterday();
      var url='https://www.alphavantage.co/query?function=HISTORICAL_OPTIONS&symbol='+encodeURIComponent(symbol)+'&date='+date+'&apikey='+encodeURIComponent(key);
      var r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status);
      var data=await r.json();
      if(data && Array.isArray(data.data) && data.data.length){
        var hit=data.data.find(function(c){ return c.contractID===contractId; });
        if(hit){ var mark=parseFloat(hit.mark); if(isFinite(mark)) return {last:mark,time:new Date(date)}; }
      }
      return null;
    }catch(e){ return null; }
  }
  async function fetchAllQuotes(){
    var key=(keyInput && keyInput.value.trim())||localStorage.getItem('av_key')||'';
    if(!key){ say('Enter Alpha Vantage API key', false); return; }
    say('Update...', true);
    for (var i=0;i<state.positions.length;i++){
      var s=state.positions[i].symbol;
      var q=(s.length>15)? await fetchAlphaOptionQuote(s,key) : await fetchAlphaQuote(s,key);
      if(q) state.quotes[s]=q;
      renderSummary(state.positions); renderTable(state.positions);
    }
    say('Prices refreshed.', true);
  }

  // Parse CSV on change (GET DATA button already wired elsewhere)
  function parsePositionsCSV(file){
    if(!window.Papa){ say('CSV parser missing', false); return; }
    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete:function(res){
        try{
          var rows=res.data||[];
          state.positions=buildPositions(rows);
          say(state.positions.length+' positions', true);
          renderAll();
        }catch(err){ console.error(err); say('Error processing CSV', false); }
      },
      error:function(err){ console.error(err); say('CSV read error', false); }
    });
  }

  // Wire controls & input once window loads
  window.addEventListener('load', function(){
    try{
      if(keyInput){ var saved=localStorage.getItem('av_key')||''; if(saved) keyInput.value=saved; }
      if(saveBtn){ saveBtn.addEventListener('click', function(){ var v=(keyInput && keyInput.value.trim())||''; localStorage.setItem('av_key', v); say('API key saved.', true); }); }
      if(refreshBtn){ refreshBtn.addEventListener('click', function(){ if(!state.positions.length){ say('Load positions first.', false); return; } fetchAllQuotes(); }); }
      if(uploadEl){ uploadEl.addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; parsePositionsCSV(f); }); }
      say('F1 Live ready', true);
    }catch(e){ console.error('F1 Live init error', e); }
  });
})();
</script>
<script>
(function() {
  // === Embedded metrics (no fetch, no fallback) ===
  const METRICS = {"WinRate": 0.5102040816326531, "ProfitFactor": 1.1163412277006508, "OpenPositions": 12, "MaxDrawdown": 1.2718685670609275, "CAGR": 0.5056632672002122, "Sharpe": -0.7136941335731328, "ROI": 0.370037485233091, "TripCount": 343, "Wins": 175, "Losses": 168, "SumPos": 33181.09133589699, "SumAbsNeg": 29723.072580810003, "Basis": "Trip-level (Closed by latest ID status), PnL = sum(Net Amount (Fuel)) per ID", "EquityStart": 9823.102583, "EquityEnd": 13458.01876, "Days": 281};

  function setText(id, text){
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  function setGauge(id, text){
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  function updateTilesFromMetrics(m){
    var metricsForDashboard = {
      WinRate: (typeof m.WinRate === 'number' ? m.WinRate : 0),
      ProfitFactor: (typeof m.ProfitFactor === 'number' ? m.ProfitFactor : 0),
      OpenTrades: (typeof m.OpenPositions === 'number' ? m.OpenPositions : 0),
      MaxDrawdown: (typeof m.MaxDrawdown === 'number' ? m.MaxDrawdown : 0),
      CAGR: (typeof m.CAGR === 'number' ? m.CAGR : 0),
      Sharpe: (typeof m.Sharpe === 'number' ? m.Sharpe : 0),
      ROI: (typeof m.ROI === 'number' ? m.ROI : 0)
    };
    if (typeof updateDashboardMetrics === 'function'){
      updateDashboardMetrics(metricsForDashboard);
    } else {
      setText('win-rate-value', (metricsForDashboard.WinRate*100).toFixed(0) + '%');
      setText('drs-value', metricsForDashboard.ProfitFactor.toFixed(2));
      setText('pole-positions-value', String(metricsForDashboard.OpenTrades));
      setText('breakdown-value', (metricsForDashboard.MaxDrawdown*100).toFixed(1) + '%');
      setGauge('cagr-gauge-value', (metricsForDashboard.CAGR*100).toFixed(1) + '%');
      setGauge('sharpe-gauge-value', metricsForDashboard.Sharpe.toFixed(2));
      setGauge('roi-gauge-value', (metricsForDashboard.ROI*100).toFixed(1) + '%');
    }
  }
  function buildLlmSummary(m){
    var perf = {
      totalReturn: m.ROI, CAGR: m.CAGR, maxDD: m.MaxDrawdown,
      startDate: null, endDate: null, days: m.Days
    };
    var tripStats = {
      n: m.TripCount, wins: m.Wins, losses: m.Losses,
      winRate: m.WinRate, profitFactor: m.ProfitFactor
    };
    var counts = { open: m.OpenPositions };
    var meta = { basis: m.Basis || 'NET(Fuel) trip-level', equityStart: m.EquityStart, equityEnd: m.EquityEnd, days: m.Days };
    window.DEBRIEF_SUMMARY = {
      meta, counts, totals: {}, performance: perf,
      topUnderlying: [], pnlByUnderlying: {}, byEntryDOW: {}, tripStats,
      strategyStats: {}, marketContext: {}, equityCurvePreview: { head: [], tail: [] }
    };
  }
  document.addEventListener('DOMContentLoaded', function(){
    try {
      updateTilesFromMetrics(METRICS);
      buildLlmSummary(METRICS);
      var statusEl = document.getElementById('debrief-status');
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'âœ” Metrics loaded (embedded JSON).'; }
      console.log('[F1] Embedded metrics applied.');
    } catch(e) {
      console.error('Embedded metrics init failed:', e);
      alert('Embedded metrics init failed: ' + e.message);
    }
  });
})();
</script>
<!-- === Metrics JSON Loader via GET DATA button === -->
<input accept="application/json" id="metrics-json-file" style="display:none" type="file"/>
<script>
(function(){
  function selectGetDataButton(){
    // Try common IDs first
    var btn = document.querySelector("#btn-get-data, #btnGetData, button#get-data");
    if (btn) return btn;
    // Fallback: find a button whose text contains "GET DATA"
    var buttons = Array.from(document.querySelectorAll("button, .btn"));
    for (var i=0;i<buttons.length;i++){
      var t = (buttons[i].textContent || "").trim().toUpperCase();
      if (t.indexOf("GET DATA") !== -1) return buttons[i];
    }
    return null;
  }

  function setText(id, text){
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  function writeTiles(m){
    var winRate = Number(m.WinRate)||0;
    var pf = Number(m.ProfitFactor)||0;
    var open = Number(m.OpenPositions)||0;
    var mdd = Number(m.MaxDrawdown)||0;
    var cagr = Number(m.CAGR)||0;
    var sharpe = Number(m.Sharpe)||0;
    var roi = Number(m.ROI)||0;

    // If your page exposes updateDashboardMetrics, prefer it
    if (typeof updateDashboardMetrics === 'function'){
      updateDashboardMetrics({
        WinRate: winRate, ProfitFactor: pf, OpenTrades: open,
        MaxDrawdown: mdd, CAGR: cagr, Sharpe: sharpe, ROI: roi
      });
    } else {
      setText('win-rate-value', (winRate*100).toFixed(0) + '%');
      setText('drs-value', pf.toFixed(2));
      setText('pole-positions-value', String(open));
      setText('breakdown-value', (mdd*100).toFixed(1) + '%');
      setText('cagr-gauge-value', (cagr*100).toFixed(1) + '%');
      setText('sharpe-gauge-value', sharpe.toFixed(2));
      setText('roi-gauge-value', (roi*100).toFixed(1) + '%');
    }
  }

  function buildLlmSummary(m){
    var perf = {
      totalReturn: m.ROI, CAGR: m.CAGR, maxDD: m.MaxDrawdown,
      startDate: null, endDate: null, days: m.Days
    };
    var tripStats = {
      n: m.TripCount, wins: m.Wins, losses: m.Losses,
      winRate: m.WinRate, profitFactor: m.ProfitFactor
    };
    var counts = { open: m.OpenPositions };
    var meta = { basis: m.Basis || 'NET(Fuel) trip-level', equityStart: m.EquityStart, equityEnd: m.EquityEnd, days: m.Days };
    return {
      meta: meta, counts: counts, totals: {},
      performance: perf, topUnderlying: [], pnlByUnderlying: {},
      byEntryDOW: {}, tripStats: tripStats, strategyStats: {},
      marketContext: {}, equityCurvePreview: { head: [], tail: [] }
    };
  }

  function attachPicker(){
    var btn = selectGetDataButton();
    var inp = document.getElementById('metrics-json-file');
    if (!btn || !inp) return;

    btn.addEventListener('click', function(ev){
      // Use the button as a loader for metrics JSON
      ev.preventDefault();
      ev.stopPropagation();
      inp.value = '';
      inp.click();
    });

    inp.addEventListener('change', function(){
      var f = inp.files && inp.files[0];
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function(){
        try {
          var m = JSON.parse(reader.result);
          // Basic validation
          var req = ["WinRate","ProfitFactor","OpenPositions","MaxDrawdown","CAGR","Sharpe","ROI"];
          for (var i=0;i<req.length;i++){
            if (!(req[i] in m)) throw new Error("Missing field: " + req[i]);
          }
          window.METRICS = m; // store globally for reference
          window.DEBRIEF_SUMMARY = buildLlmSummary(m);
          writeTiles(m);
          var statusEl = document.getElementById('debrief-status');
          if (statusEl){ statusEl.style.display='block'; statusEl.textContent = 'âœ” Metrics loaded from selected JSON.'; }
          console.log("[F1] Metrics loaded via GET DATA:", m);
        } catch(e){
          alert("Invalid metrics JSON: " + e.message);
          console.error("Invalid metrics JSON", e);
        }
      };
      reader.readAsText(f);
    });
  }

  document.addEventListener('DOMContentLoaded', attachPicker);
})();
</script>
<script>
(function(){
  function robustParseJson(text){
    var t = (text || "").trim();
    if (t.startsWith("<")) throw new Error("The selected file appears to be HTML, not JSON.");
    // Strip BOM
    if (t.charCodeAt(0) === 0xFEFF) t = t.slice(1);
    // Strip HTML comments
    t = t.replace(/<!--[\s\S]*?-->/g, "");
    // Strip /* */ block comments
    t = t.replace(/\/\*[\s\S]*?\*\//g, "");
    // Strip // line comments
    t = t.split(/\r?\n/).map(function(line){ return line.replace(/^\s*\/\/.*$/, ""); }).join("\n");
    return JSON.parse(t);
  }

  function selectGetDataButton(){
    var btn = document.querySelector("#btn-get-data, #btnGetData, button#get-data");
    if (btn) return btn;
    var buttons = Array.from(document.querySelectorAll("button, .btn"));
    for (var i=0;i<buttons.length;i++){
      var t = (buttons[i].textContent || "").trim().toUpperCase();
      if (t.indexOf("GET DATA") !== -1) return buttons[i];
    }
    return null;
  }

  function setText(id, text){ var el=document.getElementById(id); if (el) el.textContent = text; }
  function writeTiles(m){
    var winRate = Number(m.WinRate)||0;
    var pf = Number(m.ProfitFactor)||0;
    var open = Number(m.OpenPositions)||0;
    var mdd = Number(m.MaxDrawdown)||0;
    var cagr = Number(m.CAGR)||0;
    var sharpe = Number(m.Sharpe)||0;
    var roi = Number(m.ROI)||0;
    if (typeof updateDashboardMetrics === 'function'){
      updateDashboardMetrics({ WinRate: winRate, ProfitFactor: pf, OpenTrades: open, MaxDrawdown: mdd, CAGR: cagr, Sharpe: sharpe, ROI: roi });
    } else {
      setText('win-rate-value', (winRate*100).toFixed(0)+'%');
      setText('drs-value', pf.toFixed(2));
      setText('pole-positions-value', String(open));
      setText('breakdown-value', (mdd*100).toFixed(1)+'%');
      setText('cagr-gauge-value', (cagr*100).toFixed(1)+'%');
      setText('sharpe-gauge-value', sharpe.toFixed(2));
      setText('roi-gauge-value', (roi*100).toFixed(1)+'%');
    }
  }
  function buildLlmSummary(m){
    var perf = { totalReturn:m.ROI, CAGR:m.CAGR, maxDD:m.MaxDrawdown, startDate:null, endDate:null, days:m.Days };
    var tripStats = { n:m.TripCount, wins:m.Wins, losses:m.Losses, winRate:m.WinRate, profitFactor:m.ProfitFactor };
    var counts = { open:m.OpenPositions };
    var meta = { basis:m.Basis||'NET(Fuel) trip-level', equityStart:m.EquityStart, equityEnd:m.EquityEnd, days:m.Days };
    window.DEBRIEF_SUMMARY = { meta, counts, totals:{}, performance:perf, topUnderlying:[], pnlByUnderlying:{}, byEntryDOW:{}, tripStats, strategyStats:{}, marketContext:{}, equityCurvePreview:{ head:[], tail:[] } };
  }

  document.addEventListener('DOMContentLoaded', function(){
    var btn = selectGetDataButton();
    var inp = document.getElementById('metrics-json-file');
    if (!btn || !inp) return;
    // Remove any previous click handlers by cloning
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.addEventListener('click', function(ev){
      ev.preventDefault(); ev.stopPropagation();
      inp.value=''; inp.click();
    });
    // Replace file change handler
    var newInp = inp.cloneNode(true);
    inp.parentNode.replaceChild(newInp, inp);
    newInp.addEventListener('change', function(){
      var f = newInp.files && newInp.files[0];
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function(){
        try {
          var m = robustParseJson(reader.result);
          var req = ["WinRate","ProfitFactor","OpenPositions","MaxDrawdown","CAGR","Sharpe","ROI"];
          for (var i=0;i<req.length;i++){ if (!(req[i] in m)) throw new Error("Missing field: " + req[i]); }
          window.METRICS = m; buildLlmSummary(m); writeTiles(m);
          var statusEl = document.getElementById('debrief-status');
          if (statusEl){ statusEl.style.display='block'; statusEl.textContent='âœ” Metrics loaded from selected JSON.'; }
          console.log("[F1] Metrics loaded via GET DATA (robust).", m);
        } catch(e){
          alert("Invalid metrics JSON: " + e.message);
          console.error("Invalid metrics JSON", e);
        }
      };
      reader.readAsText(f);
    });
  });
})();
</script>
<!-- ===== F1 Debrief + Unified GET DATA (safe append) â€” BEGIN ===== -->
<script>
(function(){
  // --- Helpers ---
  function coerceToDebriefSummary(m){
    const perf = m.performance ?? {
      totalReturn: m.ROI ?? null,
      CAGR: m.CAGR ?? null,
      maxDD: m.MaxDrawdown ?? null,
      Sharpe: m.Sharpe ?? null,
      Sortino: null, volatility: null, calmar: null, recoveryDays: null,
      startDate: null, endDate: null, days: m.Days ?? null,
    };
    const trip = m.tripStats ?? {
      n: m.TripCount ?? null,
      wins: m.Wins ?? null,
      losses: m.Losses ?? null,
      winRate: (m.WinRate ?? null),
      profitFactor: (m.ProfitFactor ?? null),
      avgWin: m.avgWin ?? null,
      avgLoss: m.avgLoss ?? null,
      payoff: m.payoff ?? null,
      expectancy: m.expectancy ?? null,
      medianHold: m.medianHold ?? null,
      maxConsecWins: m.maxConsecWins ?? null,
      maxConsecLosses: m.maxConsecLosses ?? null
    };
    return {
      meta: m.meta ?? { file: "", basis: "" },
      counts: m.counts ?? { openTrips: m.OpenPositions ?? 0, closedTrips: m.TripCount ?? 0 },
      totals: m.totals ?? { sumPos: m.SumPos ?? 0, sumAbsNeg: m.SumAbsNeg ?? 0, netPnl: null },
      performance: perf,
      tripStats: trip,
      strategyStats: m.strategyStats ?? [],
      pnlByUnderlying: m.pnlByUnderlying ?? {},
      topUnderlying: m.topUnderlying ?? [],
      timing: m.timing ?? { byEntryDOW: [], byMonth: [], byHoldBucket: [] },
      fees: m.fees ?? {},
      marketContext: m.marketContext ?? {},
      equityCurvePreview: m.equityCurvePreview ?? { head: [], tail: [] }
    };
  }

  function tilesFromSummary(m){
    return {
      WinRate:       m.WinRate       ?? m.tripStats?.winRate       ?? 0,
      ProfitFactor:  m.ProfitFactor  ?? m.tripStats?.profitFactor  ?? 0,
      OpenTrades:    m.OpenPositions ?? m.counts?.openTrips        ?? m.counts?.open ?? 0,
      MaxDrawdown:   m.MaxDrawdown   ?? m.performance?.maxDD       ?? 0,
      CAGR:          m.CAGR          ?? m.performance?.CAGR        ?? m.performance?.cagr ?? 0,
      Sharpe:        m.Sharpe        ?? m.performance?.Sharpe      ?? m.performance?.sharpe ?? 0,
      ROI:           m.ROI           ?? m.performance?.totalReturn ?? 0
    };
  }

  function applyMetricsAndSummary(m){
    const t = tilesFromSummary(m);
    if (typeof updateDashboardMetrics === 'function') {
      updateDashboardMetrics(t);
    } else {
      const pct = x => (x==null ? 'â€”' : (x*100).toFixed(1) + '%');
      const n2  = x => (x==null ? 'â€”' : Number(x).toFixed(2));
      const n0  = x => (x==null ? 'â€”' : String(x));
      var el;
      if ((el=document.getElementById('win-rate-value'))) el.textContent = pct(t.WinRate);
      if ((el=document.getElementById('drs-value'))) el.textContent = n2(t.ProfitFactor);
      if ((el=document.getElementById('pole-positions-value'))) el.textContent = n0(t.OpenTrades);
      if ((el=document.getElementById('breakdown-value'))) el.textContent = pct(t.MaxDrawdown);
      if ((el=document.getElementById('cagr-gauge-value'))) el.textContent = pct(t.CAGR);
      if ((el=document.getElementById('sharpe-gauge-value'))) el.textContent = n2(t.Sharpe);
      if ((el=document.getElementById('roi-gauge-value'))) el.textContent = pct(t.ROI);
    }
    window.DEBRIEF_SUMMARY = coerceToDebriefSummary(m);
    var statusEl = document.getElementById('debriefStatus') || document.getElementById('debrief-status');
    if (statusEl){ statusEl.style.display='block'; statusEl.textContent = 'Debrief ready.'; }
    console.log('[F1] Debrief summary set from JSON.');
  }

  // --- Unified picker ---
  document.addEventListener('DOMContentLoaded', function(){
    var fileInput = document.getElementById('metrics-json-file') || document.getElementById('csvInput');
    var btn = document.querySelector("#btn-get-data, #btnGetData, button#get-data") ||
              Array.from(document.querySelectorAll("button, .btn")).find(b => (b.textContent||'').trim().toUpperCase().includes("GET DATA"));
    if (!fileInput) { console.warn("[F1] No file input found for GET DATA."); return; }
    // Accept json as well
    try{
      if (fileInput.accept && !fileInput.accept.includes(".json")) fileInput.accept += ",.json";
    }catch(e){}

    // If a button exists but not wired, wire it to open the picker.
    if (btn){
      btn.addEventListener('click', function(ev){
        try { ev.preventDefault(); ev.stopPropagation(); } catch(e){}
        fileInput.click();
      });
    }

    // Handle JSON files ourselves; let CSV fall through to existing handlers.
    fileInput.addEventListener('change', function(ev){
      var f = fileInput.files && fileInput.files[0];
      if (!f) return;
      var isJson = /\.json$/i.test(f.name);
      if (!isJson) {
        // Let other listeners (CSV path) continue untouched.
        return;
      }
      // JSON: stop other handlers and parse here
      if (ev && ev.stopImmediatePropagation) ev.stopImmediatePropagation();
      if (ev && ev.preventDefault) ev.preventDefault();

      var statusEl = document.getElementById('debriefStatus') || document.getElementById('debrief-status');
      if (statusEl) { statusEl.style.display='block'; statusEl.textContent = 'Loading ' + f.name + '...'; }

      var reader = new FileReader();
      reader.onload = function(){
        try{
          var txt = String(reader.result||"");
          // Tolerate stray Infinity/NaN if present
          txt = txt.replace(/\b-?Infinity\b/g, "null").replace(/\bNaN\b/g, "null");
          var m = JSON.parse(txt);
          applyMetricsAndSummary(m);
        }catch(e){
          console.error("[F1] JSON parse error:", e);
          alert("Invalid metrics JSON: " + e.message);
          if (statusEl) statusEl.textContent = "Invalid metrics JSON";
        }
      };
      reader.onerror = function(){ alert("Failed to read JSON file."); };
      reader.readAsText(f);
    }, true); // capture to intercept before other listeners
  });
})();
</script>
<!-- ===== F1 Debrief + Unified GET DATA (safe append) â€” END ===== -->
<!-- ===== Ensure DEBRIEF_SUMMARY for GET INSIGHT (auto-restore) â€” BEGIN ===== -->
<script>
(function(){
  function findGetInsightButtons(){
    const candidates = [];
    const ids = ['btn-get-insight','btnGetInsight','get-insight','btnInsights','btnPodium'];
    ids.forEach(id => { const el = document.getElementById(id); if (el) candidates.push(el); });
    // Also search by text content
    Array.from(document.querySelectorAll('button, .btn, [role="button"]')).forEach(b => {
      const t = (b.textContent||'').trim().toUpperCase();
      if (t.includes('GET INSIGHT') || t.includes('GET INSIGHTS')) candidates.push(b);
    });
    return Array.from(new Set(candidates));
  }

  function setFromLocalStorage(){
    try{
      const raw = localStorage.getItem('f1_metrics_full');
      if (!raw) return false;
      // tolerate NaN/Infinity tokens in storage (shouldn't happen with sanitized JSON)
      const txt = raw.replace(/\b-?Infinity\b/g, "null").replace(/\bNaN\b/g, "null");
      const m = JSON.parse(txt);
      if (!window.applyMetricsAndSummary) {
        // fallback: only set DEBRIEF_SUMMARY if the helper is missing
        if (typeof coerceToDebriefSummary === 'function') {
          window.DEBRIEF_SUMMARY = coerceToDebriefSummary(m);
        } else {
          window.DEBRIEF_SUMMARY = m; // best-effort
        }
      } else {
        // also refresh tiles so UI stays in sync
        window.applyMetricsAndSummary(m);
      }
      console.log("[F1] Restored DEBRIEF_SUMMARY from localStorage.");
      return true;
    }catch(e){
      console.warn("[F1] Failed to restore summary from localStorage:", e);
      return false;
    }
  }

  function ensureSummary(){
    if (window.DEBRIEF_SUMMARY) return true;
    return setFromLocalStorage();
  }

  document.addEventListener('DOMContentLoaded', function(){
    // 1) Save JSON whenever we load it via applyMetricsAndSummary
    if (typeof window.applyMetricsAndSummary === 'function'){
      const orig = window.applyMetricsAndSummary;
      window.applyMetricsAndSummary = function(m){
        try {
          localStorage.setItem('f1_metrics_full', JSON.stringify(m));
        } catch(e){ console.warn("[F1] Couldn't cache metrics JSON:", e); }
        return orig(m);
      };
    }

    // 2) Hook GET INSIGHT clicks to auto-ensure the summary exists
    const wire = () => {
      findGetInsightButtons().forEach(btn => {
        if (btn.__f1_wired) return;
        btn.addEventListener('click', function(){ ensureSummary(); }, true); // capture: run before other handlers
        btn.__f1_wired = true;
      });
    };
    wire();
    // also re-run wiring after small delay in case the button renders late
    setTimeout(wire, 500);
    setTimeout(wire, 1500);
  });
})();
</script>
<!-- ===== Ensure DEBRIEF_SUMMARY for GET INSIGHT (auto-restore) â€” END ===== -->
<!-- ===== Debrief Summary Glue (aliases + events + persistence) â€” BEGIN ===== -->
<script>
(function(){
  function safeParse(txt){
    try{
      txt = String(txt||"").replace(/\b-?Infinity\b/g, "null").replace(/\bNaN\b/g, "null");
      return JSON.parse(txt);
    }catch(e){ return null; }
  }
  function setDebriefSummary(m){
    if (!m || typeof m !== 'object') return false;
    // Primary
    window.DEBRIEF_SUMMARY = m;
    // Aliases some code might be using
    window.debriefSummary = m;
    window.__DEBRIEF = m;
    window.SUMMARY = m;
    try{
      localStorage.setItem('f1_metrics_full', JSON.stringify(m));
      sessionStorage.setItem('f1_metrics_full', JSON.stringify(m));
    }catch(e){}
    try{
      // Drop a copy into a data attr for ultra-legacy readers
      document.body.setAttribute('data-debrief-summary', 'ready');
    }catch(e){}
    // Broadcast
    try{
      document.dispatchEvent(new CustomEvent('debrief:summary-ready', {detail:{ok:true}}));
      window.dispatchEvent(new CustomEvent('debrief:summary-ready', {detail:{ok:true}}));
    }catch(e){}
    return true;
  }
  function getDebriefSummary(){
    if (window.DEBRIEF_SUMMARY) return window.DEBRIEF_SUMMARY;
    var raw = localStorage.getItem('f1_metrics_full') || sessionStorage.getItem('f1_metrics_full');
    var obj = safeParse(raw);
    if (obj){ setDebriefSummary(obj); return obj; }
    return null;
  }
  // Expose helpers
  window.setDebriefSummary = setDebriefSummary;
  window.getDebriefSummary = getDebriefSummary;

  // Patch applyMetricsAndSummary to always call setDebriefSummary
  if (typeof window.applyMetricsAndSummary === 'function'){
    const _orig = window.applyMetricsAndSummary;
    window.applyMetricsAndSummary = function(m){
      setDebriefSummary(m);
      return _orig(m);
    };
  }else{
    // If defined later, patch after load
    window.addEventListener('load', function(){
      if (typeof window.applyMetricsAndSummary === 'function' && !window.applyMetricsAndSummary.__f1_patched){
        const _o = window.applyMetricsAndSummary;
        window.applyMetricsAndSummary = function(m){ setDebriefSummary(m); return _o(m); };
        window.applyMetricsAndSummary.__f1_patched = true;
      }
    });
  }

  // Wire "Confirm Analysis" / "GET INSIGHT" buttons to ensure summary exists right before use
  function wireEnsureOnClick(){
    const candidates = [];
    const ids = ['btn-confirm-analysis','confirm-analysis','confirmAnalysis','btn-get-insight','btnGetInsight','get-insight','btnInsights','btnPodium'];
    ids.forEach(id => { const el = document.getElementById(id); if (el) candidates.push(el); });
    Array.from(document.querySelectorAll('button, .btn, [role="button"]')).forEach(b => {
      const t = (b.textContent||'').trim().toUpperCase();
      if (t.includes('CONFIRM ANALYSIS') || t.includes('GET INSIGHT') || t.includes('GET INSIGHTS')) candidates.push(b);
    });
    Array.from(new Set(candidates)).forEach(btn => {
      if (btn.__f1_summary_wired) return;
      btn.addEventListener('click', function(){ 
        const ok = !!getDebriefSummary();
        if (!ok) console.warn('[F1] No summary in memory; ask user to GET DATA.');
      }, true);
      btn.__f1_summary_wired = true;
    });
  }
  document.addEventListener('DOMContentLoaded', wireEnsureOnClick);
  setTimeout(wireEnsureOnClick, 500);
  setTimeout(wireEnsureOnClick, 1500);
})();
</script>
<!-- ===== Debrief Summary Glue â€” END ===== -->
<!-- ===== Debrief Failsafe Loader â€” BEGIN ===== -->
<input accept=".json" id="debrief-json-fallback" style="display:none" type="file"/>
<script>
(function(){
  function safeParseJSON(txt){
    try{
      return JSON.parse(String(txt||'').replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null'));
    }catch(e){ return null; }
  }
  function storeSummary(obj){
    if (!obj || typeof obj !== 'object') return false;
    window.DEBRIEF_SUMMARY = obj;
    try{
      localStorage.setItem('f1_metrics_full', JSON.stringify(obj));
      sessionStorage.setItem('f1_metrics_full', JSON.stringify(obj));
    }catch(e){}
    document.dispatchEvent(new CustomEvent('debrief:summary-ready',{detail:{ok:true}}));
    return true;
  }
  function attemptRestore(){
    if (window.DEBRIEF_SUMMARY) return true;
    var raw = localStorage.getItem('f1_metrics_full') || sessionStorage.getItem('f1_metrics_full');
    var obj = safeParseJSON(raw);
    if (obj){ storeSummary(obj); return true; }
    return false;
  }
  function fromMetricsJSON(j){
    // Accept either full summary or a metrics wrapper; choose best-guess field.
    if (!j) return null;
    if (j.meta && j.performance) return j; // already a summary-like object
    if (j.llmSummary && j.llmSummary.meta) return j.llmSummary;
    if (j.summary && j.summary.meta) return j.summary;
    if (j.metrics && j.metrics.summary) return j.metrics.summary;
    // last resort: wrap the whole thing
    return { meta:{source:'metrics_json_fallback'}, raw:j };
  }

  // Public: ensure summary exists. If not, trigger JSON picker.
  window.ensureDebriefSummary = function thenRun(next){
    if (attemptRestore() || window.DEBRIEF_SUMMARY){
      try{ next && next(window.DEBRIEF_SUMMARY); }catch(e){}
      return;
    }
    var input = document.getElementById('debrief-json-fallback');
    if (!input){
      alert('Missing JSON loader input.'); 
      return;
    }
    function onPick(){
      input.removeEventListener('change', onPick);
      var f = input.files && input.files[0];
      if (!f){ alert('No file selected.'); return; }
      var r = new FileReader();
      r.onload = function(){
        var obj = fromMetricsJSON(safeParseJSON(r.result));
        if (!obj){ alert('Invalid metrics JSON.'); return; }
        storeSummary(obj);
        try{ next && next(obj); }catch(e){}
      };
      r.readAsText(f);
    }
    input.value = '';
    input.addEventListener('change', onPick);
    input.click();
  };

  // Wire into Confirm flow: intercept the moment we are about to call runLLMAnalysis
  window.addEventListener('DOMContentLoaded', function(){
    var keyModal = document.getElementById('keyModal');
    var confirmModal = document.getElementById('confirmModal');
    var apiInput = keyModal ? (keyModal.querySelector('#apiKeyField') || keyModal.querySelector('input[type="password"]') || keyModal.querySelector('input[type="text"]')) : null;
    var btnYes = document.getElementById('btnConfirmYes');

    if (btnYes && !btnYes.__f1_wired){
      btnYes.__f1_wired = true;
      btnYes.addEventListener('click', function(ev){
        ev.preventDefault();
        function go(summary){
          try{
            if (window.runLLMAnalysis){
              window.runLLMAnalysis(summary, window.OPENAI_API_KEY || (apiInput? apiInput.value : ''));
            } else {
              console.warn('[F1] runLLMAnalysis not defined');
            }
          }catch(e){ console.error('[F1] runLLMAnalysis error:', e); }
        }
        if (window.DEBRIEF_SUMMARY){
          go(window.DEBRIEF_SUMMARY);
        }else{
          window.ensureDebriefSummary(go);
        }
      }, true);
    }
  });
})();
</script>
<!-- ===== Debrief Failsafe Loader â€” END ===== -->
<!-- ===== Debrief Summary Normalizer (ensures meta.rowCount) â€” BEGIN ===== -->
<script>
(function(){
  function normalizeSummary(obj){
    if (!obj || typeof obj !== 'object') return obj;
    obj.meta = obj.meta || {};
    // derive a sensible rowCount for legacy checks
    var rc = obj.meta.rowCount;
    if (rc == null) {
      var derived = null;
      // from FULL schema
      if (typeof obj.meta.rows === 'number') derived = obj.meta.rows;
      // fallback from counts (rows about open/closed rows if present)
      if (derived == null && obj.counts && typeof obj.counts.openRows === 'number' && typeof obj.counts.closedRows === 'number'){
        derived = obj.counts.openRows + obj.counts.closedRows;
      }
      // last resort from tripStats (not exact rows, but enough to pass >0 gate)
      if (derived == null && obj.tripStats && typeof obj.tripStats.n === 'number'){
        derived = obj.tripStats.n;
      }
      obj.meta.rowCount = derived != null ? derived : 0;
    }
    return obj;
  }
  // expose
  window.__normalizeDebriefSummary = normalizeSummary;

  // wrap existing setters
  if (typeof window.setDebriefSummary === 'function'){
    const _orig = window.setDebriefSummary;
    window.setDebriefSummary = function(m){ return _orig(normalizeSummary(m)); };
  }
  if (typeof window.applyMetricsAndSummary === 'function'){
    const _orig2 = window.applyMetricsAndSummary;
    window.applyMetricsAndSummary = function(m){ return _orig2(normalizeSummary(m)); };
  }
  // On load, normalize any existing
  if (window.DEBRIEF_SUMMARY) window.DEBRIEF_SUMMARY = normalizeSummary(window.DEBRIEF_SUMMARY);
  document.addEventListener('debrief:summary-ready', function(){
    if (window.DEBRIEF_SUMMARY) window.DEBRIEF_SUMMARY = normalizeSummary(window.DEBRIEF_SUMMARY);
  });
})();
</script>
<!-- ===== Debrief Summary Normalizer â€” END ===== -->
<!-- ===== Initialize Dashboard metrics to zero until GET DATA loads JSON â€” BEGIN ===== -->
<script>
(function(){
  function zeroifyTiles(){
    // helper formatters
    const pct = x => (x==null ? '0.0%' : (Number(x)*100).toFixed(1) + '%');
    const n2  = x => (x==null ? '0.00' : Number(x).toFixed(2));
    const n0  = x => (x==null ? '0' : String(x));

    var el;
    if ((el=document.getElementById('win-rate-value'))) el.textContent = pct(0);
    if ((el=document.getElementById('drs-value'))) el.textContent = n2(0);
    if ((el=document.getElementById('pole-positions-value'))) el.textContent = n0(0);
    if ((el=document.getElementById('breakdown-value'))) el.textContent = pct(0);
    if ((el=document.getElementById('cagr-gauge-value'))) el.textContent = pct(0);
    if ((el=document.getElementById('sharpe-gauge-value'))) el.textContent = n2(0);
    if ((el=document.getElementById('roi-gauge-value'))) el.textContent = pct(0);

    // If your gauges use specific APIs, call their setters here as well, e.g.:
    // window.updateCagrGauge && window.updateCagrGauge(0);
    // window.updateSharpeGauge && window.updateSharpeGauge(0);
    // window.updateRoiGauge && window.updateRoiGauge(0);
  }

  // Expose a manual reset if needed
  window.resetDashboardMetrics = zeroifyTiles;

  // Run once on load so the UI starts at zero
  document.addEventListener('DOMContentLoaded', function(){
    try { zeroifyTiles(); } catch(e){ console.warn('[F1] zero init failed:', e); }
  });
})();
</script>
<!-- ===== Initialize Dashboard metrics to zero â€” END ===== -->
<!-- ===== GET DATA Double-Open Guard + First-Select Summary Set â€” BEGIN ===== -->
<script>
(function(){
  // Re-usable guard to block re-entrant .click() on <input type="file">
  function guardFileClick(el){
    if (!el || typeof el.click !== 'function') return;
    if (el.__f1_click_guarded) return;
    const orig = el.click;
    let busy = false;
    el.click = function(){
      if (busy) { console.warn('[F1] file dialog re-entrant click blocked'); return; }
      busy = true;
      setTimeout(()=>busy=false, 1200); // guard window
      return orig.apply(el, arguments);
    };
    el.__f1_click_guarded = true;
  }

  function safeParse(txt){
    try{
      txt = String(txt||"").replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null');
      return JSON.parse(txt);
    }catch(e){ return null; }
  }
  function setSummary(m){
    if (!m) return false;
    // prefer our normalizer if present
    if (typeof window.__normalizeDebriefSummary === 'function'){
      m = window.__normalizeDebriefSummary(m);
    } else if (m.meta && m.meta.rows != null && (m.meta.rowCount == null)) {
      m.meta.rowCount = m.meta.rows;
    }
    window.DEBRIEF_SUMMARY = m;
    try{
      localStorage.setItem('f1_metrics_full', JSON.stringify(m));
      sessionStorage.setItem('f1_metrics_full', JSON.stringify(m));
    }catch(e){}
    try{
      document.dispatchEvent(new CustomEvent('debrief:summary-ready', {detail:{ok:true}}));
    }catch(e){}
    return true;
  }
  function applyAndSet(m){
    try{
      if (typeof window.applyMetricsAndSummary === 'function'){
        window.applyMetricsAndSummary(m);
      } else {
        setSummary(m);
      }
    }catch(e){
      console.warn('[F1] applyMetricsAndSummary failed, falling back to setSummary:', e);
      setSummary(m);
    }
  }

  // Wire once after DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    var fileInput = document.getElementById('metrics-json-file') || document.getElementById('csvInput');
    var btn = document.querySelector("#btn-get-data, #btnGetData, button#get-data") ||
              Array.from(document.querySelectorAll("button, .btn")).find(b => (b.textContent||'').trim().toUpperCase().includes("GET DATA"));

    if (!fileInput) return;
    guardFileClick(fileInput);

    // Global guard to prevent second-open chain
    window.__F1_FILE_DIALOG_OPEN = false;

    // Harden any GET DATA button to not double-open
    if (btn && !btn.__f1_guarded){
      const origHandler = function(ev){
        // If a file dialog is already in progress, do nothing
        if (window.__F1_FILE_DIALOG_OPEN) { ev && ev.preventDefault && ev.preventDefault(); return; }
        window.__F1_FILE_DIALOG_OPEN = true;
        // allow default handler to open dialog; release flag after some time
        setTimeout(()=>{ window.__F1_FILE_DIALOG_OPEN = false; }, 1500);
      };
      btn.addEventListener('click', origHandler, true); // capture before others
      btn.__f1_guarded = true;
    }

    // Intercept JSON selection in capture phase; stop other 'change' listeners firing a second dialog
    if (!fileInput.__f1_json_capture){
      fileInput.addEventListener('change', function(ev){
        var f = fileInput.files && fileInput.files[0];
        if (!f) return;
        var isJson = /\.json$/i.test(f.name);
        if (!isJson) return; // let CSV fall through

        // Stop other change handlers from re-opening a second dialog
        if (ev && ev.stopImmediatePropagation) ev.stopImmediatePropagation();
        if (ev && ev.preventDefault) ev.preventDefault();

        // Parse JSON and set summary immediately (so Debrief can run even if another dialog appears/cancelled)
        var reader = new FileReader();
        reader.onload = function(){
          var obj = safeParse(reader.result);
          if (!obj){
            alert('Invalid metrics JSON.');
            return;
          }
          applyAndSet(obj); // updates tiles and sets DEBRIEF_SUMMARY
          console.log('[F1] Metrics JSON applied after first selection.');
        };
        reader.readAsText(f);
      }, true); // capture
      fileInput.__f1_json_capture = true;
    }
  });
})();
</script>
<!-- ===== GET DATA Double-Open Guard â€” END ===== -->
<!-- ===== Unified GET DATA Loader (replaces existing listeners) â€” BEGIN ===== -->
<script>
(function(){
  function safeParse(txt){
    try{
      return JSON.parse(String(txt||'').replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null'));
    }catch(e){ return null; }
  }
  function applySummary(m){
    // prefer built-in apply if present, else fallback to set globals & simple text
    if (typeof window.applyMetricsAndSummary === 'function'){
      window.applyMetricsAndSummary(m);
    } else {
      window.DEBRIEF_SUMMARY = m;
      // minimal UI update
      const t = {
        WinRate:       m.WinRate       ?? m.tripStats?.winRate       ?? 0,
        ProfitFactor:  m.ProfitFactor  ?? m.tripStats?.profitFactor  ?? 0,
        OpenTrades:    m.OpenPositions ?? m.counts?.openTrips        ?? 0,
        MaxDrawdown:   m.MaxDrawdown   ?? m.performance?.maxDD       ?? 0,
        CAGR:          m.CAGR          ?? m.performance?.CAGR        ?? 0,
        Sharpe:        m.Sharpe        ?? m.performance?.Sharpe      ?? 0,
        ROI:           m.ROI           ?? m.performance?.totalReturn ?? 0
      };
      const pct = x => (x==null ? 'â€”' : (x*100).toFixed(1) + '%');
      const n2  = x => (x==null ? 'â€”' : Number(x).toFixed(2));
      const n0  = x => (x==null ? 'â€”' : String(x));
      var el;
      if ((el=document.getElementById('win-rate-value'))) el.textContent = pct(t.WinRate);
      if ((el=document.getElementById('drs-value'))) el.textContent = n2(t.ProfitFactor);
      if ((el=document.getElementById('pole-positions-value'))) el.textContent = n0(t.OpenTrades);
      if ((el=document.getElementById('breakdown-value'))) el.textContent = pct(t.MaxDrawdown);
      if ((el=document.getElementById('cagr-gauge-value'))) el.textContent = pct(t.CAGR);
      if ((el=document.getElementById('sharpe-gauge-value'))) el.textContent = n2(t.Sharpe);
      if ((el=document.getElementById('roi-gauge-value'))) el.textContent = pct(t.ROI);
    }
    try{
      // normalize and set multiple aliases for Debrief
      if (typeof window.__normalizeDebriefSummary === 'function'){
        m = window.__normalizeDebriefSummary(m);
      } else if (m.meta && m.meta.rows != null && (m.meta.rowCount == null)) {
        m.meta.rowCount = m.meta.rows;
      }
      window.DEBRIEF_SUMMARY = m;
      window.debriefSummary = m;
      window.__DEBRIEF = m;
      window.SUMMARY = m;
      localStorage.setItem('f1_metrics_full', JSON.stringify(m));
      sessionStorage.setItem('f1_metrics_full', JSON.stringify(m));
      document.dispatchEvent(new CustomEvent('debrief:summary-ready', {detail:{ok:true}}));
    }catch(e){}
  }

  function parseCSVAndSummarize(rows, fields){
    // If the page already has summarizeRows, use it to keep behavior parity
    if (typeof window.summarizeRows === 'function'){
      var startingCapital = 10000;
      var detailedSummary = window.summarizeRows(rows, fields, startingCapital, '');
      // Map to dashboard tiles
      const metricsForDashboard = {
        CAGR: detailedSummary.performance.cagr,
        Sharpe: detailedSummary.performance.sharpe_event,
        ROI: detailedSummary.performance.totalReturn,
        MaxDrawdown: detailedSummary.performance.maxDD,
        WinRate: detailedSummary.tripStats.winRate,
        ProfitFactor: detailedSummary.tripStats.profitFactor,
        OpenTrades: detailedSummary.counts.open
      };
      if (typeof window.updateDashboardMetrics === 'function'){
        window.updateDashboardMetrics(metricsForDashboard);
      }
      const summaryForLlm = {
        meta: detailedSummary.meta,
        counts: detailedSummary.counts,
        totals: detailedSummary.totals,
        performance: detailedSummary.performance,
        topUnderlying: detailedSummary.topUnderlying,
        pnlByUnderlying: detailedSummary.pnlByUnderlying,
        timing: { byEntryDOW: detailedSummary.byEntryDOW, byMonth: detailedSummary.byMonth },
        tripStats: detailedSummary.tripStats,
        strategyStats: detailedSummary.strategyStats,
        marketContext: detailedSummary.marketContext,
        equityCurvePreview: { 
          head: (detailedSummary.equityCurveDaily || []).slice(0,3),
          tail: (detailedSummary.equityCurveDaily || []).slice(-3)
        }
      };
      applySummary(summaryForLlm);
      return true;
    }else{
      alert("CSV flow not available in this build. Please load JSON.");
      return false;
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Find elements
    var fileInput = document.getElementById('metrics-json-file') || document.getElementById('csvInput');
    var btn = document.querySelector("#btn-get-data, #btnGetData, button#get-data") ||
              Array.from(document.querySelectorAll("button, .btn")).find(b => (b.textContent||'').trim().toUpperCase().includes("GET DATA"));
    if (!fileInput) return;
    // Replace input and button with clones to remove any existing listeners
    var newInput = fileInput.cloneNode(true);
    newInput.id = fileInput.id || 'csvInput';
    // ensure accept includes both
    try {
      if (!newInput.accept || !/json/i.test(newInput.accept)) newInput.accept = ".json,.csv";
    } catch(e){}
    fileInput.parentNode.replaceChild(newInput, fileInput);

    if (btn){
      var newBtn = btn.cloneNode(true);
      // preserve id and text
      newBtn.id = btn.id || 'btnGetData';
      btn.parentNode.replaceChild(newBtn, btn);
      btn = newBtn;
    }

    // Single source of truth: our handlers only
    btn && btn.addEventListener('click', function(ev){
      ev.preventDefault();
      newInput.value = ""; // reset to allow re-select
      newInput.click();
    });

    newInput.addEventListener('change', function(ev){
      var f = newInput.files && newInput.files[0];
      if (!f) return;
      if (/\.json$/i.test(f.name)){
        var r = new FileReader();
        r.onload = function(){ 
          var m = safeParse(r.result);
          if (!m){ alert("Invalid metrics JSON."); return; }
          applySummary(m);
          const statusEl = document.getElementById('debriefStatus') || document.getElementById('debrief-status');
          if (statusEl){ statusEl.style.display='block'; statusEl.textContent = 'Debrief ready.'; }
        };
        r.readAsText(f);
      } else if (/\.csv$/i.test(f.name)){
        if (!window.Papa){
          alert("CSV parser missing (PapaParse). Please load JSON instead.");
          return;
        }
        Papa.parse(f, {
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          complete: function(results){
            try{
              var rows = results.data || [];
              var fields = results.meta && results.meta.fields || Object.keys(rows[0]||{});
              parseCSVAndSummarize(rows, fields);
            }catch(e){
              console.error("[F1] CSV summarize error:", e);
              alert("Failed to summarize CSV: " + e.message);
            }
          },
          error: function(err){ alert("CSV parse error: " + err); }
        });
      } else {
        alert("Please select a .json or .csv file.");
      }
    });
  });
})();
</script>
<!-- ===== Unified GET DATA Loader â€” END ===== -->
<!-- F1 Live â€” Nonâ€‘destructive JSON wiring (keeps the rest of Dashboard intact) -->
<script>
(function(){
  if (window.__F1_SAFE_WIRE__) return; window.__F1_SAFE_WIRE__=true;

  // Official anchors already in your Dashboard
  const TBODY_SEL  = "#live-table tbody";
  const MINIS_SEL  = "#live-widgets";
  const STATUS_SEL = "#live-status";

  const $ = s=>document.querySelector(s);
  const fmt=(n,d=2)=>Number.isFinite(+n)?(+n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}):'â€”';
  const money=n=>Number.isFinite(+n)?((n<0?'-':'')+'$'+Math.abs(+n).toFixed(2)):'â€”';
  const parseN=x=>{const n=parseFloat(x);return Number.isFinite(n)?n:NaN;};

  // Load TradingView once
  (function ensureTV(){ if (window.TradingView) return; const s=document.createElement('script'); s.src="https://s3.tradingview.com/tv.js"; s.async=true; document.head.appendChild(s); })();
  function normalizeTv(sym){
    if(!sym) return sym;
    try{
      const parts=String(sym).split(':'), ex=(parts[0]||'NASDAQ').toUpperCase(), tk=(parts[1]||parts[0]).toUpperCase().trim();
      if (tk==='SOXL') return 'AMEX:SOXL';
      if (tk==='SPX'||tk==='SPXW') return 'SP:SPX';
      if (tk==='NDX') return 'NASDAQ:NDX';
      if (tk==='RUT') return 'INDEX:RUT';
      if (ex==='NYSEARCA'||ex==='ARCA') return 'AMEX:'+tk;
      return ex+':'+tk;
    }catch(e){ return sym; }
  }
  function addTVMini(container, tvSymbol){
    if (!container || !tvSymbol) return;
    function spawn(){
      if (!window.TradingView || !window.TradingView.widget) return setTimeout(spawn, 250);
      const host=document.createElement('div'); const id='tv_'+Math.random().toString(36).slice(2);
      host.id=id; host.style.width='100%'; host.style.height='150px'; container.appendChild(host);
      try{
        new TradingView.widget({symbol:normalizeTv(tvSymbol), autosize:true, interval:"D", timezone:"Etc/UTC", theme:"dark", style:"2",
                                hide_top_toolbar:true, hide_legend:true, withdateranges:false, range:"12M",
                                enable_publishing:false, container_id:id, toolbar_bg:"rgba(0,0,0,0)"});
      }catch(e){ console.warn("[F1] TV mini failed:", tvSymbol, e); }
    }
    spawn();
  }

  function lastBiz(){ const d=new Date(); d.setDate(d.getDate()-1); while([0,6].includes(d.getDay())) d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

  async function fetchStock(sym, key){
    const u=`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ return NaN; }
    const g=j && (j["Global Quote"]||j.globalQuote||j["global quote"]); if (!g) return NaN;
    const price = g["05. price"]||g.price||g["05. Price"];
    const prev  = g["08. previous close"]||g.previousClose;
    const last  = parseN(price), prevC=parseN(prev);
    return Number.isFinite(last)?last:(Number.isFinite(prevC)?prevC:NaN);
  }
  async function fetchOpt(occ,key,date){
    try{
      const u1=`https://www.alphavantage.co/query?function=OPTION_PRICE&symbol=${encodeURIComponent(occ)}&apikey=${encodeURIComponent(key)}`;
      const r1=await fetch(u1); const t1=await r1.text(); let j1={}; try{ j1=JSON.parse(t1);}catch(e){}
      const cands=[j1.mark, j1.last, (j1.bid&&j1.ask? (Number(j1.bid)+Number(j1.ask))/2 : null)].map(parseN);
      const v=cands.find(Number.isFinite); if (Number.isFinite(v)) return v;
    }catch(e){}
    const root=occ.slice(0,-15);
    const u=`https://www.alphavantage.co/query?function=HISTORICAL_OPTIONS&symbol=${encodeURIComponent(root)&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ return NaN; }
    const hit=((j&&j.data)||[]).find(c=>String(c.contractID).toUpperCase().replace(/\s/g,'')===occ);
    if(!hit) return NaN;
    const seq=[hit.mark,hit.last,(hit.bid&&hit.ask?(Number(hit.bid)+Number(hit.ask))/2:null)].map(parseN);
    const v=seq.find(Number.isFinite); return Number.isFinite(v)?v:NaN;
  }
  function computePL(avg,last,qty,mult){ if(![avg,last,qty,mult].every(Number.isFinite)) return NaN; return (last-avg)*qty*mult; }

  async function renderF1(metrics){
    const tbody=$(TBODY_SEL), minis=$(MINIS_SEL), status=$(STATUS_SEL);
    if (!tbody || !minis) { console.warn("[F1] anchors missing â€” no changes"); return; }
    if (status) status.textContent='Loading open positionsâ€¦';

    const f1=(metrics&&metrics.F1)||{};
    const pos= Array.isArray(f1.openPositions)? f1.openPositions : (metrics.openPositions||[]);
    const tvMap = metrics.tvSymbols || f1.tvSymbols || {};
    const qMap  = metrics.quoteSymbols || f1.quoteSymbols || {};

    // Only clear *inside* the F1 table & minis, never touch other sections
    tbody.innerHTML=''; if (minis) minis.innerHTML='';

    if (!pos.length){ tbody.innerHTML='<tr><td colspan="6">No open positions</td></tr>'; if(status) status.textContent='No open positions in JSON.'; return; }

    const rows=[];
    pos.forEach(p=>{
      const sym=p.symbol||p.underlying||'';
      const type=p.assetType || (p.occId?'option':'stock');
      const qty=Number(p.qty)||0;
      const avg=Number(p.avgPrice);
      const mult=Number(p.multiplier)|| (type==='option'?100:1);
      const tv = p.tvSymbol || tvMap[sym] || '';
      const quote = type==='option' ? (p.occId||'') : (p.quoteSymbol || qMap[sym] || '');

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.symbol}</td>
        <td>${fmt(Number(p.qty), 4)}</td>
        <td>${fmt(+p.avgPrice,2)}</td>
        <td class="last">â€”</td>
        <td class="pl">â€”</td>
        <td class="pct">â€”</td>
      `;
      tbody.appendChild(tr);
      if (tv) addTVMini(minis, tv);
      rows.push({type, quote, tr, avg, qty, mult});
    });

    const key = localStorage.getItem('alphaVantageKey') || localStorage.getItem('av_api_key') || '';
    if (!key){ if(status) status.textContent='Enter/save Alpha Vantage key, then click Refresh Prices.'; return; }
    // Removed date parameter (uses most recent data)

    // De-dupe external calls
    const groups=new Map();
    rows.forEach(r=>{ const k=r.type+':'+r.quote; if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(r); });
    let i=0;
    for (const [k, arr] of groups){
      i++; if(status) status.textContent = `Car ${i}/${groups.size}`;
      const [kind,id]=k.split(':'); if(!id) continue;
      let last=NaN;
      try{ last=(kind==='option')? await fetchOpt(id,key) : await fetchStock(id,key); }catch(e){}
      if (Number.isFinite(last)){
        arr.forEach(w=>{
          const lastTd=w.tr.querySelector('.last'), plTd=w.tr.querySelector('.pl'), pctTd=w.tr.querySelector('.pct');
          if (lastTd) lastTd.textContent = fmt(last,2);
          const pl = computePL(w.avg,last,w.qty,w.mult);
          if (plTd){ plTd.textContent = money(pl); plTd.classList.remove('pos','neg'); plTd.classList.add(pl>=0?'pos':'neg'); }
          if (pctTd){ const pct=(Number.isFinite(w.avg)&&w.avg>0)? ((last/w.avg-1)*100):NaN; pctTd.textContent = Number.isFinite(pct)? pct.toFixed(2)+'%':'â€”'; }
        });
      }
      await new Promise(r=>setTimeout(r, 1200));
    }
    if (status) status.textContent='Completed.';
  }

  // Add a tiny loader button into the F1 status line (optional)
  function addInlineLoader(){
    const status = $(STATUS_SEL); if (!status) return;
    const btn = document.createElement('button');
    btn.textContent = "Load metrics JSON";
    btn.style.marginLeft = "8px"; btn.style.padding = "6px 10px";
    btn.style.borderRadius = "8px"; btn.style.border = "1px solid #2e3b4a";
    btn.style.background = "rgba(255,255,255,0.05)"; btn.style.color = "inherit";
    btn.addEventListener('click', ()=>{
      const pick = document.createElement('input');
      pick.type='file'; pick.accept='.json,application/json'; pick.style.display='none';
      pick.addEventListener('change', ()=>{
        const f = pick.files && pick.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const data = JSON.parse(String(r.result||'').replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null'));
            window.METRICS = data; // triggers render
          }catch(ex){ alert("Invalid metrics JSON: "+ex.message); }
        };
        r.readAsText(f);
      });
      document.body.appendChild(pick); pick.click();
    });
    status.appendChild(btn);
  }

  // Wire up to your Dashboard JSON flow
  window.addEventListener('metrics-json-loaded', e=>{ if (e && e.detail) renderF1(e.detail); });
  try{
    var _m = window.METRICS;
    Object.defineProperty(window, 'METRICS', { configurable:true, get(){ return _m; }, set(v){ _m=v; renderF1(v);} });
    if (_m) renderF1(_m);
  }catch(e){}

  document.addEventListener('DOMContentLoaded', ()=>{
    addInlineLoader();
  });
})();
</script>
<!-- ===== Metrics Bridge: route GET DATA-picked JSON to F1 panel ===== -->
<style>
  /* Hide local Pick JSON in the panel; we rely on the common GET DATA now */
  #f1json #f1_pick { display: none !important; }
</style>
<script>
(function(){
  if (window.__METRICS_BRIDGE__) return; window.__METRICS_BRIDGE__ = true;

  // 1) If GET DATA sets window.METRICS directly, react to it
  try{
    var _m = window.METRICS;
    Object.defineProperty(window,'METRICS',{
      configurable:true,
      get(){ return _m; },
      set(v){
        _m = v;
        try{
          window.dispatchEvent(new CustomEvent('metrics-json-loaded',{ detail: v }));
        }catch(e){}
      }
    });
  }catch(e){}

  // 2) If GET DATA calls applyMetricsAndSummary(metrics), intercept and forward
  if (!window.__APPLY_METRICS_WRAP__){
    window.__APPLY_METRICS_WRAP__ = true;
    const orig = window.applyMetricsAndSummary;
    window.applyMetricsAndSummary = function(m){
      try{ if (typeof orig === 'function') orig(m); } finally {
        try{ window.dispatchEvent(new CustomEvent('metrics-json-loaded',{ detail: m })); }catch(e){}
        try{ window.METRICS = m; }catch(e){}
      }
    };
  }

  // 3) As a fallback, watch for file inputs used by GET DATA and parse JSON automatically
  document.addEventListener('change', function(ev){
    const el = ev.target;
    if (!el || el.tagName !== 'INPUT' || el.type !== 'file') return;
    if (!el.files || !el.files.length) return;
    const f = el.files[0];
    const looksJson = /\.json$/i.test(f.name) || (f.type && f.type.includes('json'));
    if (!looksJson) return;
    const r = new FileReader();
    r.onload = function(){
      try{
        const text = String(r.result || '');
        const metrics = JSON.parse(text.replace(/\b-?Infinity\b/g,'null').replace(/\bNaN\b/g,'null'));
        window.METRICS = metrics; // triggers (1) and dispatches event
      }catch(e){
        console.warn('Metrics Bridge: invalid JSON from picker:', e);
      }
    };
    r.readAsText(f);
  }, true);
})();
</script>
<!-- ===== /Metrics Bridge ===== -->
<!-- ===== Hardcoded Alpha Vantage API key injector ===== -->
<script>
(function(){
  const HARDCODED_KEY = "CSJ0Z7J69M0213II";
  try {
    // Persist for any legacy code paths that read from localStorage
    localStorage.setItem('alphaVantageKey', HARDCODED_KEY);
    localStorage.setItem('av_api_key', HARDCODED_KEY);
  } catch (e) {}

  function applyKey() {
    ['#avKey', '#f1_key', '#f1sp_key'].forEach(sel => {
      const el = document.querySelector(sel);
      if (el) el.value = HARDCODED_KEY;
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyKey);
  } else {
    applyKey();
  }
})();
</script>
<!-- ===== /Hardcoded Alpha Vantage API key injector ===== -->
<!-- ===== F1 Live â€” Table Only (Independent, JSON-fed) ===== -->
<style>
  #f1TableOnly{margin:26px 0 36px}
  #f1TableOnly .hdr{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  #f1TableOnly .hdr h2{margin:0;font-weight:600}
  #f1TableOnly .controls{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 14px}
  #f1TableOnly .controls button{background:#1f2836;border:1px solid #394656;color:inherit;border-radius:8px;padding:8px 12px;cursor:pointer}
  #f1TableOnly .status{opacity:.85}
  #f1TableOnly .wrap{overflow-x:auto}
  #f1TableOnly table{width:100%;border-collapse:collapse;font-size:13.5px}
  #f1TableOnly th,#f1TableOnly td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.2);text-align:right}
  #f1TableOnly th:first-child,#f1TableOnly td:first-child{text-align:left}
  #f1TableOnly th{font-size:12px;letter-spacing:.06em;text-transform:uppercase;opacity:.9}
  #f1TableOnly .pos{color:#22c55e} #f1TableOnly .neg{color:#ef4444}
</style>
<section id="f1TableOnly">
<div class="hdr">
<img class="f1-title-icon" src="Images/F1_front.png" alt="F1 Front" onerror="this.style.display='none'" />
<h2>F1 Live</h2>
<div class="status" id="f1to_status">Waiting for results</div>
</div>
<div class="controls">
<button id="f1to_refresh" type="button">Start</button>
</div>

<div class="mini-pl-row">
  <div class="mini-pl-card">
    <div class="mini-pl-label">Unrealized P/L</div>
    <div id="mini-unrealized-pl" class="mini-pl-value mini-pl-pos">+0.00</div>
  </div>
</div>
<div class="wrap">
<table id="f1to_tbl">
<thead><tr><th>Ticker</th><th>Qty</th><th>Avg</th><th>Last</th><th>P/L</th><th>%</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<script>
(function(){
  function computeUnrealizedPL(){
    try{
      var table = document.getElementById('f1to_tbl');
      var el = document.getElementById('mini-unrealized-pl');
      if(!table || !el) return;
      var headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim().toLowerCase());
      var idx = headers.findIndex(h => h === 'p/l' || h.includes('p/l'));
      var total = 0, found = false;
      table.querySelectorAll('tbody tr').forEach(tr => {
        var td = tr.querySelectorAll('td')[idx];
        if (td){
          var raw = td.textContent.replace(/[$,+\s]/g,'');
          var val = parseFloat(raw);
          if (!isNaN(val)) { total += val; found = true; }
        }
      });
      if(found){
        var sign = total >= 0 ? '+' : '';
        el.textContent = sign + total.toFixed(2);
        el.classList.toggle('mini-pl-pos', total >= 0);
        el.classList.toggle('mini-pl-neg', total < 0);
      }
    }catch(e){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', computeUnrealizedPL);
  } else { computeUnrealizedPL(); }
  var tbody = document.querySelector('#f1to_tbl tbody');
  if (tbody){
    new MutationObserver(computeUnrealizedPL).observe(tbody, {childList:true, subtree:true, characterData:true});
  }
  var btn = document.getElementById('f1to_refresh');
  if (btn){ btn.addEventListener('click', function(){ setTimeout(computeUnrealizedPL, 400); }); }
  window.computeUnrealizedPL = computeUnrealizedPL;
})();
</script>
<script>
(function(){
  if (window.__F1_TABLE_ONLY__) return; window.__F1_TABLE_ONLY__=true;
  const $=s=>document.querySelector(s);
  const tbody=$('#f1to_tbl tbody'), status=$('#f1to_status'), btnRefresh=$('#f1to_refresh');
  const fmt=(n,d=2)=>Number.isFinite(+n)?(+n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}):'â€”';
  const money=n=>Number.isFinite(+n)?((n<0?'-':'')+'$'+Math.abs(+n).toFixed(2)):'â€”';
  const parseN=x=>{const n=parseFloat(x);return Number.isFinite(n)?n:NaN;};
  function lastBiz(){ const d=new Date(); d.setDate(d.getDate()-1); while([0,6].includes(d.getDay())) d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

  let POS=[], LASTS={};

  function renderTable(){
    if (!tbody) return;
    tbody.innerHTML='';
    if (!POS.length){ tbody.innerHTML='<tr><td colspan="6" style="opacity:.8">No open positions.</td></tr>'; return; }
    POS.forEach(p=>{
      const last = LASTS[p._priceKey];
      const avg = Number(p.avgPrice)||0, qty=Number(p.qty)||0, mult=Number(p.multiplier)||1;
      const pl = Number.isFinite(last)? (last-avg)*qty*mult : NaN;
      const pct = (avg>0 && Number.isFinite(last))? ((last/avg)-1)*100 : NaN;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.symbol}</td>
        <td>${fmt(qty,4)}</td>
        <td>${fmt(avg,2)}</td>
        <td class="last">${fmt(last,2)}</td>
        <td class="pl ${Number(pl)>=0?'pos':'neg'}">${Number.isFinite(pl)?money(pl):'â€”'}</td>
        <td class="${Number(pct)>=0?'pos':'neg'}">${Number.isFinite(pct)?pct.toFixed(2)+'%':'â€”'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function fetchStock(sym, key){
    const u=`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ return NaN; }
    const g=j && (j["Global Quote"]||j.globalQuote||j["global quote"]);
    const price=parseN(g&& (g["05. price"]||g.price||g["05. Price"]));
    const prev =parseN(g&& (g["08. previous close"]||g.previousClose));
    return Number.isFinite(price)?price:(Number.isFinite(prev)?prev:NaN);
  }
  async function fetchOpt(occ,key,date){
    try{
      const u1=`https://www.alphavantage.co/query?function=OPTION_PRICE&symbol=${encodeURIComponent(occ)}&apikey=${encodeURIComponent(key)}`;
      const r1=await fetch(u1); const t1=await r1.text(); let j1={}; try{ j1=JSON.parse(t1);}catch(e){}
      const v=[j1.mark,j1.last,(j1.bid&&j1.ask?(+j1.bid+ +j1.ask)/2:null)].map(parseN).find(Number.isFinite);
      if(Number.isFinite(v)) return v;
    }catch(e){}
    const root=occ.slice(0,-15);
    const u=`https://www.alphavantage.co/query?function=HISTORICAL_OPTIONS&symbol=${encodeURIComponent(root)}&date=${lastBiz()}&apikey=${encodeURIComponent(key)}`;
    const r=await fetch(u); const t=await r.text(); let j={}; try{ j=JSON.parse(t);}catch(e){ return NaN; }
    const hit=((j&&j.data)||[]).find(c=>String(c.contractID).toUpperCase().replace(/\s/g,'')===occ);
    if(!hit) return NaN;
    const seq=[hit.mark,hit.last,(hit.bid&&hit.ask?(+hit.bid+ +hit.ask)/2:null)].map(parseN);
    return seq.find(Number.isFinite);
  }

  async function refresh(){
    const key = (localStorage.getItem('alphaVantageKey')||localStorage.getItem('av_api_key')||'').trim();
    if (!key){ if(status) status.textContent='Enter API key first.'; return; }
    if (status) status.textContent='Result';
 
    // De-dupe
    const groups=new Map();
    POS.forEach(p=>{ const k=p.assetType+':'+(p.assetType==='option'?p.occId:p.quoteSymbol); if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(p); });
    let i=0;
    for (const [k, arr] of groups){
      i++; if(status) status.textContent=`Result ${i}/${groups.size}`;
      const [kind,id]=k.split(':'); if(!id) continue;
      let last = (kind==='option')? await fetchOpt(id,key) : await fetchStock(id,key);
      arr.forEach(p=>{ LASTS[p._priceKey]=last; });
      renderTable();
      await new Promise(res=>setTimeout(res, 1100));
    }
    if (status) status.textContent='Completed.';
  }

  function applyJSON(m){
    const src = (m&&m.F1&&Array.isArray(m.F1.openPositions)) ? m.F1.openPositions : (m&&m.openPositions||[]);
    POS = src.map(x=>({
      symbol: x.symbol,
      assetType: x.assetType || (x.occId?'option':'stock'),
      qty: +x.qty, avgPrice:+x.avgPrice, multiplier:+(x.multiplier||1),
      quoteSymbol: x.quoteSymbol, underlyingTicker: x.underlyingTicker, occId: x.occId,
      _priceKey: (x.assetType==='option') ? (x.occId||x.symbol) : (x.quoteSymbol||x.symbol)
    }));
    if (status) status.textContent = `No. of cars: ${POS.length}`;
    LASTS = {}; // reset
    renderTable();
  }

  // Wire up
  if (btnRefresh) btnRefresh.addEventListener('click', refresh);
  window.addEventListener('metrics-json-loaded', e=>{ if (e && e.detail) applyJSON(e.detail); });
  try{
    var _m = window.METRICS;
    Object.defineProperty(window,'METRICS',{configurable:true,get(){return _m;},set(v){_m=v; applyJSON(v);}});
    if (_m) applyJSON(_m);
  }catch(e){}

  // initial
  renderTable();
})();
</script>
<!-- ===== /F1 Live â€” Table Only ===== -->
<!-- Mount the F1 Table Only panel under #telemetry-page and ensure singleton -->
<script>
(function(){
  if (window.__F1_TABLE_MOUNTED__) return; window.__F1_TABLE_MOUNTED__=true;
  function mount(){
    var pane = document.querySelector('#telemetry-page');
    var panel = document.querySelector('#f1TableOnly');
    if (!panel) return;
    // Remove any duplicates
    document.querySelectorAll('#f1TableOnly').forEach((n,i)=>{ if (i>0 && n.parentNode) n.parentNode.removeChild(n); });
    if (pane){
      // If panel not already a child of telemetry-page, move it there
      if (panel.parentNode !== pane){
        panel.parentNode && panel.parentNode.removeChild(panel);
        pane.appendChild(panel);
      }
    }
    // As a safety, remove any accidental clones in #podium-page
    var podium = document.querySelector('#podium-page');
    if (podium){
      podium.querySelectorAll('#f1TableOnly').forEach(n=>{ n.parentNode && n.parentNode.removeChild(n); });
    }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', mount);
  else mount();
})();
</script>
<style>
/* Override: make panel 95% of page width */
#f1TableOnly{
  width: 95% !important;
  margin-left: auto !important;
  margin-right: auto !important;
}
</style>
<!-- ===== F1 Live â€” Mini Charts (TradingView Mini Symbol Overview) ===== -->
<style>
  #f1Minis{ width:95%; margin: 10px auto 40px; }
  #f1Minis .hdr{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
  #f1Minis .hdr h3{margin:0;font-weight:600}
  #f1Minis .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  #f1Minis .mini.tradingview-widget-container{height:170px;border:1px solid rgba(255,255,255,.18);border-radius:12px;overflow:hidden;padding:4px;background:rgba(255,255,255,.02)}
  #f1Minis .tradingview-widget-container__widget{height:100%!important}
</style>
<section id="f1Minis">
<div class="hdr"><h3>F1 Live Charts</h3><div id="f1Minis_status" style="opacity:.8;margin-left:8px"></div></div>
<div class="grid" id="f1Minis_grid"></div>
</section>
<script>
(function(){
  if (window.__F1_MINIS_EMBED__) return; window.__F1_MINIS_EMBED__=true;
  const gridId = "f1Minis_grid";
  const statusId = "f1Minis_status";
  function $(s){ return document.querySelector(s); }
  function status(t){ var el=$('#'+statusId); if (el) el.textContent=t||''; }
  function toTVSymbol(raw){
    if (!raw) return '';
    if (String(raw).includes(':')) return raw;
    const MAP = { PLTR:'BATS:PLTR', DECK:'NYSE:DECK', TSLA:'NASDAQ:TSLA', META:'NASDAQ:META', BIDU:'NASDAQ:BIDU', TQQQ:'NASDAQ:TQQQ', SQQQ:'NASDAQ:SQQQ', AAPL:'NASDAQ:AAPL', SOXL:'AMEX:SOXL', V:'NYSE:V', MSFT:'NASDAQ:MSFT', SPX:'SP:SPX', SPXW:'SP:SPX', NDX:'NASDAQ:NDX', RUT:'INDEX:RUT' };
    const t = String(raw).toUpperCase().trim();
    return MAP[t] || `NASDAQ:${t}`;
  }
  function addMini(container, tvSymbol){
    if (!container || !tvSymbol) return;
    // Create container block
    const wrap = document.createElement('div');
    wrap.className = 'mini tradingview-widget-container';
    const widget = document.createElement('div');
    widget.className = 'tradingview-widget-container__widget';
    wrap.appendChild(widget);
    const copy = document.createElement('div');
    copy.className = 'tradingview-widget-copyright';
    const clean = String(tvSymbol).split(':').pop();
    copy.innerHTML = '<a href="https://www.tradingview.com/symbols/'+encodeURIComponent(clean)+'/\" rel="noopener nofollow" target="_blank"><span class="blue-text">'+clean+' stock price</span></a><span class="trademark"> by TradingView</span>';
    wrap.appendChild(copy);
    container.appendChild(wrap);
    // Embed config script
    const s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
    s.text = JSON.stringify({
      symbol: tvSymbol,
      chartOnly: false,
      dateRange: "12M",
      trendLineColor: "rgba(0, 188, 212, 1)",
      noTimeScale: true,
      colorTheme: "dark",
      isTransparent: true,
      locale: "en",
      width: "100%",
      autosize: false,
      height: "100%"
    });
    wrap.appendChild(s);
  }
  function renderMinis(metrics){
    const grid = document.getElementById(gridId);
    if (!grid) return;
    grid.innerHTML='';
    const pos = (metrics && metrics.F1 && Array.isArray(metrics.F1.openPositions)) ? metrics.F1.openPositions : (metrics && metrics.openPositions || []);
    if (!pos.length){ status('No open positions in JSON.'); return; }
    status('Rendering '+pos.length+' minisâ€¦');
    pos.forEach(row=>{
      const tv = row.tvSymbol || toTVSymbol(row.underlyingTicker || row.quoteSymbol || '');
      if (tv) addMini(grid, tv);
    });
    status('');
  }
  // Listen to the same GET DATA flow
  window.addEventListener('metrics-json-loaded', e=>{ if (e && e.detail) renderMinis(e.detail); });
  try{
    var _m = window.METRICS;
    Object.defineProperty(window,'METRICS',{configurable:true,get(){return _m;},set(v){_m=v; renderMinis(v);}});
    if (_m) renderMinis(_m);
  }catch(e){}
})();
</script>
<!-- ===== /F1 Live â€” Mini Charts ===== -->
<!-- Scope F1 Mini Charts to Telemetry only + singleton guard -->
<script>
(function(){
  if (window.__F1_MINIS_TELEMETRY_ONLY__) return;
  window.__F1_MINIS_TELEMETRY_ONLY__ = true;

  function mountMinisOnce(){
    try{
      // Remove duplicates anywhere except the first
      var all = document.querySelectorAll('#f1Minis');
      if (all.length > 1){
        for (var i=1;i<all.length;i++){ all[i].parentNode && all[i].parentNode.removeChild(all[i]); }
      }
      var minis = document.querySelector('#f1Minis');
      if (!minis) return;

      // Ensure minis lives under Telemetry only
      var telemetry = document.querySelector('#telemetry-page');
      if (telemetry && minis.parentNode !== telemetry){
        minis.parentNode && minis.parentNode.removeChild(minis);
        telemetry.appendChild(minis);
      }

      // Remove any stray minis under Podium
      var podium = document.querySelector('#podium-page');
      if (podium){
        podium.querySelectorAll('#f1Minis').forEach(function(n){
          if (n !== minis) n.parentNode && n.parentNode.removeChild(n);
        });
      }
    }catch(e){ console.warn('Mini scope fix:', e); }
  }

  // Run on DOM ready and after metrics load (in case panel is injected late)
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', mountMinisOnce);
  } else {
    mountMinisOnce();
  }
  window.addEventListener('metrics-json-loaded', mountMinisOnce);
})();
</script>
<footer class="footer-info">F1 Theme Portfolio Dashboard - Real-time trading analytics with professional-grade performance metrics</footer>
<script id="fixed-header-offset">
(function(){
  function applyHeaderOffset(){
    var header = document.querySelector('.dashboard-header');
    if(!header) return;
    var h = header.getBoundingClientRect().height;
    // Apply padding to body to prevent content overlap with fixed header
    document.body.style.paddingTop = h + 'px';
  }
  // Run on DOM ready and on resize (and on font load)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyHeaderOffset);
  } else {
    applyHeaderOffset();
  }
  window.addEventListener('resize', applyHeaderOffset);
  // If Google Fonts affect height after load, adjust again
  window.addEventListener('load', applyHeaderOffset);
})();
</script>


<!-- Telemetry: hard gate until metrics are updated -->
<script>
(function(){
  // Placeholder ASAP
  try {
    var titleEl = document.querySelector('.telemetry-title');
    var msgEl   = document.getElementById('telemetry-live-message');
    if (titleEl) titleEl.textContent = 'Telemetry Alert';
    if (msgEl)   msgEl.textContent   = 'No live feed…';
  } catch(e){}

  // Gate flag
  window.__telemetryReady = false;

  // Keep references if functions exist
  var _origProcess = null;
  var _origPlay    = null;

  function ensureProxies(){
    if (!_origProcess && typeof window.processTelemetryQueue === 'function'){
      _origProcess = window.processTelemetryQueue;
      window.processTelemetryQueue = function(){
        if (!window.__telemetryReady) { return; }
        return _origProcess.apply(this, arguments);
      };
    }
    if (!_origPlay && typeof window.playTelemetryAudioOnce === 'function'){
      _origPlay = window.playTelemetryAudioOnce;
      window.playTelemetryAudioOnce = function(){
        if (!window.__telemetryReady) { return; }
        return _origPlay.apply(this, arguments);
      };
    }
  }

  // Try now and keep checking for late-bound functions
  ensureProxies();
  var proxyTimer = setInterval(function(){
    ensureProxies();
    // Stop checking after 20s
    if ((window.__telemetryReady === true) || (typeof document === 'object' && document.visibilityState === 'hidden')) {
      clearInterval(proxyTimer);
    }
  }, 500);

  function num(v){
    if (v === null || v === undefined) return null;
    var n = parseFloat(String(v).replace(/[, ]+/g,''));
    return isNaN(n) ? null : n;
  }

  function attachWrapper(){
    if (!window.updateDashboardMetrics || window.__telemetryWrapped__) return;
    window.__telemetryWrapped__ = true;
    var __origUpdate = window.updateDashboardMetrics;

    window.updateDashboardMetrics = function(metricsForDashboard){
      var result = __origUpdate.apply(this, arguments);
      try {
        // Only now mark telemetry as ready
        window.__telemetryReady = true;

        // Clear any pre-existing intervals/queues set by earlier scripts
        try {
          if (window.telemetryInterval) { clearInterval(window.telemetryInterval); window.telemetryInterval = null; }
        } catch(e){}
        window.telemetryQueue = [];

        // Build queue by conditions
        var m = metricsForDashboard || (window.latestMetrics || {});
        var q = [];
        var cagr = num(m.CAGR);
        var mdd  = num(m.MaxDrawdown);
        var shrp = num(m.Sharpe);
        var drs  = (m.DRS != null ? num(m.DRS) : (m.ProfitFactor != null ? num(m.ProfitFactor) : null));

        if (cagr != null && cagr < 0.12) {
          q.push({ title: 'CAGR ALERT!', message: 'We’re seeing slower pace in your CAGR, keep pushing!', audioId: 'cagr-audio' });
        }
        if (shrp != null && shrp < 1.0) {
          q.push({ title: 'SHARPE RATIO ALERT!', message: 'On this sector, your throttle application is inconsistent. Try a smoother approach to carry more momentum.', audioId: 'sharpe-audio' });
        }
        if (drs != null && drs < 1) {
          q.push({ title: 'DRS ALERT!', message: 'DRS enabled. Gap is eight tenths. You should see the speed differential in a moment.', audioId: 'pf-audio' });
        }
        if (mdd != null && mdd > 0.30) {
          q.push({ title: 'MAX DRAWDOWN ALERT!', message: 'We have a slight issue for the front-left wheel nut. Need to be careful with it, driver.', audioId: 'mdd-audio' });
        }

        if (q.length > 0){
          window.telemetryQueue = q;
          // Now proxies will allow through
          if (typeof window.processTelemetryQueue === 'function') window.processTelemetryQueue();
          if (typeof window.playTelemetryAudioOnce === 'function') window.playTelemetryAudioOnce(q);
        } else {
          // Keep placeholder if no alerts
          var titleEl = document.querySelector('.telemetry-title');
          var msgEl   = document.getElementById('telemetry-live-message');
          if (titleEl) titleEl.textContent = '—';
          if (msgEl)   msgEl.textContent   = '—';
        }
      } catch(e){
        console.warn('Telemetry hard gate wiring failed', e);
      }
      return result;
    };
  }

  // Attach wrapper now or when available
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachWrapper);
  } else { attachWrapper(); }

  var tries = 0;
  var waitUpd = setInterval(function(){
    if (window.updateDashboardMetrics){
      clearInterval(waitUpd);
      attachWrapper();
    }
    if (++tries > 40) clearInterval(waitUpd);
  }, 500);
})();
</script>
<!-- UNIVERSAL_CAR_OR_STRATEGY_OVERLAY_START -->
<script>
(function(){
  const CAR_IMG_BASES = ['Images/', 'file:///C:/Temp/Dashboard/Images/'];
  const CAR_IMG_MAP = {
    'Bear Call Spread': 'Bear Call Spread.png',
    'Bull Put Spread': 'Bull Put Spread.png',
    'Iron Condor': 'Iron Condor.png',
    'Long Call': 'Long Call.png',
    'Short Call': 'Short Call.png',
    'Short Put': 'Short Put.png',
    'Short Strangle': 'Short Strangle.png',
    'Long Combo': 'Long Combo.png',
    'Momentum Investing': 'Momentum Investing.png',
    'Assignment': 'Assignment.png'
  };

  function textOf(el){ return (el && (el.textContent||'') || '').replace(/\s+/g,' ').trim(); }
  function cleanName(s){
    if (!s) return '';
    s = s.replace(/\u2026/g,'');            // remove ellipsis char
    s = s.split('—')[0].split(' - ')[0];    // strip suffix after em-dash/hyphen
    return s.trim();
  }
  function findColIndex(table){
    const hdr = table.querySelector('.table-header');
    if (!hdr) return -1;
    const cells = Array.from(hdr.children).map(textOf);
    let i = cells.findIndex(v => /^car$/i.test(v));
    if (i >= 0) return i;
    // Strategy uploads often label this column "STRATEGY" (or "CAR/STRATEGY", "DRIVER/TEAM")
    i = cells.findIndex(v => /^(strategy|car\/?strategy|driver\/?team)$/i.test(v));
    return i;
  }
  function applyOverlay(cell, name){
    if (!name || cell.__carApplied) return;

    const wrap = document.createElement('span');
    wrap.className = 'car-cell';
    wrap.style.position = 'relative';

    const img = document.createElement('img');
    img.className = 'car-img';
    img.alt = name;
    img.style.display = 'block';
    img.style.width = '220px';
    img.style.height = 'auto';
    img.style.objectFit = 'contain';
    img.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,.35))';

    const label = document.createElement('span');
    label.className = 'car-name';
    label.textContent = name;
    // One-line & 16px downward
    label.style.whiteSpace = 'nowrap';
    label.style.overflow = 'hidden';
    label.style.textOverflow = 'ellipsis';
    label.style.position = 'absolute';
    label.style.left = '50%';
    label.style.bottom = '0';
    label.style.transform = 'translate(-50%, 16px)';
    label.style.padding = '4px 8px';
    label.style.color = '#fff';
    label.style.fontSize = '14px';
    label.style.lineHeight = '1.15';
    label.style.textAlign = 'center';
    label.style.pointerEvents = 'none';
    label.style.textShadow = '0 1px 2px rgba(0,0,0,.65)';
    label.style.maxWidth = '96%';
    label.style.borderRadius = '8px';
    label.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.20), rgba(0,0,0,0.65))';

    const file = CAR_IMG_MAP[name];
    if (file){
      let baseIdx = 0;
      const tryNext = () => {
        if (baseIdx >= CAR_IMG_BASES.length){ img.style.display = 'none'; return; }
        img.src = CAR_IMG_BASES[baseIdx++] + file;
      };
      img.onerror = tryNext;
      tryNext();
    } else {
      img.style.display = 'none';
    }

    while (cell.firstChild) cell.removeChild(cell.firstChild);
    wrap.appendChild(img);
    wrap.appendChild(label);
    cell.appendChild(wrap);
    cell.__carApplied = true;
  }

  function rebuild(){
    const table = document.getElementById('standings-table');
    if (!table) return;
    const idx = findColIndex(table);
    if (idx < 0) return;

    table.querySelectorAll('.table-row').forEach(row => {
      const cells = Array.from(row.children);
      const cell = cells[idx];
      if (!cell) return;
      const raw = textOf(cell);
      const name = cleanName(raw);
      applyOverlay(cell, name);
    });
  }

  function boot(){ rebuild(); setTimeout(rebuild, 200); setTimeout(rebuild, 600); }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  new MutationObserver(rebuild).observe(document.body, { childList:true, subtree:true });
})();
</script>
<!-- UNIVERSAL_CAR_OR_STRATEGY_OVERLAY_END -->

</body>
</html>
<script>
// Override robustParseJson to handle files starting with HTML comments.
(function(){
  window.robustParseJson = function(text){
    var t = (text || "").trim();
    // Strip BOM
    if (t.charCodeAt(0) === 0xFEFF) t = t.slice(1);
    // Strip HTML comments <!-- ... -->
    t = t.replace(/<!--[\s\S]*?-->/g, "");
    // Strip /* */ block comments
    t = t.replace(/\/\*[\s\S]*?\*\//g, "");
    // Strip // line comments
    t = t.split(/\r?\n/).map(function(line){ return line.replace(/^\s*\/\/.*$/, ""); }).join("\n");
    // After stripping comments, if it still looks like HTML, bail
    var trimmed = t.trim();
    if (trimmed.startsWith("<")) {
      throw new Error("The selected file still looks like HTML after removing comments. Please choose a JSON file.");
    }
    return JSON.parse(trimmed);
  };
})();
</script>
